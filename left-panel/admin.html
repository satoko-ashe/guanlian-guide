<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†æƒé™ Â· å‘˜å·¥ç®¡ç† & æ™ºèƒ½æ’ç­ï¼ˆå¢å¼ºç‰ˆï¼‰</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/pouchdb@8.0.1/dist/pouchdb.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.2/package/dist/xlsx.full.min.js"></script>
    <style>
        /* åŸæœ‰æ ·å¼ä¿æŒä¸å˜ */
        .table-scroll {
            overflow-x: auto;
            overflow-y: hidden;
            border: 1px solid #e2e8f0;
            border-radius: 0.375rem;
            margin-bottom: 0.5rem;
        }
        .table-scroll table {
            border-collapse: collapse;
            width: max-content;
            min-width: 100%;
        }
        .table-scroll thead {
            position: sticky;
            top: 0;
            background: #f7fafc;
            z-index: 10;
            box-shadow: 0 1px 2px 0 rgba(0,0,0,0.05);
        }
        .table-scroll th, .table-scroll td {
            border: 1px solid #cbd5e0;
            padding: 0.5rem;
            font-size: 0.75rem;
            white-space: nowrap;
        }
        .table-scroll th {
            text-align: center;
            font-weight: 600;
            background-color: #edf2f7;
        }
        .table-scroll td {
            text-align: left;
            max-width: 250px;
            overflow: hidden;
            text-overflow: ellipsis;
            height: 35px;
            line-height: 35px;
            padding-top: 0;
            padding-bottom: 0;
        }
        .schedule-cell {
            padding: 0 !important;
        }
        .schedule-select {
            width: 100%;
            height: 100%;
            border: none;
            background: transparent;
            font-size: 0.7rem;
            padding: 0 4px;
            cursor: pointer;
            border-radius: 0;
        }
        .schedule-select option {
            background: white;
            color: black;
        }
        .schedule-select.rest {
            background-color: #fee2e2;
            color: #b91c1c;
            font-weight: 500;
        }
        .schedule-select.off {
            background-color: #ffedd5;
            color: #9a3412;
            font-weight: 500;
        }
        .schedule-select.a {
            background-color: #dcfce7;
            color: #166534;
        }
        .schedule-select.b {
            background-color: #cffafe;
            color: #0e7490;
        }
        .schedule-select.c {
            background-color: #e0e7ff;
            color: #3730a3;
        }
        .schedule-select.d {
            background-color: #f3e8ff;
            color: #6b21a8;
        }
        .warning-pink {
            background-color: #fce4e4 !important;
        }
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }
        .modal-content {
            background: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            width: 90%;
            max-width: 900px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .pagination {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            justify-content: flex-end;
            margin-top: 0.5rem;
            font-size: 0.8rem;
        }
        .pagination button {
            padding: 0.2rem 0.8rem;
            border: 1px solid #ccc;
            background: white;
            border-radius: 0.25rem;
            cursor: pointer;
        }
        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .pagination input {
            width: 50px;
            text-align: center;
            border: 1px solid #ccc;
            border-radius: 0.25rem;
        }
        .rule-panel {
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
            transition: all 0.3s;
        }
        .rule-panel.collapsed {
            display: none;
        }
        .stat-item {
            display: inline-block;
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 9999px;
            padding: 0.25rem 0.75rem;
            font-size: 0.7rem;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .arrow-icon {
            cursor: pointer;
            margin-left: 0.5rem;
            transition: transform 0.2s;
        }
        .arrow-icon.rotated {
            transform: rotate(90deg);
        }
    </style>
</head>
<body class="bg-gray-50 font-sans p-4">

<!-- å³ä¸Šè§’å¯¼èˆª (ä¸è¿è¥å¤§è¡¨ä¿æŒä¸€è‡´) -->
<div class="max-w-7xl mx-auto mb-2 flex justify-end space-x-3 text-sm">
    <a href="autoNote.html" target="_blank" class="bg-white px-3 py-1 rounded shadow hover:bg-gray-100"><i class="fas fa-pen-fancy mr-1"></i>è‡ªåŠ¨è®°å•</a>
    <a href="masterTable.html" target="_blank" class="bg-white px-3 py-1 rounded shadow hover:bg-gray-100"><i class="fas fa-table mr-1"></i>è¿è¥ç™»è®°å¤§è¡¨</a>
    <a href="admin.html" target="_blank" class="bg-white px-3 py-1 rounded shadow hover:bg-gray-100"><i class="fas fa-lock mr-1"></i>ç®¡ç†æƒé™</a>
</div>

<!-- ç™»å½•çŠ¶æ€æ¡ + åŠŸèƒ½æ  (åˆå¹¶ï¼Œç±»ä¼¼è¿è¥å¤§è¡¨) -->
<div class="max-w-7xl mx-auto mb-4 flex flex-wrap items-center justify-between gap-2 bg-white p-2 rounded shadow">
    <div class="flex items-center space-x-2 text-sm">
        <span class="text-gray-600"><i class="fas fa-database mr-1 text-blue-500"></i>æœ¬åœ°PouchDB Â· å‘˜å·¥æ’ç­ç³»ç»Ÿ (ä¸CouchDBå®æ—¶åŒæ­¥)</span>
        <span id="userDisplay" class="hidden ml-2">ğŸ‘¤ <span id="currentUserName"></span></span>
    </div>
    <div class="flex flex-wrap items-center gap-2">
        <button id="fullscreenBtn" class="bg-gray-100 hover:bg-gray-200 px-2 py-1 rounded text-sm"><i class="fas fa-expand mr-1"></i>å…¨å±</button>
        <button id="exportCurrentBtn" class="bg-green-100 hover:bg-green-200 px-2 py-1 rounded text-sm"><i class="fas fa-download mr-1"></i>å¯¼å‡ºå½“å‰è§†å›¾</button>
        <button id="exportAllBtn" class="bg-purple-100 hover:bg-purple-200 px-2 py-1 rounded text-sm"><i class="fas fa-file-excel mr-1"></i>å¯¼å‡ºå…¨éƒ¨</button>
        <button id="importBtn" class="bg-blue-100 hover:bg-blue-200 px-2 py-1 rounded text-sm"><i class="fas fa-upload mr-1"></i>å¯¼å…¥</button>
        <button id="showLoginBtn" class="bg-blue-500 text-white px-3 py-1 rounded text-sm"><i class="fas fa-sign-in-alt mr-1"></i>ç™»å½•</button>
        <button id="logoutBtn" class="bg-gray-300 px-3 py-1 rounded text-sm hidden">é€€å‡º</button>
    </div>
</div>

<!-- ä¸»å†…å®¹ï¼šé€‰é¡¹å¡ -->
<div class="max-w-7xl mx-auto bg-white p-4 rounded shadow">
    <div class="flex flex-wrap border-b text-sm gap-1">
        <button class="tab-btn px-4 py-2 font-medium text-blue-600 border-b-2 border-blue-500" data-tab="employee">ğŸ‘¥ å‘˜å·¥ç®¡ç†è¡¨</button>
        <button class="tab-btn px-4 py-2 font-medium" data-tab="schedule">ğŸ“… å‘˜å·¥æ’ç­è¡¨</button>
    </div>

    <!-- å‘˜å·¥è¡¨ -->
    <div id="tab-employee" class="tab-content block mt-2">
        <div class="flex justify-between mb-1">
            <span class="text-xs text-gray-500">å…± <span id="employeeCount">0</span> è¡Œ</span>
            <button id="addEmployeeBtn" class="bg-indigo-50 text-indigo-700 px-3 py-0.5 rounded text-xs"><i class="fas fa-plus mr-1"></i>æ–°å¢å‘˜å·¥</button>
        </div>
        <div id="employeeTableContainer" class="table-scroll"></div>
    </div>

    <!-- æ’ç­è¡¨ -->
    <div id="tab-schedule" class="tab-content hidden mt-2">
        <!-- æœˆä»½é€‰æ‹© & æ“ä½œæ  -->
        <div class="flex flex-wrap items-center gap-4 mb-3">
            <div class="flex items-center gap-2">
                <label class="text-sm font-medium">é€‰æ‹©æœˆä»½ï¼š</label>
                <input type="month" id="monthPicker" class="border rounded px-2 py-1 text-sm" value="">
            </div>
            <button id="saveScheduleBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm"><i class="fas fa-save mr-1"></i>ä¿å­˜æœ¬æœˆæ’ç­</button>
            <button id="refreshScheduleBtn" class="bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded text-sm"><i class="fas fa-sync-alt mr-1"></i>åˆ·æ–°</button>
            <span id="scheduleMode" class="text-xs bg-gray-100 px-2 py-1 rounded flex items-center">
                <span id="modeText"></span>
                <i class="fas fa-chevron-right arrow-icon ml-1" id="toggleRulePanel" title="å±•å¼€/æ”¶èµ·è§„åˆ™"></i>
            </span>
        </div>

        <!-- è§„åˆ™é…ç½®é¢æ¿ï¼ˆå¯æŠ˜å ï¼‰ -->
        <div id="rulePanel" class="rule-panel">
            <div class="flex items-center justify-between mb-2">
                <span class="font-semibold text-sm"><i class="fas fa-sliders-h mr-1"></i>æ’ç­è§„åˆ™é…ç½®ï¼ˆæœ¬æœˆï¼‰</span>
                <button id="saveRulesBtn" class="bg-green-600 hover:bg-green-700 text-white px-3 py-0.5 rounded text-xs">ä¿å­˜è§„åˆ™</button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 text-xs">
                <!-- ç‰¹æ®Šè§„åˆ™ -->
                <div>
                    <label class="block font-medium">å…¨ä½“å›ºå®šä¼‘æ¯æ—¥æ˜ŸæœŸ</label>
                    <div class="flex gap-2 flex-wrap">
                        <label><input type="checkbox" class="fixed-weekday" value="0"> å‘¨æ—¥</label>
                        <label><input type="checkbox" class="fixed-weekday" value="1"> å‘¨ä¸€</label>
                        <label><input type="checkbox" class="fixed-weekday" value="2"> å‘¨äºŒ</label>
                        <label><input type="checkbox" class="fixed-weekday" value="3"> å‘¨ä¸‰</label>
                        <label><input type="checkbox" class="fixed-weekday" value="4"> å‘¨å››</label>
                        <label><input type="checkbox" class="fixed-weekday" value="5"> å‘¨äº”</label>
                        <label><input type="checkbox" class="fixed-weekday" value="6"> å‘¨å…­</label>
                    </div>
                </div>
                <div>
                    <label class="block font-medium">å…¨ä½“å›ºå®šæ”¾å‡æ—¥æœŸ (å¦‚ 01,15)</label>
                    <input type="text" id="fixedDates" class="w-full border p-1 rounded" placeholder="ç”¨é€—å·åˆ†éš”ï¼Œå¦‚ 01,15">
                </div>
                <div>
                    <label class="block font-medium">æœ¬æœˆä¼‘æ¯å¤©æ•°</label>
                    <input type="number" id="restDaysPerMonth" class="w-full border p-1 rounded" value="8" min="0">
                </div>
                <div>
                    <label class="block font-medium">å‘¨å…­æ—¥ä¼‘æ¯äººæ•°ä¸Šé™</label>
                    <input type="number" id="weekendRestLimit" class="w-full border p-1 rounded" value="3" min="0">
                </div>
                <div>
                    <label class="block font-medium">å¹³æ—¶æ—¥ä¼‘æ¯äººæ•°ä¸Šé™</label>
                    <input type="number" id="weekdayRestLimit" class="w-full border p-1 rounded" value="2" min="0">
                </div>
                <div>
                    <label class="block font-medium">æ¯å¤©æœ€å°‘æ™šç­äººæ•° (B+D)</label>
                    <input type="number" id="minEvening" class="w-full border p-1 rounded" value="0" min="0">
                </div>
                <div>
                    <label class="block font-medium">æ— éœ€æ™šç­çš„æ—¥æœŸ (å¦‚ 03,28)</label>
                    <input type="text" id="noEveningDates" class="w-full border p-1 rounded" placeholder="é€—å·åˆ†éš”">
                </div>
            </div>
            <!-- ç­æ¬¡å®šä¹‰ï¼ˆå…¨å±€ä¿å­˜ï¼‰ -->
            <div class="mt-3 pt-2 border-t border-gray-200">
                <div class="flex items-center justify-between mb-2">
                    <span class="font-semibold text-sm"><i class="fas fa-clock mr-1"></i>ç­æ¬¡æ—¶é—´ï¼ˆå…¨å±€è®¾ç½®ï¼‰</span>
                    <button id="saveShiftsBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-0.5 rounded text-xs">ä¿å­˜ç­æ¬¡æ—¶é—´</button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3 text-xs">
                    <div><label class="block font-medium">Aç­</label><input type="text" id="shiftA" class="w-full border p-1 rounded" value="9:00-18:00"></div>
                    <div><label class="block font-medium">Bç­</label><input type="text" id="shiftB" class="w-full border p-1 rounded" value="11:00-20:00"></div>
                    <div><label class="block font-medium">Cç­</label><input type="text" id="shiftC" class="w-full border p-1 rounded" value="10:00-19:00"></div>
                    <div><label class="block font-medium">Dç­</label><input type="text" id="shiftD" class="w-full border p-1 rounded" value="13:00-22:00"></div>
                </div>
            </div>
        </div>

        <!-- æ’ç­è¡¨æ ¼å®¹å™¨ -->
        <div id="scheduleTableContainer" class="table-scroll">
            <!-- åŠ¨æ€ç”Ÿæˆ -->
        </div>

        <!-- å‘˜å·¥ç»Ÿè®¡åŒºåŸŸ -->
        <div id="scheduleStats" class="mt-3 text-xs bg-gray-50 p-2 rounded border">
            <!-- åŠ¨æ€æ˜¾ç¤ºç»Ÿè®¡ -->
        </div>
    </div>
</div>

<!-- ç™»å½•æ¨¡æ€æ¡† -->
<div id="loginModal" class="modal hidden">
    <div class="modal-content max-w-md">
        <h3 class="text-lg font-bold mb-4">ç™»å½• (å‘˜å·¥è¡¨ï¼Œéœ€å¯ç”¨è´¦å·)</h3>
        <input id="loginUser" type="text" placeholder="è´¦å·" class="w-full border p-2 mb-2 rounded" value="è¿è¥é•¿">
        <input id="loginPass" type="password" placeholder="å¯†ç " class="w-full border p-2 mb-4 rounded" value="2026">
        <div class="flex justify-end space-x-2">
            <button id="closeLoginModal" class="px-4 py-2 bg-gray-300 rounded">å–æ¶ˆ</button>
            <button id="loginBtn" class="px-4 py-2 bg-blue-600 text-white rounded">ç™»å½•</button>
        </div>
    </div>
</div>

<!-- ç¼–è¾‘å‘˜å·¥å¼¹çª— -->
<div id="editModal" class="modal hidden">
    <div class="modal-content">
        <h3 class="text-lg font-bold mb-4" id="modalTitle">ç¼–è¾‘å‘˜å·¥ä¿¡æ¯</h3>
        <div id="modalFields" class="grid grid-cols-2 gap-3 text-sm max-h-[60vh] overflow-y-auto"></div>
        <div class="flex justify-end space-x-2 mt-4">
            <button id="closeModalBtn" class="px-4 py-2 bg-gray-300 rounded">å–æ¶ˆ</button>
            <button id="saveModalBtn" class="px-4 py-2 bg-blue-600 text-white rounded">ä¿å­˜</button>
        </div>
    </div>
</div>

<script>
(function() {
    // ---------- CouchDB é…ç½® ----------
    const COUCHDB_URL = 'http://satoko:1793364876@192.168.5.4:5984'; // è¯·æ ¹æ®å®é™…éƒ¨ç½²ä¿®æ”¹ï¼Œä¾‹å¦‚ https://your-couchdb.iriscouch.com
    // å¦‚æœä¸éœ€è¦åŒæ­¥æˆ–æ— æ³•è¿æ¥ï¼Œå¯ä»¥è®¾ä¸º null
    // const COUCHDB_URL = null;

    // ---------- PouchDB å®ä¾‹ ----------
    const dbEmployees = new PouchDB('employees');
    const dbSchedules = new PouchDB('schedules');
    const dbScheduleRules = new PouchDB('schedule_rules');
    const dbGlobalConfig = new PouchDB('global_config'); // å­˜å‚¨ç­æ¬¡æ—¶é—´ç­‰å…¨å±€é…ç½®

    // ---------- ä¸è¿œç¨‹ CouchDB åŒæ­¥ ----------
    function syncWithRemote(db, dbName) {
        if (!COUCHDB_URL) return;
        const remoteDB = new PouchDB(`${COUCHDB_URL}/${dbName}`);
        db.sync(remoteDB, { live: true, retry: true })
            .on('change', function (change) {
                console.log(`[sync] ${dbName} change`, change);
            })
            .on('paused', function (info) {
                console.log(`[sync] ${dbName} paused`, info);
            })
            .on('active', function () {
                console.log(`[sync] ${dbName} active`);
            })
            .on('denied', function (err) {
                console.log(`[sync] ${dbName} denied`, err);
            })
            .on('complete', function (info) {
                console.log(`[sync] ${dbName} complete`, info);
            })
            .on('error', function (err) {
                console.log(`[sync] ${dbName} error`, err);
            });
    }

    // å¯åŠ¨æ‰€æœ‰æ•°æ®åº“åŒæ­¥
    syncWithRemote(dbEmployees, 'employees');
    syncWithRemote(dbSchedules, 'schedules');
    syncWithRemote(dbScheduleRules, 'schedule_rules');
    syncWithRemote(dbGlobalConfig, 'global_config');

    // ---------- é»˜è®¤æ•°æ® (æ·»åŠ é‚®ç®±å­—æ®µ) ----------
    const defaultEmployees = [
        { è´¦å·:'è¿è¥é•¿', å¯†ç :'2026', é‚®ç®±:'yunyingzhang@example.com', æ˜¯å¦å¯ç”¨è¯¥è´¦å·:'æ˜¯', å¤‡æ³¨:'åœ¨èŒ' },
        { è´¦å·:'æè€å¸ˆ', å¯†ç :'2025', é‚®ç®±:'lilaoshi@example.com', æ˜¯å¦å¯ç”¨è¯¥è´¦å·:'æ˜¯', å¤‡æ³¨:'åœ¨èŒ' },
        { è´¦å·:'å°å°è€å¸ˆ', å¯†ç :'2025', é‚®ç®±:'xiaoxiaolaoshi@example.com', æ˜¯å¦å¯ç”¨è¯¥è´¦å·:'æ˜¯', å¤‡æ³¨:'åœ¨èŒ' },
        { è´¦å·:'ç‹è€å¸ˆ', å¯†ç :'2025', é‚®ç®±:'wanglaoshi@example.com', æ˜¯å¦å¯ç”¨è¯¥è´¦å·:'å¦', å¤‡æ³¨:'ç¦»èŒ' }
    ];

    // åˆå§‹åŒ–æ•°æ®åº“ï¼ˆä»…å½“æœ¬åœ°ä¸ºç©ºæ—¶å¡«å……é»˜è®¤æ•°æ®ï¼‰
    async function initDB() {
        // å‘˜å·¥è¡¨
        const empRes = await dbEmployees.allDocs({ limit: 1 });
        if (empRes.rows.length === 0) {
            for (let i = 0; i < defaultEmployees.length; i++) {
                const emp = { 
                    ...defaultEmployees[i], 
                    _id: 'emp_' + Date.now() + '_' + i,  // ä½¿ç”¨æ—¶é—´æˆ³é¿å…å†²çª
                    _ctime: Date.now() - i * 1000 
                };
                await dbEmployees.put(emp).catch(e => console.warn('å‘˜å·¥è¡¨åˆå§‹åŒ–å¤±è´¥', e));
            }
        }
        // å…¨å±€é…ç½®ï¼ˆç­æ¬¡æ—¶é—´ï¼‰
        try {
            await dbGlobalConfig.get('shifts');
        } catch (e) {
            await dbGlobalConfig.put({
                _id: 'shifts',
                shiftA: '9:00-18:00',
                shiftB: '11:00-20:00',
                shiftC: '10:00-19:00',
                shiftD: '13:00-22:00'
            });
        }
    }
    initDB();

    // ---------- ç™»å½•çŠ¶æ€ç®¡ç† ----------
    let currentUser = JSON.parse(sessionStorage.getItem('currentUser')) || null;
    const userDisplay = document.getElementById('userDisplay');
    const currentUserName = document.getElementById('currentUserName');
    const showLoginBtn = document.getElementById('showLoginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const loginModal = document.getElementById('loginModal');

    // ç®¡ç†å‘˜ç¡¬ç¼–ç ï¼ˆå¯è®¿é—®æ‰€æœ‰é¡µé¢ï¼Œä½†åœ¨æ­¤é¡µé¢åªéœ€éªŒè¯å‘˜å·¥è¡¨ï¼‰
    const ADMIN_ACCOUNT = 'ç®¡ç†å‘˜';
    const ADMIN_PASSWORD = '2026';

    function updateLoginUI() {
        if (currentUser) {
            userDisplay.classList.remove('hidden');
            currentUserName.innerText = currentUser.è´¦å· || '';
            showLoginBtn.classList.add('hidden');
            logoutBtn.classList.remove('hidden');
        } else {
            userDisplay.classList.add('hidden');
            showLoginBtn.classList.remove('hidden');
            logoutBtn.classList.add('hidden');
        }
        // æ¸²æŸ“å½“å‰tab
        const activeTab = document.querySelector('.tab-btn.text-blue-600').dataset.tab;
        if (activeTab === 'employee') renderEmployeeTable();
        else renderScheduleTable();
    }

    // åˆ¤æ–­æ˜¯å¦ä¸ºè¿è¥é•¿æˆ–ç®¡ç†å‘˜ï¼ˆè¿è¥é•¿æ‹¥æœ‰ç¼–è¾‘å†å²æœˆä»½æƒé™ï¼‰
    function isYunYingZhang() {
        return currentUser && (currentUser.è´¦å· === 'è¿è¥é•¿' || currentUser.è´¦å· === ADMIN_ACCOUNT);
    }

    // åˆ¤æ–­æŒ‡å®šæœˆä»½æ˜¯å¦å¯ç¼–è¾‘
    function canEditMonth(yearMonth) {
        const today = new Date();
        const currentYearMonth = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0');
        if (yearMonth < currentYearMonth) return isYunYingZhang();
        return true;
    }

    // ---------- å·¥å…·å‡½æ•° ----------
    function escapeHtml(unsafe) {
        if (unsafe === null || unsafe === undefined) return '';
        return String(unsafe)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#039;');
    }

    // ---------- å‘˜å·¥è¡¨ (æ–°å¢é‚®ç®±å­—æ®µ) ----------
    const employeeHeaders = ["è´¦å·","å¯†ç ","é‚®ç®±","æ˜¯å¦å¯ç”¨è¯¥è´¦å·","å¤‡æ³¨"];

    async function renderEmployeeTable() {
        const allDocs = await dbEmployees.allDocs({ include_docs: true });
        let rows = allDocs.rows.map(r => r.doc).filter(d => !d._id.startsWith('_design'));
        rows.sort((a, b) => (b._ctime || 0) - (a._ctime || 0));
        document.getElementById('employeeCount').innerText = rows.length;

        let html = `<table><thead><tr>${employeeHeaders.map(h => `<th>${escapeHtml(h)}</th>`).join('')}<th style="position:sticky;right:0;background:#edf2f7;">æ“ä½œ</th></tr></thead><tbody>`;
        rows.forEach(doc => {
            const rowId = doc._id;
            html += `<tr data-id="${escapeHtml(rowId)}" data-db="employees" class="cursor-pointer hover:bg-gray-100">`;
            employeeHeaders.forEach(header => {
                let val = doc[header] !== undefined ? doc[header] : '';
                if (typeof val === 'object') val = JSON.stringify(val);
                const displayVal = val.length > 20 ? val.substring(0, 20) + 'â€¦' : val;
                html += `<td class="editable-cell" data-field="${escapeHtml(header)}" title="${escapeHtml(val)}">${escapeHtml(displayVal)}</td>`;
            });
            html += `<td style="position:sticky;right:0;background:white;">
                <button class="delete-row-btn text-red-600 hover:text-red-800" title="åˆ é™¤"><i class="fas fa-trash"></i></button>
            </td></tr>`;
        });
        html += '</tbody></table>';
        document.getElementById('employeeTableContainer').innerHTML = html;

        document.querySelectorAll('#employeeTableContainer tbody tr[data-id]').forEach(tr => {
            tr.addEventListener('click', (e) => {
                if (e.target.closest('button')) return;
                const rowId = tr.dataset.id;
                showEditModal(rowId);
            });
        });
        document.querySelectorAll('#employeeTableContainer .delete-row-btn').forEach(btn => {
            btn.addEventListener('click', async e => {
                e.stopPropagation();
                if (!confirm('ç¡®å®šåˆ é™¤è¯¥å‘˜å·¥ï¼Ÿ')) return;
                const row = e.target.closest('tr');
                const id = row?.dataset.id;
                if (!id) return;
                try {
                    const doc = await dbEmployees.get(id);
                    await dbEmployees.remove(doc);
                    renderEmployeeTable();
                } catch (er) { alert('åˆ é™¤å¤±è´¥'); }
            });
        });
    }

    document.getElementById('addEmployeeBtn').addEventListener('click', async () => {
        if (!currentUser) { alert('è¯·å…ˆç™»å½•'); return; }
        const newDoc = {
            _id: 'emp_' + Date.now() + '_' + Math.random().toString(36).substr(2,4),
            _ctime: Date.now(),
            è´¦å·: '',
            å¯†ç : '',
            é‚®ç®±: '',
            æ˜¯å¦å¯ç”¨è¯¥è´¦å·: '',
            å¤‡æ³¨: ''
        };
        await dbEmployees.put(newDoc);
        renderEmployeeTable();
    });

    // ---------- ç¼–è¾‘å‘˜å·¥å¼¹çª— ----------
    let currentEditId = null;
    let currentEditDoc = null;

    async function showEditModal(rowId) {
        try {
            const doc = await dbEmployees.get(rowId);
            currentEditId = rowId;
            currentEditDoc = doc;
            const fieldsHtml = employeeHeaders.map(header => {
                let val = doc[header] !== undefined ? doc[header] : '';
                if (typeof val === 'object') val = JSON.stringify(val);
                const escapedVal = escapeHtml(val);
                if (header === 'æ˜¯å¦å¯ç”¨è¯¥è´¦å·') {
                    const selectedYes = (val === 'æ˜¯') ? 'selected' : '';
                    const selectedNo = (val === 'å¦') ? 'selected' : '';
                    return `
                        <div>
                            <label class="block font-medium">${escapeHtml(header)}</label>
                            <select class="w-full border p-1 rounded text-sm modal-field" data-field="${escapeHtml(header)}">
                                <option value="" ${!val ? 'selected' : ''}>--</option>
                                <option value="æ˜¯" ${selectedYes}>æ˜¯</option>
                                <option value="å¦" ${selectedNo}>å¦</option>
                            </select>
                        </div>
                    `;
                } else {
                    return `
                        <div>
                            <label class="block font-medium">${escapeHtml(header)}</label>
                            <input type="text" class="w-full border p-1 rounded text-sm modal-field" data-field="${escapeHtml(header)}" value="${escapedVal}">
                        </div>
                    `;
                }
            }).join('');
            document.getElementById('modalFields').innerHTML = fieldsHtml;
            document.getElementById('modalTitle').innerText = `ç¼–è¾‘å‘˜å·¥ - ${doc.è´¦å· || 'æ–°å‘˜å·¥'}`;
            document.getElementById('editModal').classList.remove('hidden');
        } catch (e) {
            alert('æ— æ³•åŠ è½½æ•°æ®');
        }
    }

    async function saveModalEdit() {
        if (!currentEditId || !currentEditDoc) return;
        const inputs = document.querySelectorAll('#modalFields .modal-field');
        inputs.forEach(input => {
            const field = input.dataset.field;
            if (field) currentEditDoc[field] = input.value;
        });
        currentEditDoc._ctime = Date.now();
        try {
            await dbEmployees.put(currentEditDoc);
            alert('ä¿å­˜æˆåŠŸ');
            closeModal();
            renderEmployeeTable();
        } catch (e) {
            console.error(e);
            alert('ä¿å­˜å¤±è´¥');
        }
    }

    function closeModal() {
        document.getElementById('editModal').classList.add('hidden');
        currentEditId = null;
        currentEditDoc = null;
    }

    // ---------- æ’ç­è¡¨ (ä¸ä¹‹å‰é€»è¾‘ä¸€è‡´ï¼Œä½†æ³¨æ„ä¾èµ–çš„å‘˜å·¥è¡¨å·²æœ‰é‚®ç®±) ----------
    let currentYearMonth = '';

    async function loadGlobalShifts() {
        try {
            const shifts = await dbGlobalConfig.get('shifts');
            document.getElementById('shiftA').value = shifts.shiftA || '9:00-18:00';
            document.getElementById('shiftB').value = shifts.shiftB || '11:00-20:00';
            document.getElementById('shiftC').value = shifts.shiftC || '10:00-19:00';
            document.getElementById('shiftD').value = shifts.shiftD || '13:00-22:00';
        } catch (e) {
            // ä½¿ç”¨é»˜è®¤å€¼
        }
    }

    // ä¿å­˜ç­æ¬¡æ—¶é—´ï¼ˆå…¨å±€ï¼‰
    document.getElementById('saveShiftsBtn').addEventListener('click', async () => {
        if (!currentUser) { alert('è¯·å…ˆç™»å½•'); return; }
        const shifts = {
            shiftA: document.getElementById('shiftA').value,
            shiftB: document.getElementById('shiftB').value,
            shiftC: document.getElementById('shiftC').value,
            shiftD: document.getElementById('shiftD').value
        };
        try {
            let doc;
            try {
                doc = await dbGlobalConfig.get('shifts');
            } catch (e) {
                doc = { _id: 'shifts' };
            }
            Object.assign(doc, shifts);
            doc._ctime = Date.now();
            await dbGlobalConfig.put(doc);
            alert('ç­æ¬¡æ—¶é—´ä¿å­˜æˆåŠŸ');
        } catch (e) {
            alert('ä¿å­˜å¤±è´¥');
        }
    });

    async function renderScheduleTable() {
        const monthPicker = document.getElementById('monthPicker');
        if (!monthPicker.value) {
            const today = new Date();
            currentYearMonth = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0');
            monthPicker.value = currentYearMonth;
        } else {
            currentYearMonth = monthPicker.value;
        }

        // è·å–å¯ç”¨å‘˜å·¥
        const allEmps = await dbEmployees.allDocs({ include_docs: true });
        const employees = allEmps.rows.map(r => r.doc).filter(d => !d._id.startsWith('_design') && d.æ˜¯å¦å¯ç”¨è¯¥è´¦å· === 'æ˜¯');
        const employeeNames = employees.map(e => e.è´¦å·).filter(name => name);

        if (employeeNames.length === 0) {
            document.getElementById('scheduleTableContainer').innerHTML = '<p class="text-gray-500 p-2">æš‚æ— å‘˜å·¥ï¼Œè¯·å…ˆæ·»åŠ å¯ç”¨è´¦å·çš„å‘˜å·¥ã€‚</p>';
            document.getElementById('scheduleStats').innerHTML = '';
            return;
        }

        const [year, month] = currentYearMonth.split('-').map(Number);
        const daysInMonth = new Date(year, month, 0).getDate();

        // è·å–æœ¬æœˆè§„åˆ™
        const ruleId = `rule_${year}_${month}`;
        let ruleDoc;
        try {
            ruleDoc = await dbScheduleRules.get(ruleId);
        } catch (e) {
            ruleDoc = {
                _id: ruleId,
                fixedWeekdays: [],
                fixedDates: [],
                restDaysPerMonth: 8,
                weekendRestLimit: 3,
                weekdayRestLimit: 2,
                minEvening: 0,
                noEveningDates: []
            };
        }
        fillRuleForm(ruleDoc);

        // è·å–æ’ç­æ•°æ®
        const scheduleId = `schedule_${year}_${month}`;
        let scheduleDoc;
        try {
            scheduleDoc = await dbSchedules.get(scheduleId);
        } catch (e) {
            scheduleDoc = { _id: scheduleId, data: {} };
        }
        const scheduleData = scheduleDoc.data || {};

        const weekdays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
        const dayHeaders = [];
        const weekdayHeaders = [];
        for (let d = 1; d <= daysInMonth; d++) {
            const date = new Date(year, month - 1, d);
            dayHeaders.push(d);
            weekdayHeaders.push(weekdays[date.getDay()]);
        }

        const editable = canEditMonth(currentYearMonth);
        document.getElementById('modeText').innerText = editable ? 'ğŸ“ å¯ç¼–è¾‘æ¨¡å¼' : 'ğŸ”’ åªè¯»æ¨¡å¼ï¼ˆä»…è¿è¥é•¿æˆ–ç®¡ç†å‘˜å¯ç¼–è¾‘ï¼‰';

        // æ„å»ºè¡¨æ ¼
        let html = '<table><thead>';
        html += '<tr><th class="sticky left-0 bg-gray-100" style="left:0;">å‘˜å·¥</th>';
        dayHeaders.forEach(d => html += `<th>${d}</th>`);
        html += '</tr>';
        html += '<tr><th class="sticky left-0 bg-gray-100" style="left:0;">æ˜ŸæœŸ</th>';
        weekdayHeaders.forEach(w => html += `<th>${w}</th>`);
        html += '</tr>';
        html += '</thead><tbody>';

        const shiftOptions = ['Aç­', 'Bç­', 'Cç­', 'Dç­', 'ä¼‘æ¯', 'è°ƒä¼‘'];

        employeeNames.forEach(name => {
            html += `<tr>`;
            html += `<td class="sticky left-0 bg-white font-medium" style="left:0;">${escapeHtml(name)}</td>`;
            for (let d = 1; d <= daysInMonth; d++) {
                const cellValue = scheduleData[name]?.[d] || '';
                const selectDisabled = !editable ? 'disabled' : '';
                let optionClass = '';
                if (cellValue === 'ä¼‘æ¯') optionClass = 'rest';
                else if (cellValue === 'è°ƒä¼‘') optionClass = 'off';
                else if (cellValue === 'Aç­') optionClass = 'a';
                else if (cellValue === 'Bç­') optionClass = 'b';
                else if (cellValue === 'Cç­') optionClass = 'c';
                else if (cellValue === 'Dç­') optionClass = 'd';
                html += `<td class="schedule-cell"><select class="schedule-select ${optionClass}" data-employee="${escapeHtml(name)}" data-day="${d}" ${selectDisabled}>`;
                html += `<option value="" ${cellValue === '' ? 'selected' : ''}>--</option>`;
                shiftOptions.forEach(opt => {
                    html += `<option value="${opt}" ${cellValue === opt ? 'selected' : ''}>${opt}</option>`;
                });
                html += `</select></td>`;
            }
            html += `</tr>`;
        });
        html += '</tbody></table>';
        document.getElementById('scheduleTableContainer').innerHTML = html;

        // ç»‘å®šä¸‹æ‹‰å˜æ›´äº‹ä»¶
        if (editable) {
            document.querySelectorAll('#scheduleTableContainer select').forEach(select => {
                select.addEventListener('change', async (e) => {
                    const emp = e.target.dataset.employee;
                    const day = e.target.dataset.day;
                    const val = e.target.value;
                    let scheduleDoc;
                    try {
                        scheduleDoc = await dbSchedules.get(scheduleId);
                    } catch (e) {
                        scheduleDoc = { _id: scheduleId, data: {} };
                    }
                    if (!scheduleDoc.data) scheduleDoc.data = {};
                    if (!scheduleDoc.data[emp]) scheduleDoc.data[emp] = {};
                    scheduleDoc.data[emp][day] = val;
                    scheduleDoc._ctime = Date.now();
                    await dbSchedules.put(scheduleDoc);
                    // æ›´æ–°å•å…ƒæ ¼æ ·å¼
                    updateCellClass(e.target, val);
                    // é‡æ–°è®¡ç®—ç»Ÿè®¡
                    computeStats(employeeNames, scheduleDoc.data, daysInMonth, year, month);
                    // æ ¡éªŒè§„åˆ™å¹¶æ ‡è®°ç²‰çº¢
                    validateAndMark(employeeNames, scheduleDoc.data, daysInMonth, year, month, ruleDoc);
                });
            });
        }

        // åˆå§‹ç»Ÿè®¡å’Œæ ¡éªŒ
        computeStats(employeeNames, scheduleData, daysInMonth, year, month);
        validateAndMark(employeeNames, scheduleData, daysInMonth, year, month, ruleDoc);
    }

    function updateCellClass(select, val) {
        select.className = 'schedule-select';
        if (val === 'ä¼‘æ¯') select.classList.add('rest');
        else if (val === 'è°ƒä¼‘') select.classList.add('off');
        else if (val === 'Aç­') select.classList.add('a');
        else if (val === 'Bç­') select.classList.add('b');
        else if (val === 'Cç­') select.classList.add('c');
        else if (val === 'Dç­') select.classList.add('d');
    }

    function fillRuleForm(ruleDoc) {
        document.querySelectorAll('.fixed-weekday').forEach(cb => {
            cb.checked = ruleDoc.fixedWeekdays?.includes(parseInt(cb.value)) || false;
        });
        document.getElementById('fixedDates').value = ruleDoc.fixedDates ? ruleDoc.fixedDates.join(',') : '';
        document.getElementById('restDaysPerMonth').value = ruleDoc.restDaysPerMonth || 8;
        document.getElementById('weekendRestLimit').value = ruleDoc.weekendRestLimit || 3;
        document.getElementById('weekdayRestLimit').value = ruleDoc.weekdayRestLimit || 2;
        document.getElementById('minEvening').value = ruleDoc.minEvening || 0;
        document.getElementById('noEveningDates').value = ruleDoc.noEveningDates ? ruleDoc.noEveningDates.join(',') : '';
    }

    function collectRuleForm() {
        const fixedWeekdays = [];
        document.querySelectorAll('.fixed-weekday:checked').forEach(cb => fixedWeekdays.push(parseInt(cb.value)));
        const fixedDates = document.getElementById('fixedDates').value.split(',').map(s => s.trim()).filter(s => s);
        const restDaysPerMonth = parseInt(document.getElementById('restDaysPerMonth').value) || 8;
        const weekendRestLimit = parseInt(document.getElementById('weekendRestLimit').value) || 3;
        const weekdayRestLimit = parseInt(document.getElementById('weekdayRestLimit').value) || 2;
        const minEvening = parseInt(document.getElementById('minEvening').value) || 0;
        const noEveningDates = document.getElementById('noEveningDates').value.split(',').map(s => s.trim()).filter(s => s);
        return { fixedWeekdays, fixedDates, restDaysPerMonth, weekendRestLimit, weekdayRestLimit, minEvening, noEveningDates };
    }

    // ä¿å­˜è§„åˆ™å¹¶è‡ªåŠ¨å¡«å……æ’ç­è¡¨
    document.getElementById('saveRulesBtn').addEventListener('click', async () => {
        if (!currentUser) { alert('è¯·å…ˆç™»å½•'); return; }
        const [year, month] = currentYearMonth.split('-').map(Number);
        const ruleId = `rule_${year}_${month}`;
        const ruleData = collectRuleForm();
        try {
            let doc;
            try {
                doc = await dbScheduleRules.get(ruleId);
            } catch (e) {
                doc = { _id: ruleId };
            }
            Object.assign(doc, ruleData);
            doc._ctime = Date.now();
            await dbScheduleRules.put(doc);

            // è‡ªåŠ¨å¡«å……æ’ç­è¡¨ï¼šæ ¹æ®å…¨ä½“å›ºå®šä¼‘æ¯æ—¥å’Œå›ºå®šæ—¥æœŸï¼Œå°†å¯¹åº”å•å…ƒæ ¼è®¾ä¸ºâ€œä¼‘æ¯â€
            const scheduleId = `schedule_${year}_${month}`;
            let scheduleDoc;
            try {
                scheduleDoc = await dbSchedules.get(scheduleId);
            } catch (e) {
                scheduleDoc = { _id: scheduleId, data: {} };
            }
            const scheduleData = scheduleDoc.data || {};
            const allEmps = await dbEmployees.allDocs({ include_docs: true });
            const employees = allEmps.rows.map(r => r.doc).filter(d => !d._id.startsWith('_design') && d.æ˜¯å¦å¯ç”¨è¯¥è´¦å· === 'æ˜¯');
            const employeeNames = employees.map(e => e.è´¦å·).filter(name => name);
            const daysInMonth = new Date(year, month, 0).getDate();

            // åº”ç”¨è§„åˆ™ï¼šå…¨ä½“å›ºå®šä¼‘æ¯æ—¥æ˜ŸæœŸ
            const fixedWeekdaysSet = new Set(ruleData.fixedWeekdays);
            const fixedDatesSet = new Set(ruleData.fixedDates);

            let changed = false;
            for (let d = 1; d <= daysInMonth; d++) {
                const date = new Date(year, month - 1, d);
                const weekday = date.getDay();
                const dayStr = String(d).padStart(2, '0');
                if (fixedWeekdaysSet.has(weekday) || fixedDatesSet.has(dayStr)) {
                    // å¯¹æ‰€æœ‰å‘˜å·¥è®¾ç½®â€œä¼‘æ¯â€
                    employeeNames.forEach(name => {
                        if (!scheduleData[name]) scheduleData[name] = {};
                        if (scheduleData[name][d] !== 'ä¼‘æ¯') {
                            scheduleData[name][d] = 'ä¼‘æ¯';
                            changed = true;
                        }
                    });
                }
            }
            if (changed) {
                scheduleDoc.data = scheduleData;
                scheduleDoc._ctime = Date.now();
                await dbSchedules.put(scheduleDoc);
            }
            alert('è§„åˆ™ä¿å­˜æˆåŠŸï¼Œå¹¶å·²è‡ªåŠ¨å¡«å……å…¨ä½“ä¼‘æ¯æ—¥');
            renderScheduleTable(); // é‡æ–°æ¸²æŸ“
        } catch (e) {
            console.error(e);
            alert('ä¿å­˜å¤±è´¥');
        }
    });

    // æ ¡éªŒè§„åˆ™å¹¶æ ‡è®°ç²‰çº¢åº•è‰²
    function validateAndMark(employeeNames, scheduleData, daysInMonth, year, month, ruleDoc) {
        const weekendRestLimit = ruleDoc.weekendRestLimit || 3;
        const weekdayRestLimit = ruleDoc.weekdayRestLimit || 2;
        const minEvening = ruleDoc.minEvening || 0;
        const noEveningSet = new Set(ruleDoc.noEveningDates || []);

        // æ¸…é™¤æ‰€æœ‰ç²‰çº¢åº•è‰²
        document.querySelectorAll('#scheduleTableContainer select').forEach(sel => sel.classList.remove('warning-pink'));

        // æ£€æŸ¥æ¯å¤©ä¼‘æ¯äººæ•°
        for (let d = 1; d <= daysInMonth; d++) {
            const date = new Date(year, month - 1, d);
            const isWeekend = (date.getDay() === 0 || date.getDay() === 6);
            const limit = isWeekend ? weekendRestLimit : weekdayRestLimit;
            let restCount = 0;
            employeeNames.forEach(name => {
                const val = scheduleData[name]?.[d];
                if (val === 'ä¼‘æ¯' || val === 'è°ƒä¼‘') restCount++;
            });
            if (restCount > limit) {
                // æ ‡è®°è¯¥åˆ—æ‰€æœ‰å•å…ƒæ ¼ä¸ºç²‰çº¢
                employeeNames.forEach(name => {
                    const sel = document.querySelector(`select[data-employee="${name}"][data-day="${d}"]`);
                    if (sel) sel.classList.add('warning-pink');
                });
            }
        }

        // æ£€æŸ¥æ¯å¤©æ™šç­äººæ•°
        for (let d = 1; d <= daysInMonth; d++) {
            if (noEveningSet.has(String(d).padStart(2, '0'))) continue;
            let eveningCount = 0;
            employeeNames.forEach(name => {
                const val = scheduleData[name]?.[d];
                if (val === 'Bç­' || val === 'Dç­') eveningCount++;
            });
            if (eveningCount < minEvening) {
                employeeNames.forEach(name => {
                    const sel = document.querySelector(`select[data-employee="${name}"][data-day="${d}"]`);
                    if (sel) sel.classList.add('warning-pink');
                });
            }
        }
    }

    // ç»Ÿè®¡è®¡ç®—
    function computeStats(employeeNames, scheduleData, daysInMonth, year, month) {
        let statsHtml = '<div class="font-medium mb-1">ğŸ“Š å‘˜å·¥æœ¬æœˆç»Ÿè®¡</div>';
        employeeNames.forEach(name => {
            let restCount = 0;
            let weekendRestCount = 0;
            let eveningCount = 0;
            for (let d = 1; d <= daysInMonth; d++) {
                const val = scheduleData[name]?.[d] || '';
                if (val === 'ä¼‘æ¯') {
                    restCount++;
                    const date = new Date(year, month - 1, d);
                    const w = date.getDay();
                    if (w === 0 || w === 6) weekendRestCount++;
                }
                if (val === 'Bç­' || val === 'Dç­') eveningCount++;
            }
            statsHtml += `<span class="stat-item">${escapeHtml(name)}: ä¼‘æ¯${restCount}å¤© (å‘¨æœ«ä¼‘${weekendRestCount}) æ™šç­${eveningCount}æ¬¡</span>`;
        });
        document.getElementById('scheduleStats').innerHTML = statsHtml;
    }

    document.getElementById('saveScheduleBtn').addEventListener('click', () => {
        alert('æ‰€æœ‰ä¿®æ”¹å·²è‡ªåŠ¨ä¿å­˜');
    });

    document.getElementById('refreshScheduleBtn').addEventListener('click', renderScheduleTable);

    document.getElementById('monthPicker').addEventListener('change', renderScheduleTable);

    // è§„åˆ™é¢æ¿æŠ˜å 
    const rulePanel = document.getElementById('rulePanel');
    const toggleBtn = document.getElementById('toggleRulePanel');
    toggleBtn.addEventListener('click', () => {
        rulePanel.classList.toggle('collapsed');
        toggleBtn.classList.toggle('rotated');
    });

    // ---------- é€‰é¡¹å¡åˆ‡æ¢ ----------
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', e => {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('text-blue-600', 'border-b-2', 'border-blue-500'));
            btn.classList.add('text-blue-600', 'border-b-2', 'border-blue-500');
            document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
            const tab = btn.dataset.tab;
            document.getElementById(`tab-${tab}`).classList.remove('hidden');
            if (tab === 'employee') renderEmployeeTable();
            else {
                loadGlobalShifts();
                renderScheduleTable();
            }
        });
    });

    // ---------- å…¨å± ----------
    const container = document.querySelector('.max-w-7xl.mx-auto.bg-white.p-4.rounded.shadow');
    document.getElementById('fullscreenBtn').addEventListener('click', () => {
        if (!document.fullscreenElement) {
            container.requestFullscreen().catch(err => alert('å…¨å±å¤±è´¥'));
        } else {
            document.exitFullscreen();
        }
    });

    // ---------- å¯¼å‡º ----------
    async function exportCurrentTab() {
        if (!currentUser) { alert('è¯·å…ˆç™»å½•'); return; }
        const activeTab = document.querySelector('.tab-btn.text-blue-600').dataset.tab;
        const wb = XLSX.utils.book_new();
        if (activeTab === 'employee') {
            const allDocs = await dbEmployees.allDocs({ include_docs: true });
            let rows = allDocs.rows.map(r => r.doc).filter(d => !d._id.startsWith('_design'));
            const headers = employeeHeaders;
            const data = rows.map(d => headers.map(h => d[h] !== undefined ? d[h] : ''));
            const ws = XLSX.utils.aoa_to_sheet([headers, ...data]);
            XLSX.utils.book_append_sheet(wb, ws, 'å‘˜å·¥è¡¨');
        } else {
            // å¯¼å‡ºå½“å‰æ’ç­è¡¨
            const [year, month] = currentYearMonth.split('-').map(Number);
            const allEmps = await dbEmployees.allDocs({ include_docs: true });
            const employees = allEmps.rows.map(r => r.doc).filter(d => !d._id.startsWith('_design') && d.æ˜¯å¦å¯ç”¨è¯¥è´¦å· === 'æ˜¯');
            const employeeNames = employees.map(e => e.è´¦å·).filter(name => name);
            const scheduleId = `schedule_${year}_${month}`;
            let scheduleDoc;
            try {
                scheduleDoc = await dbSchedules.get(scheduleId);
            } catch (e) {
                scheduleDoc = { data: {} };
            }
            const daysInMonth = new Date(year, month, 0).getDate();
            const weekdays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
            // æ„å»ºäºŒç»´æ•°ç»„
            const headers = ['å‘˜å·¥', ...Array.from({ length: daysInMonth }, (_, i) => i + 1)];
            const data = [];
            employeeNames.forEach(name => {
                const row = [name];
                for (let d = 1; d <= daysInMonth; d++) {
                    row.push(scheduleDoc.data?.[name]?.[d] || '');
                }
                data.push(row);
            });
            // æ·»åŠ æ˜ŸæœŸè¡Œ
            const weekdayRow = ['æ˜ŸæœŸ', ...weekdays.slice(0, daysInMonth).map((_, idx) => weekdays[new Date(year, month - 1, idx + 1).getDay()])];
            data.unshift(weekdayRow);
            data.unshift(headers);
            const ws = XLSX.utils.aoa_to_sheet(data);
            XLSX.utils.book_append_sheet(wb, ws, `æ’ç­è¡¨_${year}å¹´${month}æœˆ`);
        }
        XLSX.writeFile(wb, `${activeTab}_${new Date().toISOString().slice(0,10)}.xlsx`);
    }

    document.getElementById('exportCurrentBtn').addEventListener('click', exportCurrentTab);

    document.getElementById('exportAllBtn').addEventListener('click', async () => {
        alert('å¯¼å‡ºå…¨éƒ¨åŠŸèƒ½åŒ…å«å‘˜å·¥è¡¨å’Œæ‰€æœ‰æ’ç­è¡¨ï¼Œå¯è‡ªè¡Œæ‰©å±•');
    });

    document.getElementById('importBtn').addEventListener('click', () => {
        alert('å¯¼å…¥åŠŸèƒ½å¯è‡ªè¡Œæ‰©å±•');
    });

    // ---------- ç™»å½•æ¨¡æ€æ¡†äº‹ä»¶ ----------
    document.getElementById('showLoginBtn').addEventListener('click', () => {
        loginModal.classList.remove('hidden');
    });
    document.getElementById('closeLoginModal').addEventListener('click', () => {
        loginModal.classList.add('hidden');
    });
    document.getElementById('loginBtn').addEventListener('click', async () => {
        const acc = document.getElementById('loginUser').value;
        const pwd = document.getElementById('loginPass').value;

        // ç®¡ç†å‘˜ç¡¬ç¼–ç æ£€æŸ¥
        if (acc === ADMIN_ACCOUNT && pwd === ADMIN_PASSWORD) {
            // æ„é€ ä¸€ä¸ªè™šæ‹Ÿç®¡ç†å‘˜å¯¹è±¡
            currentUser = { è´¦å·: ADMIN_ACCOUNT, æ˜¯å¦å¯ç”¨è¯¥è´¦å·: 'æ˜¯' };
            sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
            updateLoginUI();
            loginModal.classList.add('hidden');
            return;
        }

        // æ™®é€šå‘˜å·¥éªŒè¯
        try {
            const res = await dbEmployees.allDocs({ include_docs: true });
            const users = res.rows.map(r => r.doc);
            const found = users.find(u => u.è´¦å· === acc && u.å¯†ç  === pwd && u.æ˜¯å¦å¯ç”¨è¯¥è´¦å· === 'æ˜¯');
            if (found) {
                currentUser = found;
                sessionStorage.setItem('currentUser', JSON.stringify(found));
                updateLoginUI();
                loginModal.classList.add('hidden');
            } else {
                alert('ç™»å½•å¤±è´¥ï¼šè´¦å·/å¯†ç é”™è¯¯æˆ–è´¦å·æœªå¯ç”¨');
            }
        } catch (e) {
            alert('ç™»å½•éªŒè¯å¤±è´¥');
        }
    });
    document.getElementById('logoutBtn').addEventListener('click', () => {
        currentUser = null;
        sessionStorage.removeItem('currentUser');
        updateLoginUI();
    });

    // å¼¹çª—å…³é—­
    document.getElementById('closeModalBtn').addEventListener('click', closeModal);
    document.getElementById('saveModalBtn').addEventListener('click', saveModalEdit);

    // åˆå§‹åŒ–
    updateLoginUI();
})();
</script>
<!-- æ•°æ®å­˜å‚¨è¯´æ˜ï¼šå‘˜å·¥ã€æ’ç­ã€è§„åˆ™ã€ç­æ¬¡æ—¶é—´å‡ä¿å­˜åœ¨æµè§ˆå™¨æœ¬åœ°IndexedDBï¼Œå¹¶ä¸è¿œç¨‹CouchDBå®æ—¶åŒæ­¥ã€‚ç®¡ç†å‘˜è´¦å· admin/2026 å¯è®¿é—®æ‰€æœ‰é¡µé¢ã€‚ -->
</body>
</html>