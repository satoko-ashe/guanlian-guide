<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‡ªåŠ¨è®°å• Â· å­¦å‘˜ç®¡ç†ï¼ˆç­å‹è”åŠ¨+é‚®ç®±éªŒè¯+ç±»åˆ«å¿…é€‰ï¼‰</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/pouchdb@8.0.1/dist/pouchdb.min.js"></script>
    <style>
        .tab-active { background-color: #e0f2fe; border-bottom: 2px solid #0284c7; }
        .no-scrollbar { overflow: visible !important; max-height: none !important; }
        .stretch-textarea { min-height: 220px; resize: vertical; }
        .combo-field { display: flex; gap: 4px; align-items: center; }
        .warning-pink { background-color: #fce4e4; border-color: #f5c6cb; }
        .error-tip { color: #dc2626; font-size: 0.7rem; margin-top: 2px; display: none; }
        .field-error { border: 1px solid #dc2626 !important; }
        .province-hint { font-size: 0.7rem; color: #6b7280; margin-top: 2px; }
    </style>
</head>
<body class="bg-gray-50 font-sans p-4">

<!-- å³ä¸Šè§’å¯¼èˆª -->
<div class="max-w-7xl mx-auto mb-2 flex justify-end space-x-3 text-sm">
    <a href="autoNote.html" target="_blank" class="bg-white px-3 py-1 rounded shadow hover:bg-gray-100"><i class="fas fa-pen-fancy mr-1"></i>è‡ªåŠ¨è®°å•</a>
    <a href="masterTable.html" target="_blank" class="bg-white px-3 py-1 rounded shadow hover:bg-gray-100"><i class="fas fa-table mr-1"></i>è¿è¥ç™»è®°å¤§è¡¨</a>
    <a href="admin.html" target="_blank" class="bg-white px-3 py-1 rounded shadow hover:bg-gray-100"><i class="fas fa-lock mr-1"></i>ç®¡ç†æƒé™</a>
</div>

<!-- ç™»å½•çŠ¶æ€æ¡ -->
<div class="max-w-7xl mx-auto mb-4 flex justify-between items-center bg-white p-2 rounded shadow">
    <span class="text-sm text-gray-600"><i class="fas fa-database mr-1 text-blue-500"></i>æœ¬åœ°ä¼˜å…ˆ + PouchDB å°±ç»ª (ä¸CouchDBå®æ—¶åŒæ­¥)</span>
    <div id="loginStatus" class="text-sm">
        <span id="userDisplay" class="hidden mr-2">ğŸ‘¤ <span id="currentUserName"></span></span>
        <button id="showLoginBtn" class="bg-blue-500 text-white px-3 py-1 rounded text-sm"><i class="fas fa-sign-in-alt mr-1"></i>ç™»å½•</button>
        <button id="logoutBtn" class="bg-gray-300 px-3 py-1 rounded text-sm hidden">é€€å‡º</button>
    </div>
</div>

<!-- ä¸»å†…å®¹ -->
<div class="max-w-7xl mx-auto">
    <!-- ä¸Šé¢å·¦å³ä¸¤æ  -->
    <div class="grid grid-cols-2 gap-4 items-stretch">
        <!-- å·¦è¾¹ç²˜è´´åŒº -->
        <div class="bg-white p-4 rounded shadow flex flex-col">
            <label class="block font-semibold mb-2"><i class="fas fa-clipboard mr-1"></i>ç²˜è´´æ‹›ç”Ÿå¯¹æ¥ä¿¡æ¯ (è‡ªåŠ¨è§£æ)</label>
            <textarea id="rawInput" class="w-full border rounded p-2 text-sm font-mono flex-1 stretch-textarea" placeholder="ä¾‹å¦‚ï¼š&#10;å§“åï¼šå´çŸ¥äº‘&#10;æ€§åˆ«ï¼šå¥³&#10;æœ€é«˜å­¦å†ï¼šæœ¬ç§‘&#10;æ¯•ä¸šé™¢æ ¡ï¼šåŒ—äº¬å¤§å­¦&#10;æ¯•ä¸šæ—¶é—´ï¼š2014å¹´6æœˆ&#10;æŠ¥è€ƒä¸“ä¸šï¼šå·¥ç¨‹ç®¡ç†&#10;æŠ¥è€ƒé™¢æ ¡ï¼šå¹¿ä¸œå·¥ä¸šå¤§å­¦&#10;é‚®ç®±ï¼šandy5201314@163.com&#10;åœ°å€:å¹¿å·å¸‚å¤©å ‚é•‡..."></textarea>
            <div class="grid grid-cols-2 gap-2 mt-3">
                <button id="parseBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-2 py-2 rounded text-sm"><i class="fas fa-robot mr-1"></i>è§£æå¹¶å¡«å……</button>
                <button id="resetBtn" class="bg-gray-500 hover:bg-gray-600 text-white px-2 py-2 rounded text-sm"><i class="fas fa-undo-alt mr-1"></i>æ•°æ®é‡ç½®</button>
            </div>
        </div>
        <!-- å³è¾¹è¡¨å•åŒº -->
        <div class="bg-white p-4 rounded shadow no-scrollbar">
            <h3 class="font-semibold mb-2 flex"><i class="fas fa-edit text-green-600 mr-1"></i>æå–åç¼–è¾‘ (å®æ—¶ç”Ÿæˆè®°å•é¢„è§ˆ)</h3>
            <div class="grid grid-cols-2 gap-x-3 gap-y-2 text-sm">
                <div>
                    <label>@å§“å</label><input id="field_name" class="w-full border p-1 rounded">
                </div>
                <div>
                    <label>@æ‰‹æœºå· <span class="text-red-400">*</span></label>
                    <input id="field_mobile" class="w-full border p-1 rounded" maxlength="11">
                    <div class="error-tip" id="error_mobile">è¯·è¾“å…¥11ä½æ‰‹æœºå·</div>
                </div>
                <div><label>@ç­å‹</label><input id="field_className" class="w-full border p-1 rounded" placeholder="ä¾‹å¦‚ï¼šã€Šç®¡ç†ç±»è”è€ƒç¬”è¯•+å¤è¯•ã€‹VIP..."></div>
                <div>
                    <label>@æˆ·ç± <span class="text-red-400">*</span></label>
                    <input id="field_domicile" class="w-full border p-1 rounded" placeholder="å¦‚ï¼šXXçœXXå¸‚ã€XXå¸‚">
                    <div class="error-tip" id="error_domicile">è¯·å¡«å†™â€œXXçœXXå¸‚â€æˆ–ç›´è¾–å¸‚â€œXXå¸‚â€</div>
                </div>
                <div>
                    <label>@å·¥ä½œ/ç”Ÿæ´»åŸå¸‚</label>
                    <input id="field_workCity" class="w-full border p-1 rounded" placeholder="XXçœXXå¸‚/XXå¸‚">
                    <div class="error-tip" id="error_workCity">æ ¼å¼ï¼šXXçœXXå¸‚ æˆ– XXå¸‚</div>
                </div>
                <div>
                    <label>@ç¤¾ä¿åŸå¸‚ <span class="text-red-400">*</span></label>
                    <input id="field_socialCity" class="w-full border p-1 rounded" placeholder="å¦‚ï¼šXXçœXXå¸‚ã€XXå¸‚">
                    <div class="error-tip" id="error_socialCity">è¯·å¡«å†™â€œXXçœXXå¸‚â€æˆ–ç›´è¾–å¸‚â€œXXå¸‚â€</div>
                </div>
                <div><label>@ç¤¾ä¿æ—¶é•¿</label><input id="field_socialDuration" class="w-full border p-1 rounded"></div>
                <div><label>@æ„å‘é™¢æ ¡ <span class="text-red-400">*</span></label><input id="field_targetSchool" class="w-full border p-1 rounded"></div>
                <div><label>@æ„å‘ä¸“ä¸š <span class="text-red-400">*</span></label><input id="field_targetMajor" class="w-full border p-1 rounded"></div>
                <div>
                    <label>@æ„å‘å­¦ä¹ åŸå¸‚ <span class="text-red-400">*</span></label>
                    <input id="field_studyCity" class="w-full border p-1 rounded" placeholder="å»ºè®®å¡«çœä»½+åŸå¸‚ï¼Œå¦‚XXçœXXå¸‚">
                    <div class="error-tip" id="error_studyCity">æ ¼å¼å»ºè®®ï¼šXXçœXXå¸‚</div>
                </div>
                <div><label>@æœ€é«˜å­¦å† <span class="text-red-400">*</span></label><input id="field_highestEdu" class="w-full border p-1 rounded"></div>
                <div>
                    <label>@æ¯•ä¸šæ—¶é—´ <span class="text-red-400">*</span></label>
                    <input id="field_graduationYear" class="w-full border p-1 rounded" placeholder="ä¾‹å¦‚ï¼š2016å¹´ æˆ– 2016å¹´06æœˆ">
                    <div class="error-tip" id="error_graduationYear">æ ¼å¼ï¼šXXXXå¹´ æˆ– XXXXå¹´XXæœˆ</div>
                </div>
                <div><label>@å…¶ä»–å­¦å†</label><input id="field_otherEdu" class="w-full border p-1 rounded"></div>
                <div>
                    <label>@å…¶ä»–å­¦å†è·å–æ—¶é—´</label>
                    <input id="field_otherEduDate" class="w-full border p-1 rounded" placeholder="XXXXå¹´ æˆ– XXXXå¹´XXæœˆ">
                    <div class="error-tip" id="error_otherEduDate">æ ¼å¼ï¼šXXXXå¹´ æˆ– XXXXå¹´XXæœˆ</div>
                </div>
                <!-- æ¯•ä¸šè¯åŸä»¶æ˜¯å¦åœ¨ï¼šä¸‹æ‹‰ -->
                <div><label>@æ¯•ä¸šè¯åŸä»¶æ˜¯å¦åœ¨</label>
                    <select id="field_certOriginal" class="w-full border p-1 rounded">
                        <option value="">-- è¯·é€‰æ‹© --</option>
                        <option value="æ˜¯">æ˜¯</option>
                        <option value="å¦">å¦</option>
                    </select>
                </div>
                <div>
                    <label>@é‚®ç®±å·ç  <span class="text-red-400">*</span></label>
                    <input id="field_email" class="w-full border p-1 rounded" placeholder="ä¾‹å¦‚ï¼šname@example.com">
                    <div class="error-tip" id="error_email">é‚®ç®±æ ¼å¼ä¸æ­£ç¡®ï¼Œéœ€åŒ…å«@å’ŒåŸŸå</div>
                </div>
                <!-- æ˜¯å¦å¸¸ç”¨æ‰‹æœºï¼šä¸‹æ‹‰ -->
                <div><label>@æ˜¯å¦å¸¸ç”¨æ‰‹æœº</label>
                    <select id="field_isMobileCommon" class="w-full border p-1 rounded">
                        <option value="">-- è¯·é€‰æ‹© --</option>
                        <option value="æ˜¯">æ˜¯</option>
                        <option value="å¦">å¦</option>
                    </select>
                </div>
                <div><label>@å…¶ä»–æ‰‹æœºå·</label><input id="field_otherMobile" class="w-full border p-1 rounded"></div>
                <div><label>@å¾®ä¿¡å·</label><input id="field_wechat" class="w-full border p-1 rounded"></div>
                <!-- å¯„ä»¶åœ°å€ä¸å‚ä¸è®°å•ï¼Œä½†ä¿ç•™è¾“å…¥æ¡† -->
                <div class="col-span-2"><label>@å¯„ä»¶æ¥æ”¶åœ°å€ (ä¸è®°å…¥è®°å•)</label><input id="field_mailingAddress" class="w-full border p-1 rounded"></div>
            </div>
            <div class="flex justify-end mt-4 space-x-2">
                <button id="saveAndNoteBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded text-sm"><i class="fas fa-save mr-1"></i>è®°å•â†’ä¿å­˜&å½•å…¥</button>
            </div>
            <p id="mergeWarning" class="text-xs text-red-500 mt-1"></p>
        </div>
    </div>

    <!-- ä¸‹é¢å¤§é¢æ¿ï¼šè‡ªåŠ¨è®°å• -->
    <div class="bg-white p-4 rounded shadow mt-6">
        <div class="flex items-center justify-between mb-2 flex-wrap gap-2">
            <span class="font-semibold"><i class="fas fa-comment-dots text-blue-500 mr-1"></i>è‡ªåŠ¨è®°å• (å®æ—¶é¢„è§ˆï¼Œå¯„ä»¶åœ°å€ä¸å‚ä¸)</span>
            <div class="flex flex-wrap items-center gap-2">
                <div class="flex items-center gap-1">
                    <select id="categorySelect" class="border p-1 rounded text-sm">
                        <option value="">-- è¯·é€‰æ‹©è®°å•ç±»åˆ« --</option>
                        <option value="ã€å¼€ç­å·²å®Œæˆã€‘@">ã€å¼€ç­å·²å®Œæˆã€‘@</option>
                        <option value="ã€å¼€ç­æœªå®Œæˆã€‘@">ã€å¼€ç­æœªå®Œæˆã€‘@</option>
                        <option value="ã€å”®åã€‘@">ã€å”®åã€‘@</option>
                        <option value="ã€ç£å­¦å›è®¿ã€‘@">ã€ç£å­¦å›è®¿ã€‘@</option>
                        <option value="è‡ªå®šä¹‰">âœ¨ è‡ªå®šä¹‰</option>
                    </select>
                    <input type="text" id="categoryCustom" placeholder="è¾“å…¥ç±»åˆ«" class="border p-1 rounded text-sm w-28 hidden" value="">
                </div>
                <div class="flex items-center gap-1">
                    <select id="modeSelect" class="border p-1 rounded text-sm">
                        <option value="å°æ‰‹æœºå¼€ç­">å°æ‰‹æœºå¼€ç­</option>
                        <option value="å¾®ä¿¡å¼€ç­">å¾®ä¿¡å¼€ç­</option>
                        <option value="è¯­éŸ³å¼€ç­">è¯­éŸ³å¼€ç­</option>
                        <option value="è‡ªå®šä¹‰">âœ¨ è‡ªå®šä¹‰</option>
                    </select>
                    <input type="text" id="modeCustom" placeholder="è¾“å…¥æ¨¡å¼" class="border p-1 rounded text-sm w-28 hidden" value="">
                </div>
                <div class="flex items-center gap-1">
                    <select id="projectSelect" class="border p-1 rounded text-sm">
                        <option value="">-- é¡¹ç›®ç±»åˆ« --</option>
                        <option value="å•ç¬”è¯•">å•ç¬”è¯•</option>
                        <option value="ç¬”è¯•+å¤è¯•">ç¬”è¯•+å¤è¯•</option>
                        <option value="ç¬”é¢è”æŠ¥">ç¬”é¢è”æŠ¥</option>
                        <option value="åŒè€ƒæœŸ">åŒè€ƒæœŸ</option>
                        <option value="è‡ªå®šä¹‰">âœ¨ è‡ªå®šä¹‰</option>
                    </select>
                    <input type="text" id="projectCustom" placeholder="è¾“å…¥é¡¹ç›®ç±»åˆ«" class="border p-1 rounded text-sm w-28 hidden" value="">
                </div>
                <select id="phraseSelect" class="border p-1 rounded text-sm w-44">
                    <option value="">é€‰æ‹©è®°å•è¯æœ¯</option>
                </select>
            </div>
        </div>
        <textarea id="memoPanel" rows="23" class="w-full border rounded p-2 font-mono text-sm" placeholder="è®°å•å†…å®¹å®æ—¶é¢„è§ˆ (ä¸å«å¯„ä»¶åœ°å€)"></textarea>
    </div>
</div>

<!-- ç™»å½•æ¨¡æ€æ¡† -->
<div id="loginModal" class="fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center hidden">
    <div class="bg-white p-6 rounded shadow-lg w-96">
        <h3 class="text-lg font-bold mb-4">ç™»å½• (å‘˜å·¥è¡¨ï¼Œéœ€å¯ç”¨è´¦å·)</h3>
        <input id="loginUser" type="text" placeholder="è´¦å·" class="w-full border p-2 mb-2 rounded" value="ç®¡ç†å‘˜">
        <input id="loginPass" type="password" placeholder="å¯†ç " class="w-full border p-2 mb-4 rounded" value="2026">
        <div class="flex justify-end space-x-2">
            <button id="closeLoginModal" class="px-4 py-2 bg-gray-300 rounded">å–æ¶ˆ</button>
            <button id="loginBtn" class="px-4 py-2 bg-blue-600 text-white rounded">ç™»å½•</button>
        </div>
    </div>
</div>

<script>
(function() {
    // ---------- CouchDB é…ç½® ----------
    const COUCHDB_URL = 'http://satoko:1793364876@192.168.5.4:5984'; // è¯·æ ¹æ®å®é™…éƒ¨ç½²ä¿®æ”¹

    // ---------- æ•°æ®åº“å·¥å‚ ----------
    const createDB = (name) => {
        const localDB = new PouchDB(name);
        if (COUCHDB_URL) {
            const remoteDB = new PouchDB(`${COUCHDB_URL}/${name}`);
            localDB.sync(remoteDB, { live: true, retry: true })
                .on('error', console.warn);
        }
        return localDB;
    };

    // æ‰€æœ‰æ•°æ®åº“å®ä¾‹
    const dbStudents = createDB('students');
    const dbInvoices = createDB('invoices');
    const dbMailings = createDB('mailings');
    const dbProject = createDB('project_category');
    const dbPhrase = createDB('memo_phrase');
    const dbEmployees = createDB('employees');

    // ---------- é»˜è®¤æ•°æ® (ä»…åœ¨æ•°æ®åº“ä¸ºç©ºæ—¶å¡«å……) ----------
    const defaultEmployees = [
        { _id: 'emp_admin', è´¦å·:'ç®¡ç†å‘˜', å¯†ç :'2026', é‚®ç®±:'admin@example.com', æ˜¯å¦å¯ç”¨è¯¥è´¦å·:'æ˜¯', å¤‡æ³¨:'åœ¨èŒ' },
        { _id: 'emp_lisan', è´¦å·:'æè€å¸ˆ', å¯†ç :'2025', é‚®ç®±:'lisan@example.com', æ˜¯å¦å¯ç”¨è¯¥è´¦å·:'æ˜¯', å¤‡æ³¨:'åœ¨èŒ' },
        { _id: 'emp_little', è´¦å·:'å°å°è€å¸ˆ', å¯†ç :'2025', é‚®ç®±:'xiaoxiao@example.com', æ˜¯å¦å¯ç”¨è¯¥è´¦å·:'æ˜¯', å¤‡æ³¨:'åœ¨èŒ' },
        { _id: 'emp_wang', è´¦å·:'ç‹è€å¸ˆ', å¯†ç :'2025', é‚®ç®±:'wang@example.com', æ˜¯å¦å¯ç”¨è¯¥è´¦å·:'å¦', å¤‡æ³¨:'ç¦»èŒ' }
    ];
    const defaultProject = [
        { _id: 'proj_1', æŠ¥è¯»é¡¹ç›®ç±»åˆ«:'å•ç¬”è¯•', é¡¹ç›®1:'ã€Šç®¡ç†ç±»è”è€ƒç¬”è¯•ã€‹VIPå®šåˆ¶ç›´é€šç­ï¼ˆæ´»åŠ¨ç‰¹ä¾›ç­ï¼‰2025', é¡¹ç›®2:'ã€Šç®¡ç†ç±»è”è€ƒç¬”è¯•ã€‹VIPæ— å¿§ç­ï¼ˆ2026ï¼‰', é¡¹ç›®3:'ã€Šç®¡ç†ç±»è”è€ƒç¬”è¯•ã€‹VIPèè‹±ç­2025' },
        { _id: 'proj_2', æŠ¥è¯»é¡¹ç›®ç±»åˆ«:'ç¬”è¯•+å¤è¯•', é¡¹ç›®1:'ã€Šç®¡ç†ç±»è”è€ƒç¬”è¯•+å¤è¯•ã€‹VIPåæ ¡åè®®ç­2026', é¡¹ç›®2:'', é¡¹ç›®3:'' },
        { _id: 'proj_3', æŠ¥è¯»é¡¹ç›®ç±»åˆ«:'ç¬”é¢è”æŠ¥', é¡¹ç›®1:'ã€Šç®¡ç†ç±»è”è€ƒç¬”é¢è”æŠ¥ã€‹VIPå®šåˆ¶æ— å¿§ç­2026', é¡¹ç›®2:'', é¡¹ç›®3:'' },
        { _id: 'proj_4', æŠ¥è¯»é¡¹ç›®ç±»åˆ«:'åŒè€ƒæœŸ', é¡¹ç›®1:'ã€Šç®¡ç†ç±»è”è€ƒç¬”è¯•ã€‹VIPå®šåˆ¶ç›´é€šç­ï¼ˆå…¨å›½ï¼‰2025+2026', é¡¹ç›®2:'', é¡¹ç›®3:'' }
    ];
    const defaultPhrase = [
        { _id: 'phrase_1', åºå·:1, å¿«æ·æ ‡ç­¾:'è‡ªå®šä¹‰', è®°å•å†…å®¹:'@è‡ªå®šä¹‰å†…å®¹' },
        { _id: 'phrase_2', åºå·:2, å¿«æ·æ ‡ç­¾:'æé†’å¼€å­¦å…¸ç¤¼', è®°å•å†…å®¹:'@å¾®ä¿¡å·¦ä¸‹è§’ã€æ¶ˆæ¯ã€‘æ å¼¹å‡ºçš„é‚€è¯·é€šçŸ¥â€¦â€¦@è¯¾ç¨‹å­¦ä¹ éƒ½æ˜¯åœ¨å¾®ä¿¡å…¬ä¼—å·å’Œç½‘é¡µä¸Šé¢è¿›è¡Œâ€¦â€¦@å¼€å­¦å…¸ç¤¼å®‰æ’åœ¨6æœˆ27å·â€¦â€¦@å·¥ä½œæ—¶é—´ä¸Šåˆ10-æ™šä¸Š7ç‚¹' }
    ];

    function initDB() {
        dbEmployees.allDocs({ include_docs: true }).then(res => { if (res.rows.length === 0) defaultEmployees.forEach(emp => dbEmployees.put(emp)); });
        dbProject.allDocs({ include_docs: true }).then(res => { if (res.rows.length === 0) defaultProject.forEach(p => dbProject.put(p)); });
        dbPhrase.allDocs({ include_docs: true }).then(res => { if (res.rows.length === 0) defaultPhrase.forEach(p => dbPhrase.put(p)); });
    }
    initDB();

    // ---------- ç™»å½•çŠ¶æ€ç®¡ç† ----------
    const ADMIN_ACCOUNT = 'ç®¡ç†å‘˜';
    const ADMIN_PASSWORD = '2026';
    let currentUser = JSON.parse(sessionStorage.getItem('currentUser')) || null;
    const userDisplay = document.getElementById('userDisplay');
    const currentUserName = document.getElementById('currentUserName');
    const showLoginBtn = document.getElementById('showLoginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const loginModal = document.getElementById('loginModal');

    function updateLoginUI() {
        if (currentUser) {
            userDisplay.classList.remove('hidden');
            currentUserName.innerText = currentUser.è´¦å· || '';
            showLoginBtn.classList.add('hidden');
            logoutBtn.classList.remove('hidden');
        } else {
            userDisplay.classList.add('hidden');
            showLoginBtn.classList.remove('hidden');
            logoutBtn.classList.add('hidden');
        }
    }
    updateLoginUI();

    function requireLogin() {
        if (!currentUser) {
            alert('è¯·å…ˆç™»å½•');
            loginModal.classList.remove('hidden');
            return false;
        }
        return true;
    }

    document.getElementById('showLoginBtn').addEventListener('click', () => { loginModal.classList.remove('hidden'); });
    document.getElementById('closeLoginModal').addEventListener('click', () => { loginModal.classList.add('hidden'); });
    document.getElementById('loginBtn').addEventListener('click', () => {
        const acc = document.getElementById('loginUser').value;
        const pwd = document.getElementById('loginPass').value;

        // ç®¡ç†å‘˜ç¡¬ç¼–ç 
        if (acc === ADMIN_ACCOUNT && pwd === ADMIN_PASSWORD) {
            currentUser = { è´¦å·: ADMIN_ACCOUNT, æ˜¯å¦å¯ç”¨è¯¥è´¦å·: 'æ˜¯' };
            sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
            updateLoginUI();
            loginModal.classList.add('hidden');
            return;
        }

        // æ™®é€šå‘˜å·¥
        dbEmployees.allDocs({ include_docs: true }).then(res => {
            const users = res.rows.map(r => r.doc);
            const found = users.find(u => u.è´¦å· === acc && u.å¯†ç  === pwd && u.æ˜¯å¦å¯ç”¨è¯¥è´¦å· === 'æ˜¯');
            if (found) {
                currentUser = found;
                sessionStorage.setItem('currentUser', JSON.stringify(found));
                updateLoginUI();
                loginModal.classList.add('hidden');
            } else { alert('ç™»å½•å¤±è´¥ï¼šè´¦å·/å¯†ç é”™è¯¯æˆ–è´¦å·æœªå¯ç”¨'); }
        });
    });
    document.getElementById('logoutBtn').addEventListener('click', () => {
        currentUser = null; sessionStorage.removeItem('currentUser'); updateLoginUI();
    });

    // ---------- ä»¥ä¸‹ä¸ºåŸæœ‰è‡ªåŠ¨è®°å•é€»è¾‘ï¼Œä¿æŒä¸å˜ ----------
    // çœä»½å…³é”®è¯åˆ—è¡¨ (ç”¨äºæå–çœä»½)
    const PROVINCE_KEYWORDS = [
        'åŒ—äº¬', 'å¤©æ´¥', 'ä¸Šæµ·', 'é‡åº†',
        'æ²³åŒ—', 'å±±è¥¿', 'è¾½å®', 'å‰æ—', 'é»‘é¾™æ±Ÿ',
        'æ±Ÿè‹', 'æµ™æ±Ÿ', 'å®‰å¾½', 'ç¦å»º', 'æ±Ÿè¥¿', 'å±±ä¸œ',
        'æ²³å—', 'æ¹–åŒ—', 'æ¹–å—', 'å¹¿ä¸œ', 'æµ·å—',
        'å››å·', 'è´µå·', 'äº‘å—', 'é™•è¥¿', 'ç”˜è‚ƒ', 'é’æµ·', 'å°æ¹¾',
        'å†…è’™å¤', 'å¹¿è¥¿', 'è¥¿è—', 'å®å¤', 'æ–°ç–†',
        'é¦™æ¸¯', 'æ¾³é—¨'
    ];
    function extractProvince(str) {
        if (!str) return '';
        for (let kw of PROVINCE_KEYWORDS) {
            if (str.includes(kw)) {
                return kw;
            }
        }
        return '';
    }

    // ä»ç¤¾ä¿åŸå¸‚å­—ç¬¦ä¸²ä¸­æ‹†åˆ†çœä»½å’ŒåŸå¸‚
    function splitSocialCity(socialCity) {
        if (!socialCity) return { province: '', city: socialCity };
        const province = extractProvince(socialCity);
        if (province) {
            let city = socialCity.replace(province, '').trim();
            if (!city) city = province;
            return { province, city };
        }
        return { province: '', city: socialCity };
    }

    function extractProvinceFromSchool(school) {
        return extractProvince(school);
    }

    // å­—æ®µå®šä¹‰
    const FIELD_MAPPING = [
        { id: 'field_name', label: 'å§“å', required: true },
        { id: 'field_mobile', label: 'æ‰‹æœºå·', required: true },
        { id: 'field_className', label: 'ç­å‹', required: true },
        { id: 'field_domicile', label: 'æˆ·ç±', required: true },
        { id: 'field_workCity', label: 'å·¥ä½œå’Œç”Ÿæ´»åŸå¸‚', required: false },
        { id: 'field_socialCity', label: 'ç¤¾ä¿åŸå¸‚', required: true },
        { id: 'field_socialDuration', label: 'ç¤¾ä¿æ—¶é•¿', required: false },
        { id: 'field_targetSchool', label: 'æ„å‘é™¢æ ¡', required: true },
        { id: 'field_targetMajor', label: 'æ„å‘ä¸“ä¸š', required: true },
        { id: 'field_studyCity', label: 'æ„å‘å­¦ä¹ åŸå¸‚', required: true },
        { id: 'field_highestEdu', label: 'æœ€é«˜å­¦å†', required: true },
        { id: 'field_graduationYear', label: 'æ¯•ä¸šæ—¶é—´', required: true },
        { id: 'field_certOriginal', label: 'æ¯•ä¸šè¯åŸä»¶æ˜¯å¦åœ¨', required: false },
        { id: 'field_email', label: 'é‚®ç®±å·ç ', required: true },
        { id: 'field_isMobileCommon', label: 'æ˜¯å¦å¸¸ç”¨æ‰‹æœº', required: false },
        { id: 'field_otherMobile', label: 'å…¶ä»–æ‰‹æœºå·', required: false },
        { id: 'field_wechat', label: 'å¾®ä¿¡å·', required: false },
        { id: 'field_otherEdu', label: 'å…¶ä»–å­¦å†', required: false },
        { id: 'field_otherEduDate', label: 'å…¶ä»–å­¦å†è·å–æ—¶é—´', required: false }
    ];
    const IGNORE_FIELDS = ['field_mailingAddress'];

    // éªŒè¯å‡½æ•°
    function validateField(id, value) {
        if (id === 'field_mobile') {
            return /^\d{11}$/.test(value);
        }
        if (id === 'field_graduationYear' || id === 'field_otherEduDate') {
            return value === '' || /^\d{4}å¹´(\d{1,2}æœˆ)?$/.test(value);
        }
        if (id === 'field_email') {
            return value === '' || /^\S+@\S+\.\S+$/.test(value);
        }
        return true;
    }

    // ç²‰çº¢æé†’ï¼šæ„å‘å­¦ä¹ åŸå¸‚çœä»½ä¸æ„å‘é™¢æ ¡çœä»½ä¸ä¸€è‡´
    function checkStudyCityConsistency() {
        const studyCity = document.getElementById('field_studyCity').value;
        const targetSchool = document.getElementById('field_targetSchool').value;
        const studyInput = document.getElementById('field_studyCity');
        if (!studyCity || !targetSchool) {
            studyInput.classList.remove('warning-pink');
            return;
        }
        const studyProv = extractProvince(studyCity);
        const schoolProv = extractProvinceFromSchool(targetSchool);
        if (studyProv && schoolProv && studyProv !== schoolProv) {
            studyInput.classList.add('warning-pink');
        } else {
            studyInput.classList.remove('warning-pink');
        }
    }

    // æ ¼å¼åŒ–æ¯•ä¸šæ—¶é—´
    function formatGraduationField(input) {
        if (!input) return;
        let val = input.value.trim();
        if (/^\d{4}$/.test(val)) {
            input.value = val + 'å¹´';
        }
    }

    // å®æ—¶éªŒè¯+æ ¼å¼åŒ–
    function attachValidation() {
        FIELD_MAPPING.forEach(f => {
            const input = document.getElementById(f.id);
            if (!input) return;
            input.addEventListener('input', function() {
                const errId = `error_${f.id.replace('field_','')}`;
                const errEl = document.getElementById(errId);
                if (errEl) errEl.style.display = 'none';
                this.classList.remove('field-error');
                if (f.id === 'field_studyCity' || f.id === 'field_targetSchool') checkStudyCityConsistency();
            });
            input.addEventListener('blur', function() {
                if (f.id === 'field_graduationYear' || f.id === 'field_otherEduDate') {
                    formatGraduationField(this);
                }
                const val = this.value.trim();
                if (val && !validateField(f.id, val)) {
                    const errId = `error_${f.id.replace('field_','')}`;
                    const errEl = document.getElementById(errId);
                    if (errEl) errEl.style.display = 'block';
                    this.classList.add('field-error');
                } else {
                    const errId = `error_${f.id.replace('field_','')}`;
                    const errEl = document.getElementById(errId);
                    if (errEl) errEl.style.display = 'none';
                    this.classList.remove('field-error');
                }
            });
        });
        document.getElementById('field_targetSchool').addEventListener('input', checkStudyCityConsistency);
        document.getElementById('field_studyCity').addEventListener('input', checkStudyCityConsistency);
    }

    // è§£æå‡½æ•°
    function parseGraduationYear(text) {
        let match = text.match(/æ¯•ä¸šæ—¶é—´[ï¼š:]\s*(\d{4})å¹´(\d{1,2})æœˆ/i);
        if (match) return match[1] + 'å¹´' + match[2] + 'æœˆ';
        match = text.match(/æ¯•ä¸šæ—¶é—´[ï¼š:]\s*(\d{4})å¹´/i);
        if (match) return match[1] + 'å¹´';
        match = text.match(/æ¯•ä¸šæ—¶é—´[ï¼š:]\s*(\d{4})/i);
        if (match) return match[1] + 'å¹´';
        match = text.match(/\b(19|20)\d{2}\b/);
        if (match) return match[0] + 'å¹´';
        return '';
    }
    function parseOtherEduDate(text) {
        let match = text.match(/å…¶ä»–å­¦å†è·å–æ—¶é—´[ï¼š:]\s*(\d{4})å¹´(\d{1,2})æœˆ/i);
        if (match) return match[1] + 'å¹´' + match[2] + 'æœˆ';
        match = text.match(/å…¶ä»–å­¦å†è·å–æ—¶é—´[ï¼š:]\s*(\d{4})å¹´/i);
        if (match) return match[1] + 'å¹´';
        match = text.match(/å…¶ä»–å­¦å†è·å–æ—¶é—´[ï¼š:]\s*(\d{4})/i);
        if (match) return match[1] + 'å¹´';
        return '';
    }
    function parseOtherEdu(text) {
        const match = text.match(/å…¶ä»–å­¦å†[ï¼š:]\s*([^\n\r]+)/i);
        return match ? match[1].trim() : '';
    }
    function parseRawText(text) {
        const result = {};
        const nameMatch = text.match(/å§“å[ï¼š:]\s*([^\n\r]+)/i);
        if (nameMatch) result.name = nameMatch[1].trim();
        const mobileMatch = text.match(/(æ‰‹æœº|ç”µè¯|å·ç )[ï¼š:]\s*(1[3-9]\d{9})/i) || text.match(/\b(1[3-9]\d{9})\b/);
        if (mobileMatch) result.mobile = mobileMatch[2] || mobileMatch[1];
        const schoolMatch = text.match(/æŠ¥è€ƒé™¢æ ¡[ï¼š:]\s*([^\n\r]+)/i) || text.match(/æ„å‘é™¢æ ¡[ï¼š:]\s*([^\n\r]+)/i);
        if (schoolMatch) result.targetSchool = schoolMatch[1].trim();
        const majorMatch = text.match(/æŠ¥è€ƒä¸“ä¸š[ï¼š:]\s*([^\n\r]+)/i) || text.match(/ä¸“ä¸š[ï¼š:]\s*([^\n\r]+)/i);
        if (majorMatch) result.targetMajor = majorMatch[1].trim();
        const eduMatch = text.match(/æœ€é«˜å­¦å†[ï¼š:]\s*([^\n\r]+)/i);
        if (eduMatch) result.highestEdu = eduMatch[1].trim();
        const gradYear = parseGraduationYear(text);
        if (gradYear) result.graduationYear = gradYear;
        const emailMatch = text.match(/\b([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})\b/);
        if (emailMatch) result.email = emailMatch[1];
        const addrMatch = text.match(/åœ°å€[ï¼š:]\s*([^\n\r]+)/i);
        if (addrMatch) result.mailingAddress = addrMatch[1].trim();
        const wechatMatch = text.match(/å¾®ä¿¡å·[ï¼š:]\s*([^\n\r]+)/i) || text.match(/å¾®ä¿¡[ï¼š:]\s*([^\n\r]+)/i);
        if (wechatMatch) result.wechat = wechatMatch[1].trim();
        const workCityMatch = text.match(/å·¥ä½œ[ä¸ç”Ÿæ´»]*åŸå¸‚[ï¼š:]\s*([^\n\r]+)/i);
        if (workCityMatch) result.workCity = workCityMatch[1].trim();
        const otherEduDate = parseOtherEduDate(text);
        if (otherEduDate) result.otherEduDate = otherEduDate;
        const otherEdu = parseOtherEdu(text);
        if (otherEdu) result.otherEdu = otherEdu;
        return result;
    }

    function fillForm(data) {
        document.getElementById('field_name').value = data.name || '';
        document.getElementById('field_mobile').value = data.mobile || '';
        document.getElementById('field_targetSchool').value = data.targetSchool || '';
        document.getElementById('field_targetMajor').value = data.targetMajor || '';
        document.getElementById('field_highestEdu').value = data.highestEdu || '';
        document.getElementById('field_graduationYear').value = data.graduationYear || '';
        document.getElementById('field_email').value = data.email || '';
        document.getElementById('field_mailingAddress').value = data.mailingAddress || '';
        document.getElementById('field_wechat').value = data.wechat || '';
        document.getElementById('field_workCity').value = data.workCity || '';
        document.getElementById('field_otherEduDate').value = data.otherEduDate || '';
        document.getElementById('field_otherEdu').value = data.otherEdu || '';
    }

    // æŸ¥æ‰¾å­¦å‘˜
    async function findStudentByNameMobile(name, mobile) {
        if (!name || !mobile) return null;
        const result = await dbStudents.allDocs({ include_docs: true });
        return result.rows.map(r => r.doc).find(d => d.å­¦å‘˜å§“å === name && d.å­¦å‘˜æŠ¥åæ‰‹æœºå· === mobile) || null;
    }

    // ä»ç­å‹çŒœæµ‹é¡¹ç›®ç±»åˆ«
    async function guessProjectCategory(className) {
        if (!className) return '';
        try {
            const res = await dbProject.allDocs({ include_docs: true });
            const projects = res.rows.map(r => r.doc);
            for (let p of projects) {
                const category = p.æŠ¥è¯»é¡¹ç›®ç±»åˆ«;
                for (let key of ['é¡¹ç›®1', 'é¡¹ç›®2', 'é¡¹ç›®3']) {
                    if (p[key] && className.includes(p[key].substring(0, 10))) return category;
                }
            }
            if (className.includes('å•ç¬”è¯•')) return 'å•ç¬”è¯•';
            if (className.includes('ç¬”è¯•+å¤è¯•')) return 'ç¬”è¯•+å¤è¯•';
            if (className.includes('ç¬”é¢è”æŠ¥')) return 'ç¬”é¢è”æŠ¥';
            if (className.includes('åŒè€ƒæœŸ')) return 'åŒè€ƒæœŸ';
            return '';
        } catch (e) { return ''; }
    }

    // å®æ—¶è”åŠ¨ç­å‹ â†’ é¡¹ç›®ç±»åˆ«
    const classNameInput = document.getElementById('field_className');
    classNameInput.addEventListener('input', async function() {
        const cat = await guessProjectCategory(this.value);
        if (cat) {
            if (['å•ç¬”è¯•','ç¬”è¯•+å¤è¯•','ç¬”é¢è”æŠ¥','åŒè€ƒæœŸ'].includes(cat)) {
                projectSelect.value = cat;
                projectCustom.classList.add('hidden');
                projectCustom.value = '';
            } else {
                projectSelect.value = 'è‡ªå®šä¹‰';
                projectCustom.classList.remove('hidden');
                projectCustom.value = cat;
            }
        } else {
            // å¦‚æœæ— æ³•åŒ¹é…ï¼Œå¯ä»¥é€‰æ‹©æ¸…ç©ºæˆ–ä¿ç•™åŸå€¼ï¼Œè¿™é‡Œä¸æ¸…ç©ºï¼Œè®©ç”¨æˆ·æ‰‹åŠ¨é€‰æ‹©
        }
        updateMemoPreview(); // æ›´æ–°é¢„è§ˆ
    });

    // ç±»åˆ«ä¸è‡ªå®šä¹‰æ˜¾ç¤º
    const categorySelect = document.getElementById('categorySelect');
    const categoryCustom = document.getElementById('categoryCustom');
    const modeSelect = document.getElementById('modeSelect');
    const modeCustom = document.getElementById('modeCustom');
    const projectSelect = document.getElementById('projectSelect');
    const projectCustom = document.getElementById('projectCustom');

    categorySelect.addEventListener('change', function() {
        if (this.value === 'è‡ªå®šä¹‰') {
            categoryCustom.classList.remove('hidden');
        } else {
            categoryCustom.classList.add('hidden');
            categoryCustom.value = '';
        }
        updateMemoPreview();
    });
    categoryCustom.addEventListener('input', updateMemoPreview);

    modeSelect.addEventListener('change', function() {
        if (this.value === 'è‡ªå®šä¹‰') {
            modeCustom.classList.remove('hidden');
        } else {
            modeCustom.classList.add('hidden');
            modeCustom.value = '';
        }
        updateMemoPreview();
    });
    modeCustom.addEventListener('input', updateMemoPreview);

    projectSelect.addEventListener('change', function() {
        if (this.value === 'è‡ªå®šä¹‰') {
            projectCustom.classList.remove('hidden');
        } else {
            projectCustom.classList.add('hidden');
            projectCustom.value = '';
        }
        updateMemoPreview();
    });
    projectCustom.addEventListener('input', updateMemoPreview);

    // è¯æœ¯ä¸‹æ‹‰åŠ è½½
    async function loadPhraseSelect() {
        const select = document.getElementById('phraseSelect');
        select.innerHTML = '<option value="">é€‰æ‹©è®°å•è¯æœ¯</option>';
        try {
            const res = await dbPhrase.allDocs({ include_docs: true });
            const phrases = res.rows.map(r => r.doc).sort((a,b) => (a.åºå·||0) - (b.åºå·||0));
            phrases.forEach(p => {
                if (p.å¿«æ·æ ‡ç­¾ && p.è®°å•å†…å®¹) {
                    const opt = document.createElement('option');
                    opt.value = p.è®°å•å†…å®¹;
                    opt.textContent = p.å¿«æ·æ ‡ç­¾;
                    select.appendChild(opt);
                }
            });
        } catch (e) {}
    }
    loadPhraseSelect();

    // å®æ—¶é¢„è§ˆ
    function generateMemo() {
        let category = categorySelect.value;
        if (category === 'è‡ªå®šä¹‰') category = categoryCustom.value.trim();
        else if (category === '') category = '';

        let mode = '';
        if (modeSelect.value === 'è‡ªå®šä¹‰') {
            mode = modeCustom.value.trim();
        } else {
            mode = modeSelect.value;
        }
        const modeWithAt = mode ? (mode + '@') : '';

        let project = '';
        if (projectSelect.value === 'è‡ªå®šä¹‰') {
            project = projectCustom.value.trim();
        } else if (projectSelect.value) {
            project = projectSelect.value;
        }

        let fieldLines = [];
        for (let f of FIELD_MAPPING) {
            if (IGNORE_FIELDS.includes(f.id)) continue;
            const input = document.getElementById(f.id);
            let val = '';
            if (input.tagName === 'SELECT') {
                val = input.options[input.selectedIndex]?.value || '';
            } else {
                val = input.value.trim();
            }
            if (val !== '') {
                fieldLines.push(`@${f.label}ï¼š${val}`);
            }
        }

        const phraseSelect = document.getElementById('phraseSelect');
        const phraseContent = phraseSelect.value;

        let memo = '';
        if (category) memo += category;
        if (modeWithAt) memo += modeWithAt;
        if (project) memo += project;
        if (fieldLines.length) {
            if (memo) memo += '\n';
            memo += fieldLines.join('\n');
        }
        if (phraseContent) {
            if (memo) memo += '\n';
            memo += phraseContent;
        }
        return memo;
    }

    function updateMemoPreview() {
        document.getElementById('memoPanel').value = generateMemo();
    }

    const allInputs = [
        ...FIELD_MAPPING.map(f => document.getElementById(f.id)),
        categorySelect, categoryCustom,
        modeSelect, modeCustom,
        projectSelect, projectCustom,
        document.getElementById('phraseSelect'),
    ].filter(el => el);
    allInputs.forEach(el => {
        if (el) {
            el.addEventListener('input', updateMemoPreview);
            el.addEventListener('change', updateMemoPreview);
        }
    });

    // è§£ææŒ‰é’®
    document.getElementById('parseBtn').addEventListener('click', async () => {
        if (!requireLogin()) return;
        const raw = document.getElementById('rawInput').value;
        const parsed = parseRawText(raw);
        fillForm(parsed);
        if (parsed.name && parsed.mobile) {
            const exist = await findStudentByNameMobile(parsed.name, parsed.mobile);
            if (exist) {
                alert('æ£€æµ‹åˆ°å·²æœ‰å­¦å‘˜è®°å½•ï¼Œå·²è‡ªåŠ¨å¡«å……å…¶å…¨éƒ¨ä¿¡æ¯');
                document.getElementById('field_className').value = exist.æ‰€æŠ¥ç­å‹ || '';
                document.getElementById('field_domicile').value = exist.æˆ·ç±æ‰€åœ¨åœ° || '';
                document.getElementById('field_socialCity').value = exist.è´­ä¹°ç¤¾ä¿åŸå¸‚ || '';
                document.getElementById('field_socialDuration').value = exist.è´­ä¹°ç¤¾ä¿æ—¶é•¿ || '';
                document.getElementById('field_targetMajor').value = exist.æ„å‘ä¸“ä¸š || '';
                document.getElementById('field_highestEdu').value = exist.æœ€é«˜å­¦å† || '';
                document.getElementById('field_graduationYear').value = exist.æ¯•ä¸šå¹´ä»½ || '';
                document.getElementById('field_email').value = exist.é‚®ç®± || '';
                document.getElementById('field_wechat').value = exist.å¾®ä¿¡å· || '';
                document.getElementById('field_workCity').value = exist.å·¥ä½œç”Ÿæ´»åŸå¸‚ || '';
                document.getElementById('field_mailingAddress').value = exist.é‚®å¯„åœ°å€ || '';
                document.getElementById('field_otherMobile').value = exist.å…¶ä»–æ‰‹æœºå· || '';
                document.getElementById('field_isMobileCommon').value = exist.æ˜¯å¦å¸¸ç”¨æ‰‹æœº || '';
                document.getElementById('field_certOriginal').value = exist.æ¯•ä¸šè¯åŸä»¶æ˜¯å¦åœ¨ || '';
                document.getElementById('field_otherEdu').value = exist.å…¶ä»–å­¦å† || '';
                document.getElementById('field_otherEduDate').value = exist.å…¶ä»–å­¦å†è·å–æ—¶é—´ || '';
            }
        }
        const className = document.getElementById('field_className').value;
        const cat = await guessProjectCategory(className);
        if (cat) {
            if (['å•ç¬”è¯•','ç¬”è¯•+å¤è¯•','ç¬”é¢è”æŠ¥','åŒè€ƒæœŸ'].includes(cat)) {
                projectSelect.value = cat;
                projectCustom.classList.add('hidden');
                projectCustom.value = '';
            } else {
                projectSelect.value = 'è‡ªå®šä¹‰';
                projectCustom.classList.remove('hidden');
                projectCustom.value = cat;
            }
        }
        updateMemoPreview();
    });

    // é‡ç½®æŒ‰é’®
    document.getElementById('resetBtn').addEventListener('click', () => {
        if (!requireLogin()) return;
        document.getElementById('rawInput').value = '';
        FIELD_MAPPING.forEach(f => document.getElementById(f.id).value = '');
        IGNORE_FIELDS.forEach(id => document.getElementById(id).value = '');
        categorySelect.value = '';
        categoryCustom.classList.add('hidden'); categoryCustom.value = '';
        modeSelect.value = 'å°æ‰‹æœºå¼€ç­';
        modeCustom.classList.add('hidden'); modeCustom.value = '';
        projectSelect.value = '';
        projectCustom.classList.add('hidden'); projectCustom.value = '';
        document.getElementById('phraseSelect').value = '';
        updateMemoPreview();
        document.querySelectorAll('.field-error').forEach(e => e.classList.remove('field-error'));
        document.querySelectorAll('.error-tip').forEach(e => e.style.display = 'none');
    });

    // ä¿å­˜ & å½•å…¥ï¼ˆå¢åŠ äº†è®°å•ç±»åˆ«å¿…é€‰æ£€æŸ¥ï¼‰
    document.getElementById('saveAndNoteBtn').addEventListener('click', async () => {
        if (!requireLogin()) return;

        // æ£€æŸ¥è®°å•ç±»åˆ«æ˜¯å¦å·²é€‰æ‹©
        let categoryChosen = false;
        if (categorySelect.value === 'è‡ªå®šä¹‰') {
            if (categoryCustom.value.trim() === '') {
                alert('è¯·å¡«å†™è‡ªå®šä¹‰è®°å•ç±»åˆ«');
                return;
            } else {
                categoryChosen = true;
            }
        } else if (categorySelect.value && categorySelect.value !== '') {
            categoryChosen = true;
        }
        if (!categoryChosen) {
            alert('è¯·é€‰æ‹©è®°å•ç±»åˆ«ï¼ˆå¦‚ã€å¼€ç­å·²å®Œæˆã€‘@ï¼‰');
            return;
        }

        let missing = [];
        for (let f of FIELD_MAPPING) {
            if (f.required) {
                const input = document.getElementById(f.id);
                let val = '';
                if (input.tagName === 'SELECT') val = input.value;
                else val = input.value.trim();
                if (!val) missing.push(f.label);
            }
        }
        if (missing.length) {
            alert('ä»¥ä¸‹å¿…å¡«é¡¹ä¸èƒ½ä¸ºç©ºï¼š' + missing.join('ï¼Œ'));
            return;
        }

        let formatErrors = [];
        for (let f of FIELD_MAPPING) {
            const input = document.getElementById(f.id);
            let val = input.value.trim();
            if (val && !validateField(f.id, val)) {
                formatErrors.push(f.label);
            }
        }
        const otherDate = document.getElementById('field_otherEduDate').value.trim();
        if (otherDate && !/^\d{4}å¹´(\d{1,2}æœˆ)?$/.test(otherDate)) formatErrors.push('å…¶ä»–å­¦å†è·å–æ—¶é—´');
        if (formatErrors.length) {
            alert('ä»¥ä¸‹å­—æ®µæ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·ä¿®æ”¹ï¼š' + formatErrors.join('ï¼Œ'));
            return;
        }

        const name = document.getElementById('field_name').value.trim();
        const mobile = document.getElementById('field_mobile').value.trim();

        const existing = await findStudentByNameMobile(name, mobile);
        if (existing) {
            if (!confirm(`å­¦å‘˜â€œ${name}â€å·²å­˜åœ¨ï¼Œç¡®å®šè¦†ç›–ä¿¡æ¯ï¼Ÿ`)) return;
            await dbStudents.remove(existing);
        }

        const memo = document.getElementById('memoPanel').value;

        const socialCityRaw = document.getElementById('field_socialCity').value.trim();
        const { province: socialProvince, city: socialCity } = splitSocialCity(socialCityRaw);

        const newStudent = {
            å­¦å‘˜å§“å: name,
            å­¦å‘˜æŠ¥åæ‰‹æœºå·: mobile,
            æ‰€æŠ¥ç­å‹: document.getElementById('field_className').value,
            æˆ·ç±æ‰€åœ¨åœ°: document.getElementById('field_domicile').value,
            æ„å‘é™¢æ ¡1: document.getElementById('field_targetSchool').value,
            æ„å‘ä¸“ä¸š: document.getElementById('field_targetMajor').value,
            æœ€é«˜å­¦å†: document.getElementById('field_highestEdu').value,
            æ¯•ä¸šå¹´ä»½: document.getElementById('field_graduationYear').value,
            é‚®ç®±: document.getElementById('field_email').value,
            å¾®ä¿¡å·: document.getElementById('field_wechat').value,
            è´­ä¹°ç¤¾ä¿æ‰€åœ¨çœä»½: socialProvince,
            è´­ä¹°ç¤¾ä¿åŸå¸‚: socialCity,
            è´­ä¹°ç¤¾ä¿æ—¶é•¿: document.getElementById('field_socialDuration').value,
            æ„å‘å­¦ä¹ åŸå¸‚: document.getElementById('field_studyCity').value,
            å…¶ä»–å­¦å†: document.getElementById('field_otherEdu').value,
            å…¶ä»–å­¦å†è·å–æ—¶é—´: document.getElementById('field_otherEduDate').value,
            å·¥ä½œç”Ÿæ´»åŸå¸‚: document.getElementById('field_workCity').value,
            é‚®å¯„åœ°å€: document.getElementById('field_mailingAddress').value,
            å…¶ä»–æ‰‹æœºå·: document.getElementById('field_otherMobile').value,
            æ˜¯å¦å¸¸ç”¨æ‰‹æœº: document.getElementById('field_isMobileCommon').value,
            æ¯•ä¸šè¯åŸä»¶æ˜¯å¦åœ¨: document.getElementById('field_certOriginal').value,
            å½’å±ä¸»ä½“: 'èŒ¶ç±³æ•™è‚²',
            è€ƒæœŸ: '2025', ç­çº§: 5,
            å½’å±ç­ä¸»ä»»: currentUser ? currentUser.è´¦å· : 'æœªçŸ¥',
            è®°å•æ—¶é—´: new Date().toLocaleString(),
            æŠ¥åæ—¶é—´: '',
            _id: 'stu_' + Date.now() + '_' + Math.random().toString(36).substr(2,6),
            è®°å•ä¿¡æ¯: memo
        };

        await dbStudents.put(newStudent);

        const nowStr = new Date().toLocaleString();
        const invoiceId = 'inv_' + Date.now() + '_' + Math.random().toString(36).substr(2,4);
        const invoiceDoc = {
            _id: invoiceId,
            å½’å±ä¸»ä½“: 'èŒ¶ç±³æ•™è‚²',
            ç­ä¸»ä»»: currentUser ? currentUser.è´¦å· : 'æœªçŸ¥',
            å§“å: name,
            è”ç³»ç”µè¯: mobile,
            æŠ¥è€ƒç­å‹: newStudent.æ‰€æŠ¥ç­å‹,
        };
        await dbInvoices.put(invoiceDoc).catch(e => console.warn);

        const mailId = 'mail_' + Date.now() + '_' + Math.random().toString(36).substr(2,4);
        const mailDoc = {
            _id: mailId,
            å½’å±ä¸»ä½“: 'èŒ¶ç±³æ•™è‚²',
            ç­ä¸»ä»»: currentUser ? currentUser.è´¦å· : 'æœªçŸ¥',
            å­¦å‘˜å§“å: name,
            æ”¶ä»¶äººå·ç : mobile,
            æ”¶ä»¶äººåœ°å€: newStudent.é‚®å¯„åœ°å€ || '',
        };
        await dbMailings.put(mailDoc).catch(e => console.warn);

        alert('âœ… å·²ä¿å­˜å­¦å‘˜ï¼Œå¹¶ç”Ÿæˆå‘ç¥¨/é‚®å¯„è‰ç¨¿ï¼');
    });

    attachValidation();
    updateMemoPreview();
})();
</script>
</body>
</html>