<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¿è¥ç™»è®°å¤§è¡¨ Â· å®Œæ•´ç‰ˆï¼ˆæ— å‘˜å·¥è¡¨ï¼‰</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/pouchdb@8.0.1/dist/pouchdb.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.2/package/dist/xlsx.full.min.js"></script>
    <style>
        .table-scroll { overflow-x: auto; overflow-y: hidden; border: 1px solid #e2e8f0; border-radius: 0.375rem; margin-bottom: 0.5rem; }
        .table-scroll table { border-collapse: collapse; width: max-content; min-width: 100%; }
        .table-scroll thead { position: sticky; top: 0; background: #f7fafc; z-index: 10; box-shadow: 0 1px 2px 0 rgba(0,0,0,0.05); }
        .table-scroll th { text-align: center; font-weight: 600; background-color: #edf2f7; border: 1px solid #cbd5e0; padding: 0.5rem; font-size: 0.75rem; white-space: nowrap; }
        .table-scroll td { text-align: left; border: 1px solid #cbd5e0; padding: 0.5rem; font-size: 0.75rem; white-space: nowrap; max-width: 250px; overflow: hidden; text-overflow: ellipsis; height: 35px; line-height: 35px; padding-top: 0; padding-bottom: 0; }
        .is-select { width: 100%; border: none; background: transparent; font-size: 0.75rem; padding: 2px; border-radius: 4px; font-weight: 500; cursor: pointer; }
        .is-select-yes { background-color: #10b981; color: white; }
        .is-select-no { background-color: #ef4444; color: white; }
        .is-select option { background: white; color: black; }
        .editable-input, .editable-textarea { width: 100%; padding: 0.2rem; font-size: 0.7rem; border: 1px solid #9bb7d4; border-radius: 2px; }
        .editable-textarea { min-height: 60px; resize: vertical; }
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000; }
        .modal-content { background: white; padding: 1.5rem; border-radius: 0.5rem; width: 90%; max-width: 900px; max-height: 80vh; overflow-y: auto; }
        .pagination { display: flex; gap: 0.5rem; align-items: center; justify-content: flex-end; margin-top: 0.5rem; font-size: 0.8rem; }
        .pagination button { padding: 0.2rem 0.8rem; border: 1px solid #ccc; background: white; border-radius: 0.25rem; cursor: pointer; }
        .pagination button:disabled { opacity: 0.5; cursor: not-allowed; }
        .pagination input { width: 50px; text-align: center; border: 1px solid #ccc; border-radius: 0.25rem; }
    </style>
</head>
<body class="bg-gray-50 font-sans p-4">

<!-- å³ä¸Šè§’å¯¼èˆª (ä¸æƒé™é¡µä¿æŒä¸€è‡´) -->
<div class="max-w-7xl mx-auto mb-2 flex justify-end space-x-3 text-sm">
    <a href="autoNote.html" target="_blank" class="bg-white px-3 py-1 rounded shadow hover:bg-gray-100"><i class="fas fa-pen-fancy mr-1"></i>è‡ªåŠ¨è®°å•</a>
    <a href="masterTable.html" target="_blank" class="bg-white px-3 py-1 rounded shadow hover:bg-gray-100"><i class="fas fa-table mr-1"></i>è¿è¥ç™»è®°å¤§è¡¨</a>
    <a href="admin.html" target="_blank" class="bg-white px-3 py-1 rounded shadow hover:bg-gray-100"><i class="fas fa-lock mr-1"></i>ç®¡ç†æƒé™</a>
</div>

<!-- ç™»å½•çŠ¶æ€æ¡ + åŠŸèƒ½æ  (åˆå¹¶) -->
<div class="max-w-7xl mx-auto mb-4 flex flex-wrap items-center justify-between gap-2 bg-white p-2 rounded shadow">
    <div class="flex items-center space-x-2 text-sm">
        <span class="text-gray-600"><i class="fas fa-database mr-1 text-blue-500"></i>æœ¬åœ°PouchDB (ä¸CouchDBå®æ—¶åŒæ­¥)</span>
        <span id="userDisplay2" class="hidden ml-2">ğŸ‘¤ <span id="currentUserName2"></span></span>
    </div>
    <div class="flex flex-wrap items-center gap-2">
        <div class="relative flex items-center">
            <i class="fas fa-search absolute left-2 top-2 text-gray-400 text-xs"></i>
            <input type="text" id="searchInput" placeholder="ç­›é€‰å§“å/æ‰‹æœºå·/å…³é”®è¯" class="pl-7 pr-8 py-1 border rounded text-sm w-48">
        </div>
        <button id="fullscreenBtn" class="bg-gray-100 hover:bg-gray-200 px-2 py-1 rounded text-sm"><i class="fas fa-expand mr-1"></i>å…¨å±</button>
        <button id="exportFilteredBtn" class="bg-green-100 hover:bg-green-200 px-2 py-1 rounded text-sm"><i class="fas fa-download mr-1"></i>å¯¼å‡ºå½“å‰è§†å›¾</button>
        <button id="exportAllBtn" class="bg-purple-100 hover:bg-purple-200 px-2 py-1 rounded text-sm"><i class="fas fa-file-excel mr-1"></i>å¯¼å‡ºå…¨éƒ¨è¡¨æ ¼</button>
        <button id="importBtn" class="bg-blue-100 hover:bg-blue-200 px-2 py-1 rounded text-sm"><i class="fas fa-upload mr-1"></i>å¯¼å…¥</button>
        <button id="showLoginBtn" class="bg-blue-500 text-white px-3 py-1 rounded text-sm"><i class="fas fa-sign-in-alt mr-1"></i>ç™»å½•</button>
        <button id="logoutBtn" class="bg-gray-300 px-3 py-1 rounded text-sm hidden">é€€å‡º</button>
    </div>
</div>

<!-- å…«ä¸ªè¡¨æ ¼çš„é€‰é¡¹å¡ (æ— å‘˜å·¥è¡¨) -->
<div class="max-w-7xl mx-auto bg-white p-4 rounded shadow">
    <div class="flex flex-wrap border-b text-sm gap-1">
        <button class="tab-btn px-4 py-2 font-medium text-blue-600 border-b-2 border-blue-500" data-tab="student">ğŸ“‹ å­¦å‘˜å¤§è¡¨</button>
        <button class="tab-btn px-4 py-2 font-medium" data-tab="invoice">ğŸ§¾ å‘ç¥¨è¡¨</button>
        <button class="tab-btn px-4 py-2 font-medium" data-tab="mail">ğŸ“¦ é‚®å¯„è¡¨</button>
        <button class="tab-btn px-4 py-2 font-medium" data-tab="afterSales">ğŸ› ï¸ å”®åè¡¨</button>
        <button class="tab-btn px-4 py-2 font-medium" data-tab="project">ğŸ“ é¡¹ç›®ç±»åˆ«</button>
        <button class="tab-btn px-4 py-2 font-medium" data-tab="major">ğŸ“š ä¸“ä¸šä»£ç </button>
        <button class="tab-btn px-4 py-2 font-medium" data-tab="class">ğŸ« ç­çº§è¡¨</button>
        <button class="tab-btn px-4 py-2 font-medium" data-tab="phrase">ğŸ’¬ è®°å•è¯æœ¯</button>
    </div>

    <!-- å­¦å‘˜å¤§è¡¨ -->
    <div id="tab-student" class="tab-content block mt-2">
        <div class="flex justify-between mb-1">
            <span class="text-xs text-gray-500">å…± <span id="studentCount">0</span> è¡Œ</span>
            <button class="add-row-btn bg-indigo-50 text-indigo-700 px-3 py-0.5 rounded text-xs" data-db="students"><i class="fas fa-plus mr-1"></i>æ–°å¢ç©ºç™½è¡Œ</button>
        </div>
        <div id="studentTableContainer" class="table-scroll"></div>
        <div id="studentPagination" class="pagination"></div>
    </div>

    <!-- å‘ç¥¨è¡¨ -->
    <div id="tab-invoice" class="tab-content hidden mt-2">
        <div class="flex justify-between mb-1"><span class="text-xs text-gray-500">å…± <span id="invoiceCount">0</span> è¡Œ</span><button class="add-row-btn bg-indigo-50 text-indigo-700 px-3 py-0.5 rounded text-xs" data-db="invoices"><i class="fas fa-plus mr-1"></i>æ–°å¢ç©ºç™½è¡Œ</button></div>
        <div id="invoiceTableContainer" class="table-scroll"></div>
        <div id="invoicePagination" class="pagination"></div>
    </div>

    <!-- é‚®å¯„è¡¨ -->
    <div id="tab-mail" class="tab-content hidden mt-2">
        <div class="flex justify-between mb-1"><span class="text-xs text-gray-500">å…± <span id="mailCount">0</span> è¡Œ</span><button class="add-row-btn bg-indigo-50 text-indigo-700 px-3 py-0.5 rounded text-xs" data-db="mailings"><i class="fas fa-plus mr-1"></i>æ–°å¢ç©ºç™½è¡Œ</button></div>
        <div id="mailTableContainer" class="table-scroll"></div>
        <div id="mailPagination" class="pagination"></div>
    </div>

    <!-- å”®åè¡¨ -->
    <div id="tab-afterSales" class="tab-content hidden mt-2">
        <div class="flex justify-between mb-1"><span class="text-xs text-gray-500">å…± <span id="afterSalesCount">0</span> è¡Œ</span><button class="add-row-btn bg-indigo-50 text-indigo-700 px-3 py-0.5 rounded text-xs" data-db="after_sales"><i class="fas fa-plus mr-1"></i>æ–°å¢ç©ºç™½è¡Œ</button></div>
        <div id="afterSalesTableContainer" class="table-scroll"></div>
        <div id="afterSalesPagination" class="pagination"></div>
    </div>

    <!-- é¡¹ç›®ç±»åˆ«è¡¨ -->
    <div id="tab-project" class="tab-content hidden mt-2">
        <div class="flex justify-between mb-1"><span class="text-xs text-gray-500">å…± <span id="projectCount">0</span> è¡Œ</span><button class="add-row-btn bg-indigo-50 text-indigo-700 px-3 py-0.5 rounded text-xs" data-db="project_category"><i class="fas fa-plus mr-1"></i>æ–°å¢ç©ºç™½è¡Œ</button></div>
        <div id="projectTableContainer" class="table-scroll"></div>
        <div id="projectPagination" class="pagination"></div>
    </div>

    <!-- ä¸“ä¸šä»£ç è¡¨ -->
    <div id="tab-major" class="tab-content hidden mt-2">
        <div class="flex justify-between mb-1"><span class="text-xs text-gray-500">å…± <span id="majorCount">0</span> è¡Œ</span><button class="add-row-btn bg-indigo-50 text-indigo-700 px-3 py-0.5 rounded text-xs" data-db="major_codes"><i class="fas fa-plus mr-1"></i>æ–°å¢ç©ºç™½è¡Œ</button></div>
        <div id="majorTableContainer" class="table-scroll"></div>
        <div id="majorPagination" class="pagination"></div>
    </div>

    <!-- ç­çº§è¡¨ -->
    <div id="tab-class" class="tab-content hidden mt-2">
        <div class="flex justify-between mb-1"><span class="text-xs text-gray-500">å…± <span id="classCount">0</span> è¡Œ</span><button class="add-row-btn bg-indigo-50 text-indigo-700 px-3 py-0.5 rounded text-xs" data-db="classes"><i class="fas fa-plus mr-1"></i>æ–°å¢ç©ºç™½è¡Œ</button></div>
        <div id="classTableContainer" class="table-scroll"></div>
        <div id="classPagination" class="pagination"></div>
    </div>

    <!-- è®°å•è¯æœ¯è¡¨ -->
    <div id="tab-phrase" class="tab-content hidden mt-2">
        <div class="flex justify-between mb-1"><span class="text-xs text-gray-500">å…± <span id="phraseCount">0</span> è¡Œ</span><button class="add-row-btn bg-indigo-50 text-indigo-700 px-3 py-0.5 rounded text-xs" data-db="memo_phrase"><i class="fas fa-plus mr-1"></i>æ–°å¢ç©ºç™½è¡Œ</button></div>
        <div id="phraseTableContainer" class="table-scroll"></div>
        <div id="phrasePagination" class="pagination"></div>
    </div>
</div>

<!-- ç™»å½•æ¨¡æ€æ¡† -->
<div id="loginModal" class="modal hidden">
    <div class="modal-content max-w-md">
        <h3 class="text-lg font-bold mb-4">ç™»å½• (å‘˜å·¥è¡¨ï¼Œéœ€å¯ç”¨è´¦å·)</h3>
        <input id="loginUser" type="text" placeholder="è´¦å·" class="w-full border p-2 mb-2 rounded" value="ç®¡ç†å‘˜">
        <input id="loginPass" type="password" placeholder="å¯†ç " class="w-full border p-2 mb-4 rounded" value="2026">
        <div class="flex justify-end space-x-2">
            <button id="closeLoginModal" class="px-4 py-2 bg-gray-300 rounded">å–æ¶ˆ</button>
            <button id="loginBtn" class="px-4 py-2 bg-blue-600 text-white rounded">ç™»å½•</button>
        </div>
    </div>
</div>

<!-- è¡Œç¼–è¾‘å¼¹çª— -->
<div id="editModal" class="modal hidden">
    <div class="modal-content">
        <h3 class="text-lg font-bold mb-4" id="modalTitle">ç¼–è¾‘è¡Œæ•°æ®</h3>
        <div id="modalFields" class="grid grid-cols-2 gap-3 text-sm max-h-[60vh] overflow-y-auto"></div>
        <div class="flex justify-end space-x-2 mt-4">
            <button id="closeModalBtn" class="px-4 py-2 bg-gray-300 rounded">å–æ¶ˆ</button>
            <button id="saveModalBtn" class="px-4 py-2 bg-blue-600 text-white rounded">ä¿å­˜</button>
        </div>
    </div>
</div>

<script>
(function() {
    // ---------- CouchDB é…ç½® ----------
    const COUCHDB_URL = 'http://satoko:1793364876@192.168.5.4:5984'; // è¯·æ ¹æ®å®é™…éƒ¨ç½²ä¿®æ”¹

    // ---------- æ•°æ®åº“å·¥å‚ ----------
    const createDB = (name) => {
        const localDB = new PouchDB(name);
        if (COUCHDB_URL) {
            const remoteDB = new PouchDB(`${COUCHDB_URL}/${name}`);
            localDB.sync(remoteDB, { live: true, retry: true })
                .on('error', console.warn);
        }
        return localDB;
    };

    // ---------- PouchDB å®ä¾‹ ----------
    const dbStudents = createDB('students');
    const dbInvoices = createDB('invoices');
    const dbMailings = createDB('mailings');
    const dbAfterSales = createDB('after_sales');
    const dbProject = createDB('project_category');
    const dbMajor = createDB('major_codes');
    const dbClasses = createDB('classes');
    const dbPhrase = createDB('memo_phrase');
    const dbEmployees = createDB('employees'); // ä»…ç”¨äºç™»å½•éªŒè¯

    // ---------- è¡¨å¤´å®šä¹‰ ----------
    const studentHeaders = ["å½’å±ä¸»ä½“","è€ƒæœŸ","ç­çº§","æ˜¯å¦æ·»åŠ å¾®ä¿¡","æ˜¯å¦å‘é€æ–°ç”Ÿèµ„æ–™","æ˜¯å¦å‘é€æ‘¸åº•è€ƒè¯•","å½’å±åˆä½œæ–¹","è·Ÿè¿›äºº","å½’å±ç­ä¸»ä»»","è®°å•æ—¶é—´","æŠ¥åæ—¶é—´","å­¦å‘˜æŠ¥åæ‰‹æœºå·","å…¶ä»–æ‰‹æœºå·ï¼ˆéå¿…å¡«é¡¹ï¼‰","å­¦å‘˜å§“å","èº«ä»½è¯å·","APPè´¦å·","APPå¯†ç ","èŒä¸š","è®¢å•é‡‘é¢","é¡¹ç›®","æ‰€æŠ¥ç­å‹","æ„å‘é™¢æ ¡ï¼‘","æ„å‘é™¢æ ¡2ï¼ˆé€‰å¡«ï¼‰","æ„å‘é™¢æ ¡3ï¼ˆé€‰å¡«ï¼‰","æ„å‘ä¸“ä¸š","æœ€é«˜å­¦å†","æ¯•ä¸šå¹´ä»½","å…¶ä»–å­¦å†ï¼ˆéå¿…å¡«é¡¹ï¼‰","å…¶ä»–å­¦å†è·å–æ—¶é—´ï¼ˆéå¿…å¡«é¡¹ï¼‰","æˆ·ç±æ‰€åœ¨åœ°","è´­ä¹°ç¤¾ä¿æ‰€åœ¨çœä»½","è´­ä¹°ç¤¾ä¿åŸå¸‚","è´­ä¹°ç¤¾ä¿æ—¶é•¿","æ„å‘å­¦ä¹ åŸå¸‚","é‚®ç®±","å¾®ä¿¡å·","è®°å•ä¿¡æ¯","å¤‡æ³¨","æ˜¯å¦å”®åå­¦å‘˜"];
    const invoiceHeaders = ["å½’å±ä¸»ä½“","ç­ä¸»ä»»","å§“å","è”ç³»ç”µè¯","èº«ä»½è¯å·","æŠ¥è€ƒç­å‹","æ‹›ç”Ÿéƒ¨é—¨","*å‘ç¥¨ç±»å‹","*å¼€ç¥¨ä¸»ä½“ï¼ˆä¸å¡«ï¼‰","*å¼€ç¥¨é‡‘é¢","*å‘ç¥¨æŠ¬å¤´ï¼ˆä¸ªäººåˆ™å¡«å§“åï¼‰","*çº³ç¨äººè¯†åˆ«å·ï¼ˆä¸ªäººåˆ™å¡«èº«ä»½è¯å·ï¼‰","å…¬å¸åœ°å€åŠç”µè¯","å¼€æˆ·è¡ŒåŠè´¦å·","*æ”¶æ®å·ç ","æ˜¯å¦éœ€è¦å¼€å…·å‘ç¥¨","ç”³è¯·äºº","ç”³è¯·æ—¶é—´","å¤‡æ³¨","å¼€ç¥¨äºº","å‘ç¥¨å·","å¼€ç¥¨æ—¶é—´","å‘ç¥¨é“¾æ¥","æ˜¯å¦å‘ç»™å­¦å‘˜"];
    const mailHeaders = ["æ—¶é—´","å½’å±ä¸»ä½“","ç­ä¸»ä»»","é‚®å¯„ç‰©å“","å­¦å‘˜å§“å","æ”¶ä»¶äºº","æ”¶ä»¶äººå·ç ","æ”¶ä»¶äººåœ°å€","æ˜¯å¦éœ€è¦é‚®å¯„","ç‰¹æ®Šå¤‡æ³¨","å¯„ä»¶äºº","å¯„ä»¶äººå·ç ","æ˜¯å¦ä¸‹å•ä¸”å¯„é€","å¯„ä»¶æ—¶é—´","å¿«é€’å•å·","å¤‡æ³¨","ä»£è¡¨ç­ä¸»ä»»å¡«å†™","ä»£è¡¨å¯„ä»¶äººå¡«å†™"];
    const afterSalesHeaders = ["åºå·","å½’å±ç­ä¸»ä»»","å§“å","æ‰‹æœºå·","ç­å‹","èº«ä»½è¯å·","æŠ¥åæ—¶é—´","é¦–æ¬¡æé€€æ—¶é—´","ç¬¬å‡ æ¬¡æé€€","åŸå› å¤§ç±»","åŸå› å°ç±»","æ²Ÿé€šè®°å½•1","æ²Ÿé€šè®°å½•2","æ²Ÿé€šè®°å½•3","æ˜¯å¦è½¬å®¢è¯‰å—ç†","è½¬å®¢è¯‰æ—¶é—´","å®¢è¯‰å—ç†äºº","æ˜¯å¦å·²åŠæŒ½","é‡‘ç‰Œè§„åŠå‘˜","æ˜¯å¦å·²é€€è´¹","å‡ºæ¬¾æ—¶é—´","é€€è´¹é‡‘é¢"];
    const projectHeaders = ["æŠ¥è¯»é¡¹ç›®ç±»åˆ«","é¡¹ç›®1","é¡¹ç›®2","é¡¹ç›®3"];
    const majorHeaders = ["ä¸“ä¸šä»£ç ","ä¸“ä¸šåç§°","ä¸“ä¸šç®€ç§°","2025å¹´å›½å®¶çº¿ï¼ˆAåŒºï¼‰"];
    const classHeaders = ["è€ƒæœŸ","ç­çº§","è®¡åˆ’æ‹›ç”Ÿäººæ•°","å®é™…æŠ¥åäººæ•°","æ˜¯å¦æ»¡å‘˜","æ˜¯å¦åœæ‹›æ–°ç”Ÿ"];
    const phraseHeaders = ["åºå·","å¿«æ·æ ‡ç­¾","è®°å•å†…å®¹"];

    // ---------- é»˜è®¤æ•°æ® ----------
    // å‘˜å·¥è¡¨ï¼ˆæ·»åŠ é‚®ç®±å­—æ®µï¼‰
    const defaultEmployees = [
        { è´¦å·:'ç®¡ç†å‘˜', å¯†ç :'2026', é‚®ç®±:'admin@example.com', æ˜¯å¦å¯ç”¨è¯¥è´¦å·:'æ˜¯', å¤‡æ³¨:'åœ¨èŒ' },
        { è´¦å·:'æè€å¸ˆ', å¯†ç :'2025', é‚®ç®±:'lisan@example.com', æ˜¯å¦å¯ç”¨è¯¥è´¦å·:'æ˜¯', å¤‡æ³¨:'åœ¨èŒ' },
        { è´¦å·:'å°å°è€å¸ˆ', å¯†ç :'2025', é‚®ç®±:'xiaoxiao@example.com', æ˜¯å¦å¯ç”¨è¯¥è´¦å·:'æ˜¯', å¤‡æ³¨:'åœ¨èŒ' },
        { è´¦å·:'ç‹è€å¸ˆ', å¯†ç :'2025', é‚®ç®±:'wang@example.com', æ˜¯å¦å¯ç”¨è¯¥è´¦å·:'å¦', å¤‡æ³¨:'ç¦»èŒ' }
    ];
    const defaultProject = [
        { æŠ¥è¯»é¡¹ç›®ç±»åˆ«:'å•ç¬”è¯•', é¡¹ç›®1:'ã€Šç®¡ç†ç±»è”è€ƒç¬”è¯•ã€‹VIPå®šåˆ¶ç›´é€šç­ï¼ˆæ´»åŠ¨ç‰¹ä¾›ç­ï¼‰2025', é¡¹ç›®2:'ã€Šç®¡ç†ç±»è”è€ƒç¬”è¯•ã€‹VIPæ— å¿§ç­ï¼ˆ2026ï¼‰', é¡¹ç›®3:'ã€Šç®¡ç†ç±»è”è€ƒç¬”è¯•ã€‹VIPèè‹±ç­2025' },
        { æŠ¥è¯»é¡¹ç›®ç±»åˆ«:'ç¬”è¯•+å¤è¯•', é¡¹ç›®1:'ã€Šç®¡ç†ç±»è”è€ƒç¬”è¯•+å¤è¯•ã€‹VIPåæ ¡åè®®ç­2026', é¡¹ç›®2:'', é¡¹ç›®3:'' },
        { æŠ¥è¯»é¡¹ç›®ç±»åˆ«:'ç¬”é¢è”æŠ¥', é¡¹ç›®1:'ã€Šç®¡ç†ç±»è”è€ƒç¬”é¢è”æŠ¥ã€‹VIPå®šåˆ¶æ— å¿§ç­2026', é¡¹ç›®2:'', é¡¹ç›®3:'' },
        { æŠ¥è¯»é¡¹ç›®ç±»åˆ«:'åŒè€ƒæœŸ', é¡¹ç›®1:'ã€Šç®¡ç†ç±»è”è€ƒç¬”è¯•ã€‹VIPå®šåˆ¶ç›´é€šç­ï¼ˆå…¨å›½ï¼‰2025+2026', é¡¹ç›®2:'', é¡¹ç›®3:'' }
    ];
    const defaultPhrase = [
        { åºå·:1, å¿«æ·æ ‡ç­¾:'è‡ªå®šä¹‰', è®°å•å†…å®¹:'@è‡ªå®šä¹‰å†…å®¹' },
        { åºå·:2, å¿«æ·æ ‡ç­¾:'æé†’å¼€å­¦å…¸ç¤¼', è®°å•å†…å®¹:'@å¾®ä¿¡å·¦ä¸‹è§’ã€æ¶ˆæ¯ã€‘æ å¼¹å‡ºçš„é‚€è¯·é€šçŸ¥â€¦â€¦@è¯¾ç¨‹å­¦ä¹ éƒ½æ˜¯åœ¨å¾®ä¿¡å…¬ä¼—å·å’Œç½‘é¡µä¸Šé¢è¿›è¡Œâ€¦â€¦@å¼€å­¦å…¸ç¤¼å®‰æ’åœ¨6æœˆ27å·â€¦â€¦@å·¥ä½œæ—¶é—´ä¸Šåˆ10-æ™šä¸Š7ç‚¹' }
    ];
    const defaultStudents = [
        { å½’å±ä¸»ä½“:'èŒ¶ç±³æ•™è‚²',è€ƒæœŸ:'2025',ç­çº§:5,'æ˜¯å¦æ·»åŠ å¾®ä¿¡':'æ˜¯','æ˜¯å¦å‘é€æ–°ç”Ÿèµ„æ–™':'æ˜¯','æ˜¯å¦å‘é€æ‘¸åº•è€ƒè¯•':'æ˜¯',å½’å±åˆä½œæ–¹:'æˆç ”äº‹ä¸šéƒ¨',è·Ÿè¿›äºº:'ç›˜å°é›¶',å½’å±ç­ä¸»ä»»:'å°å°è€å¸ˆ',è®°å•æ—¶é—´:'2025-03-20 00:00:00',æŠ¥åæ—¶é—´:'',å­¦å‘˜æŠ¥åæ‰‹æœºå·:'13802123304',å…¶ä»–æ‰‹æœºå·:'',å­¦å‘˜å§“å:'æ²ˆèŠ±èŠ±',èº«ä»½è¯å·:'440223112345013716',APPè´¦å·:'67461733',APPå¯†ç :'AKaQ33',èŒä¸š:'åŸºå±‚å…¬åŠ¡å‘˜',è®¢å•é‡‘é¢:'10000',é¡¹ç›®:'ç¬”è¯•+å¤è¯•',æ‰€æŠ¥ç­å‹:'ã€Šç®¡ç†ç±»è”è€ƒç¬”è¯•+å¤è¯•ã€‹VIPä¿éšœåè®®ç­2026',æ„å‘é™¢æ ¡ï¼‘:'ä¸­å±±å¤§å­¦',æ„å‘é™¢æ ¡2:'',æ„å‘é™¢æ ¡3:'',æ„å‘ä¸“ä¸š:'MPA',æœ€é«˜å­¦å†:'æœ¬ç§‘',æ¯•ä¸šå¹´ä»½:'2016',å…¶ä»–å­¦å†:'å¤§ä¸“',å…¶ä»–å­¦å†è·å–æ—¶é—´:'2010',æˆ·ç±æ‰€åœ¨åœ°:'å¹¿å·',è´­ä¹°ç¤¾ä¿æ‰€åœ¨çœä»½:'å¹¿ä¸œ',è´­ä¹°ç¤¾ä¿åŸå¸‚:'å¹¿å·',è´­ä¹°ç¤¾ä¿æ—¶é•¿:'10å¹´ä»¥ä¸Š',æ„å‘å­¦ä¹ åŸå¸‚:'å¹¿å·',é‚®ç®±:'23457144@qq.com',å¾®ä¿¡å·:'shh.520',è®°å•ä¿¡æ¯:'ã€å¼€ç­å·²å®Œæˆã€‘ @å¾®ä¿¡ @é¡¹ç›®ï¼šå•ç¬” @ç­å‹ï¼šVIP...',å¤‡æ³¨:'', 'æ˜¯å¦å”®åå­¦å‘˜':'' },
        { å½’å±ä¸»ä½“:'èŒ¶ç±³æ•™è‚²',è€ƒæœŸ:'2025',ç­çº§:3,'æ˜¯å¦æ·»åŠ å¾®ä¿¡':'æ˜¯','æ˜¯å¦å‘é€æ–°ç”Ÿèµ„æ–™':'å¦','æ˜¯å¦å‘é€æ‘¸åº•è€ƒè¯•':'æ˜¯',å½’å±åˆä½œæ–¹:'ç½‘é”€éƒ¨',è·Ÿè¿›äºº:'æé›·',å½’å±ç­ä¸»ä»»:'æè€å¸ˆ',è®°å•æ—¶é—´:'2025-03-21 10:30:00',æŠ¥åæ—¶é—´:'2025-03-21',å­¦å‘˜æŠ¥åæ‰‹æœºå·:'13987654321',å…¶ä»–æ‰‹æœºå·:'',å­¦å‘˜å§“å:'éŸ©æ¢…æ¢…',èº«ä»½è¯å·:'4402231987654321',APPè´¦å·:'hm123',APPå¯†ç :'pass123',èŒä¸š:'ä¼ä¸šèŒå‘˜',è®¢å•é‡‘é¢:'8000',é¡¹ç›®:'å•ç¬”è¯•',æ‰€æŠ¥ç­å‹:'ã€Šç®¡ç†ç±»è”è€ƒç¬”è¯•ã€‹VIPæ— å¿§ç­ï¼ˆ2026ï¼‰',æ„å‘é™¢æ ¡ï¼‘:'æš¨å—å¤§å­¦',æ„å‘é™¢æ ¡2:'',æ„å‘é™¢æ ¡3:'',æ„å‘ä¸“ä¸š:'MBA',æœ€é«˜å­¦å†:'æœ¬ç§‘',æ¯•ä¸šå¹´ä»½:'2018',å…¶ä»–å­¦å†:'',å…¶ä»–å­¦å†è·å–æ—¶é—´:'',æˆ·ç±æ‰€åœ¨åœ°:'æ·±åœ³',è´­ä¹°ç¤¾ä¿æ‰€åœ¨çœä»½:'å¹¿ä¸œ',è´­ä¹°ç¤¾ä¿åŸå¸‚:'æ·±åœ³',è´­ä¹°ç¤¾ä¿æ—¶é•¿:'5å¹´',æ„å‘å­¦ä¹ åŸå¸‚:'æ·±åœ³',é‚®ç®±:'meimei@qq.com',å¾®ä¿¡å·:'hm123',è®°å•ä¿¡æ¯:'ã€å¼€ç­æœªå®Œæˆã€‘ @å¾®ä¿¡å¼€ç­ @å•ç¬”è¯•...',å¤‡æ³¨:'', 'æ˜¯å¦å”®åå­¦å‘˜':'' }
    ];
    const defaultMajorData = [
        { ä¸“ä¸šä»£ç :'125100', ä¸“ä¸šåç§°:'å·¥å•†ç®¡ç†', ä¸“ä¸šç®€ç§°:'MBA', '2025å¹´å›½å®¶çº¿ï¼ˆAåŒºï¼‰':'151/35/70' },
        { ä¸“ä¸šä»£ç :'125200', ä¸“ä¸šåç§°:'å…¬å…±ç®¡ç†', ä¸“ä¸šç®€ç§°:'MPA', '2025å¹´å›½å®¶çº¿ï¼ˆAåŒºï¼‰':'164/38/76' },
        { ä¸“ä¸šä»£ç :'125300', ä¸“ä¸šåç§°:'ä¼šè®¡', ä¸“ä¸šç®€ç§°:'MPAcc', '2025å¹´å›½å®¶çº¿ï¼ˆAåŒºï¼‰':'194/48/96' },
        { ä¸“ä¸šä»£ç :'125400', ä¸“ä¸šåç§°:'æ—…æ¸¸ç®¡ç†', ä¸“ä¸šç®€ç§°:'MTA', '2025å¹´å›½å®¶çº¿ï¼ˆAåŒºï¼‰':'151/35/70' },
        { ä¸“ä¸šä»£ç :'125500', ä¸“ä¸šåç§°:'å›¾ä¹¦æƒ…æŠ¥', ä¸“ä¸šç®€ç§°:'MLIS', '2025å¹´å›½å®¶çº¿ï¼ˆAåŒºï¼‰':'191/48/96' },
        { ä¸“ä¸šä»£ç :'125700', ä¸“ä¸šåç§°:'å®¡è®¡', ä¸“ä¸šç®€ç§°:'MAud', '2025å¹´å›½å®¶çº¿ï¼ˆAåŒºï¼‰':'201/52/104' },
        { ä¸“ä¸šä»£ç :'125600', ä¸“ä¸šåç§°:'å·¥ç¨‹ç®¡ç†', ä¸“ä¸šç®€ç§°:'MEM', '2025å¹´å›½å®¶çº¿ï¼ˆAåŒºï¼‰':'162/38/67' }
    ];
    const defaultClasses = [
        { è€ƒæœŸ:'2025', ç­çº§:1, è®¡åˆ’æ‹›ç”Ÿäººæ•°:30, 'æ˜¯å¦åœæ‹›æ–°ç”Ÿ':'å¦' },
        { è€ƒæœŸ:'2025', ç­çº§:2, è®¡åˆ’æ‹›ç”Ÿäººæ•°:25, 'æ˜¯å¦åœæ‹›æ–°ç”Ÿ':'å¦' },
        { è€ƒæœŸ:'2025', ç­çº§:3, è®¡åˆ’æ‹›ç”Ÿäººæ•°:20, 'æ˜¯å¦åœæ‹›æ–°ç”Ÿ':'æ˜¯' }
    ];

    // åˆå§‹åŒ–æ•°æ®åº“ï¼ˆä»…å½“æœ¬åœ°ä¸ºç©ºæ—¶å¡«å……é»˜è®¤æ•°æ®ï¼‰
    async function initDB() {
        // å‘˜å·¥è¡¨
        const empRes = await dbEmployees.allDocs({ limit: 1 });
        if (empRes.rows.length === 0) {
            for (let i=0; i<defaultEmployees.length; i++) {
                let emp = { ...defaultEmployees[i], _id: 'emp_'+Date.now()+'_'+i, _ctime: Date.now()-i*1000 };
                await dbEmployees.put(emp).catch(e=>console.warn('å‘˜å·¥è¡¨åˆå§‹åŒ–å¤±è´¥',e));
            }
        }
        // é¡¹ç›®è¡¨
        const projRes = await dbProject.allDocs({ limit: 1 });
        if (projRes.rows.length===0) {
            for (let i=0; i<defaultProject.length; i++) {
                let doc = { ...defaultProject[i], _id:'proj_'+Date.now()+'_'+i, _ctime: Date.now()-i*1000 };
                await dbProject.put(doc);
            }
        }
        // è¯æœ¯è¡¨
        const phRes = await dbPhrase.allDocs({ limit: 1 });
        if (phRes.rows.length===0) {
            for (let i=0; i<defaultPhrase.length; i++) {
                let doc = { ...defaultPhrase[i], _id:'ph_'+Date.now()+'_'+i, _ctime: Date.now()-i*1000 };
                await dbPhrase.put(doc);
            }
        }
        // å­¦å‘˜è¡¨
        const stuRes = await dbStudents.allDocs({ limit: 1 });
        if (stuRes.rows.length===0) {
            for (let i=0; i<defaultStudents.length; i++) {
                let doc = { ...defaultStudents[i], _id:'stu_'+Date.now()+'_'+i, _ctime: Date.now()-i*100000 };
                await dbStudents.put(doc);
            }
        }
        // å‘ç¥¨è¡¨ç®€å•åˆå§‹
        const invRes = await dbInvoices.allDocs({ limit: 1 });
        if (invRes.rows.length===0) {
            await dbInvoices.put({ _id:'inv_sample_'+Date.now(), å½’å±ä¸»ä½“:'èŒ¶ç±³æ•™è‚²',ç­ä¸»ä»»:'å°å°è€å¸ˆ',å§“å:'æ²ˆèŠ±èŠ±',è”ç³»ç”µè¯:'13802123304',èº«ä»½è¯å·:'440223112345013716',æŠ¥è€ƒç­å‹:'ã€Šç®¡ç†ç±»è”è€ƒç¬”è¯•+å¤è¯•ã€‹VIPä¿éšœåè®®ç­2026',æ‹›ç”Ÿéƒ¨é—¨:'æˆç ”äº‹ä¸šéƒ¨','*å‘ç¥¨ç±»å‹':'å¢å€¼ç¨æ™®é€šå‘ç¥¨ï¼ˆç”µå­ï¼‰','*å¼€ç¥¨é‡‘é¢':'10000','*å‘ç¥¨æŠ¬å¤´':'æ²ˆèŠ±èŠ±','*çº³ç¨äººè¯†åˆ«å·':'440223112345013716',æ˜¯å¦éœ€è¦å¼€å…·å‘ç¥¨:'æ˜¯',ç”³è¯·äºº:'å°å°è€å¸ˆ',ç”³è¯·æ—¶é—´:'2025-03-20 00:00:00',å¤‡æ³¨:'åŠ æ€¥',å¼€ç¥¨äºº:'å¤§è´¢è€å¸ˆ', _ctime: Date.now() - 90000 }).catch(e=>console.warn);
        }
        // é‚®å¯„è¡¨
        const mailRes = await dbMailings.allDocs({ limit: 1 });
        if (mailRes.rows.length===0) {
            await dbMailings.put({ _id:'mail_sample_'+Date.now(), æ—¶é—´:'2025-03-20 00:00:00',å½’å±ä¸»ä½“:'èŒ¶ç±³æ•™è‚²',ç­ä¸»ä»»:'å°å°è€å¸ˆ',é‚®å¯„ç‰©å“:'çº¸è´¨èµ„æ–™ å¤§ç¤¼åŒ…',å­¦å‘˜å§“å:'æ²ˆèŠ±èŠ±',æ”¶ä»¶äºº:'å°æ²ˆ',æ”¶ä»¶äººå·ç :'13802123304',æ”¶ä»¶äººåœ°å€:'å››å·çœé€šæ±Ÿå¿æŸæŸå¤§è¡—',æ˜¯å¦éœ€è¦é‚®å¯„:'æ˜¯',ç‰¹æ®Šå¤‡æ³¨:'è¦æ±‚é‚®æ”¿å¿«é€’', _ctime: Date.now() - 80000 }).catch(e=>console.warn);
        }
        // ä¸“ä¸šä»£ç è¡¨
        const majRes = await dbMajor.allDocs({ limit: 1 });
        if (majRes.rows.length===0) {
            for (let i=0; i<defaultMajorData.length; i++) {
                let doc = { ...defaultMajorData[i], _id:'maj_'+Date.now()+'_'+i, _ctime: Date.now()-i*1000 };
                await dbMajor.put(doc);
            }
        }
        // ç­çº§è¡¨
        const clsRes = await dbClasses.allDocs({ limit: 1 });
        if (clsRes.rows.length===0) {
            for (let i=0; i<defaultClasses.length; i++) {
                let doc = { ...defaultClasses[i], _id:'class_'+Date.now()+'_'+i, _ctime: Date.now()-i*1000 };
                await dbClasses.put(doc);
            }
        }
    }
    initDB();

    // ---------- ç™»å½•çŠ¶æ€ç®¡ç† ----------
    const ADMIN_ACCOUNT = 'ç®¡ç†å‘˜';
    const ADMIN_PASSWORD = '2026';
    let currentUser = JSON.parse(sessionStorage.getItem('currentUser')) || null;
    const userDisplay = document.getElementById('userDisplay2');
    const currentUserName = document.getElementById('currentUserName2');
    const showLoginBtn = document.getElementById('showLoginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const loginModal = document.getElementById('loginModal');

    function updateLoginUI() {
        if (currentUser) {
            userDisplay.classList.remove('hidden');
            currentUserName.innerText = currentUser.è´¦å· || '';
            showLoginBtn.classList.add('hidden');
            logoutBtn.classList.remove('hidden');
        } else {
            userDisplay.classList.add('hidden');
            showLoginBtn.classList.remove('hidden');
            logoutBtn.classList.add('hidden');
        }
    }
    updateLoginUI();

    function requireLogin() {
        if (!currentUser) {
            alert('è¯·å…ˆç™»å½•');
            loginModal.classList.remove('hidden');
            return false;
        }
        return true;
    }

    document.getElementById('showLoginBtn').addEventListener('click', ()=>loginModal.classList.remove('hidden'));
    document.getElementById('closeLoginModal').addEventListener('click', ()=>loginModal.classList.add('hidden'));
    document.getElementById('loginBtn').addEventListener('click', ()=>{
        const acc = document.getElementById('loginUser').value;
        const pwd = document.getElementById('loginPass').value;

        // ç®¡ç†å‘˜ç¡¬ç¼–ç 
        if (acc === ADMIN_ACCOUNT && pwd === ADMIN_PASSWORD) {
            currentUser = { è´¦å·: ADMIN_ACCOUNT, æ˜¯å¦å¯ç”¨è¯¥è´¦å·: 'æ˜¯' };
            sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
            updateLoginUI();
            loginModal.classList.add('hidden');
            renderTable(currentTab, document.getElementById('searchInput').value, 1);
            return;
        }

        // æ™®é€šå‘˜å·¥éªŒè¯
        dbEmployees.allDocs({ include_docs: true }).then(res => {
            const users = res.rows.map(r=>r.doc);
            const found = users.find(u=>u.è´¦å·===acc && u.å¯†ç ===pwd && u.æ˜¯å¦å¯ç”¨è¯¥è´¦å·==='æ˜¯');
            if (found) {
                currentUser = found;
                sessionStorage.setItem('currentUser', JSON.stringify(found));
                updateLoginUI();
                loginModal.classList.add('hidden');
                renderTable(currentTab, document.getElementById('searchInput').value, 1);
            } else { alert('ç™»å½•å¤±è´¥ï¼šè´¦å·/å¯†ç é”™è¯¯æˆ–è´¦å·æœªå¯ç”¨'); }
        });
    });
    document.getElementById('logoutBtn').addEventListener('click', ()=>{
        currentUser = null;
        sessionStorage.removeItem('currentUser');
        updateLoginUI();
        renderTable(currentTab, document.getElementById('searchInput').value, 1);
    });

    // ---------- ä»¥ä¸‹ä¸ºåŸæœ‰è¡¨æ ¼æ¸²æŸ“é€»è¾‘ï¼Œä¿æŒä¸å˜ ----------
    function escapeHtml(unsafe) {
        if (unsafe===null||unsafe===undefined) return '';
        return String(unsafe).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');
    }
    function shouldUseTextarea(fieldName) {
        return ['è®°å•','å¤‡æ³¨','åœ°å€','æ²Ÿé€šè®°å½•','è®°å•ä¿¡æ¯','ç‰¹æ®Šå¤‡æ³¨'].some(k => fieldName.includes(k));
    }

    // æ•°æ®åº“æ˜ å°„
    const dbMap = {
        students: { db: dbStudents, headers: studentHeaders, container: 'studentTableContainer', countSpan: 'studentCount', idPrefix: 'stu', paginationId: 'studentPagination' },
        invoices: { db: dbInvoices, headers: invoiceHeaders, container: 'invoiceTableContainer', countSpan: 'invoiceCount', idPrefix: 'inv', paginationId: 'invoicePagination' },
        mailings: { db: dbMailings, headers: mailHeaders, container: 'mailTableContainer', countSpan: 'mailCount', idPrefix: 'mail', paginationId: 'mailPagination' },
        after_sales: { db: dbAfterSales, headers: afterSalesHeaders, container: 'afterSalesTableContainer', countSpan: 'afterSalesCount', idPrefix: 'as', paginationId: 'afterSalesPagination' },
        project_category: { db: dbProject, headers: projectHeaders, container: 'projectTableContainer', countSpan: 'projectCount', idPrefix: 'proj', paginationId: 'projectPagination' },
        major_codes: { db: dbMajor, headers: majorHeaders, container: 'majorTableContainer', countSpan: 'majorCount', idPrefix: 'maj', paginationId: 'majorPagination' },
        classes: { db: dbClasses, headers: classHeaders, container: 'classTableContainer', countSpan: 'classCount', idPrefix: 'class', paginationId: 'classPagination' },
        memo_phrase: { db: dbPhrase, headers: phraseHeaders, container: 'phraseTableContainer', countSpan: 'phraseCount', idPrefix: 'ph', paginationId: 'phrasePagination' }
    };

    let currentTab = 'student';
    const PAGE_SIZE = 15;
    const pageStates = {
        students:1, invoices:1, mailings:1, after_sales:1, project_category:1, major_codes:1, classes:1, memo_phrase:1
    };

    // è¾…åŠ©ï¼šç­çº§ç»Ÿè®¡
    async function getClassStats() {
        const all = await dbStudents.allDocs({ include_docs: true });
        const students = all.rows.map(r=>r.doc).filter(d=>!d._id.startsWith('_design'));
        const stats = {};
        students.forEach(s => {
            const key = `${s.è€ƒæœŸ}_${s.ç­çº§}`;
            if (!stats[key]) stats[key] = new Set();
            stats[key].add(s._id);
        });
        return stats;
    }

    // æ¸²æŸ“è¡¨æ ¼ï¼ˆæ ¸å¿ƒï¼‰
    async function renderTable(dbKey, filterText='', page=1) {
        if (!requireLogin()) return;
        const conf = dbMap[dbKey];
        if (!conf) return;
        const { db, headers, container, countSpan, paginationId } = conf;
        const allDocs = await db.allDocs({ include_docs: true });
        let rows = allDocs.rows.map(r=>r.doc).filter(d=>!d._id.startsWith('_design'));
        rows.sort((a,b)=>(b._ctime||0)-(a._ctime||0));
        if (filterText) {
            const lower = filterText.toLowerCase();
            rows = rows.filter(d=>Object.values(d).some(v=>v && v.toString().toLowerCase().includes(lower)));
        }
        document.getElementById(countSpan).innerText = rows.length;
        const totalPages = Math.ceil(rows.length/PAGE_SIZE)||1;
        let currentPage = Math.min(page, totalPages);
        if (currentPage<1) currentPage=1;
        pageStates[dbKey]=currentPage;
        const start = (currentPage-1)*PAGE_SIZE;
        const pageRows = rows.slice(start, start+PAGE_SIZE);

        let classStats = {};
        if (dbKey==='classes') classStats = await getClassStats();

        let html = `<table><thead><tr>${headers.map(h=>`<th>${escapeHtml(h)}</th>`).join('')}<th style="position:sticky;right:0;background:#edf2f7;">æ“ä½œ</th></tr></thead><tbody>`;
        for (const doc of pageRows) {
            const rowId = doc._id;
            html += `<tr data-id="${escapeHtml(rowId)}" data-db="${escapeHtml(dbKey)}" class="cursor-pointer hover:bg-gray-100">`;
            for (const header of headers) {
                let val = doc[header]!==undefined ? doc[header] : '';
                if (typeof val==='object') val=JSON.stringify(val);
                // ç­çº§è¡¨åŠ¨æ€åˆ—
                if (dbKey==='classes' && header==='å®é™…æŠ¥åäººæ•°') {
                    const key = `${doc.è€ƒæœŸ}_${doc.ç­çº§}`;
                    val = classStats[key] ? classStats[key].size : 0;
                    doc[header]=val;
                }
                if (dbKey==='classes' && header==='æ˜¯å¦æ»¡å‘˜') {
                    const plan = parseInt(doc.è®¡åˆ’æ‹›ç”Ÿäººæ•°)||0;
                    const key = `${doc.è€ƒæœŸ}_${doc.ç­çº§}`;
                    const actual = classStats[key] ? classStats[key].size : 0;
                    val = (plan>0 && actual>=plan) ? 'æ˜¯' : 'å¦';
                }
                // æ˜¯å¦åˆ—ä¸‹æ‹‰
                if (header.includes('æ˜¯å¦') && header!=='æ˜¯å¦æ»¡å‘˜') {
                    const selectedYes = val==='æ˜¯' ? 'selected' : '';
                    const selectedNo = val==='å¦' ? 'selected' : '';
                    const bgClass = val==='æ˜¯' ? 'is-select-yes' : (val==='å¦' ? 'is-select-no' : '');
                    html += `<td class="p-0" data-field="${escapeHtml(header)}"><select class="is-select ${bgClass}" data-field="${escapeHtml(header)}" data-row-id="${escapeHtml(rowId)}" data-db="${escapeHtml(dbKey)}"><option value="" ${!val?'selected':''}>--</option><option value="æ˜¯" ${selectedYes}>æ˜¯</option><option value="å¦" ${selectedNo}>å¦</option></select></td>`;
                } else {
                    const displayVal = val.length>20 ? val.substring(0,20)+'â€¦' : val;
                    html += `<td class="editable-cell" data-field="${escapeHtml(header)}" title="${escapeHtml(val)}">${escapeHtml(displayVal)}</td>`;
                }
            }
            html += `<td style="position:sticky;right:0;background:white;"><button class="delete-row-btn text-red-600 hover:text-red-800" title="åˆ é™¤"><i class="fas fa-trash"></i></button></td></tr>`;
        }
        html += '</tbody></table>';
        document.getElementById(container).innerHTML = html;

        // ç»‘å®šè¡Œç‚¹å‡»
        document.querySelectorAll(`#${container} tbody tr[data-id]`).forEach(tr=>{
            tr.addEventListener('click', e=>{
                if (e.target.tagName==='SELECT' || e.target.closest('button')) return;
                showEditModal(tr.dataset.id, tr.dataset.db);
            });
        });
        // åˆ é™¤æŒ‰é’®
        document.querySelectorAll(`#${container} .delete-row-btn`).forEach(btn=>{
            btn.addEventListener('click', async e=>{
                e.stopPropagation();
                if (!confirm('ç¡®å®šåˆ é™¤ï¼Ÿ')) return;
                const row = e.target.closest('tr');
                const id = row?.dataset.id;
                const dbKey = row?.dataset.db;
                if (!id||!dbKey) return;
                const targetDb = dbMap[dbKey]?.db;
                if (targetDb) {
                    try {
                        const doc = await targetDb.get(id);
                        await targetDb.remove(doc);
                        if (dbKey==='students' && currentTab==='classes') renderTable('classes', filterText, pageStates.classes);
                        renderTable(currentTab, filterText, pageStates[currentTab]);
                    } catch { alert('åˆ é™¤å¤±è´¥'); }
                }
            });
        });
        // æ˜¯å¦åˆ—å˜æ›´
        document.querySelectorAll(`#${container} select.is-select`).forEach(select=>{
            select.addEventListener('change', async e=>{
                e.stopPropagation();
                const newVal = e.target.value;
                const field = e.target.dataset.field;
                const rowId = e.target.dataset.rowId;
                const dbKey = e.target.dataset.db;
                if (!rowId||!dbKey||!field) return;
                const targetDb = dbMap[dbKey]?.db;
                if (!targetDb) return;
                try {
                    const doc = await targetDb.get(rowId);
                    doc[field] = newVal;
                    doc._ctime = Date.now();
                    await targetDb.put(doc);
                    if (dbKey==='students' && field==='æ˜¯å¦å”®åå­¦å‘˜') await syncAfterSalesFromStudent(doc);
                    e.target.className = `is-select ${newVal==='æ˜¯'?'is-select-yes':(newVal==='å¦'?'is-select-no':'')}`;
                } catch { alert('æ›´æ–°å¤±è´¥'); }
            });
        });

        // åˆ†é¡µ
        renderPagination(paginationId, currentPage, totalPages, dbKey, filterText);
    }

    // åŒæ­¥å”®åï¼ˆç®€åŒ–ï¼‰
    async function syncAfterSalesFromStudent(studentDoc) {
        if (studentDoc['æ˜¯å¦å”®åå­¦å‘˜']!=='æ˜¯') return;
        const all = await dbAfterSales.allDocs({ include_docs: true });
        const existing = all.rows.map(r=>r.doc).find(d=>d.å§“å===studentDoc.å­¦å‘˜å§“å && d.æ‰‹æœºå·===studentDoc.å­¦å‘˜æŠ¥åæ‰‹æœºå·);
        const base = { å½’å±ç­ä¸»ä»»:studentDoc.å½’å±ç­ä¸»ä»»||'', å§“å:studentDoc.å­¦å‘˜å§“å||'', æ‰‹æœºå·:studentDoc.å­¦å‘˜æŠ¥åæ‰‹æœºå·||'', ç­å‹:studentDoc.æ‰€æŠ¥ç­å‹||'', èº«ä»½è¯å·:studentDoc.èº«ä»½è¯å·||'', æŠ¥åæ—¶é—´:studentDoc.æŠ¥åæ—¶é—´||'' };
        if (existing) {
            Object.assign(existing, base);
            existing._ctime = Date.now();
            await dbAfterSales.put(existing);
        } else {
            const newDoc = { ...base, _id:'as_'+Date.now()+'_'+Math.random().toString(36).substr(2,6), _ctime:Date.now() };
            await dbAfterSales.put(newDoc);
        }
        if (currentTab==='afterSales') renderTable('after_sales', document.getElementById('searchInput').value, pageStates.after_sales);
    }

    // åˆ†é¡µæ¸²æŸ“
    function renderPagination(paginationId, cp, tp, dbKey, filter) {
        const p = document.getElementById(paginationId);
        if (!p) return;
        if (tp<=1) { p.innerHTML=''; return; }
        let html = `<button class="page-first" ${cp===1?'disabled':''}><i class="fas fa-angle-double-left"></i></button>
            <button class="page-prev" ${cp===1?'disabled':''}><i class="fas fa-angle-left"></i></button>
            <span>ç¬¬ <input type="number" id="pageInput_${dbKey}" value="${cp}" min="1" max="${tp}" style="width:50px;"> é¡µ / å…± ${tp} é¡µ</span>
            <button class="page-next" ${cp===tp?'disabled':''}><i class="fas fa-angle-right"></i></button>
            <button class="page-last" ${cp===tp?'disabled':''}><i class="fas fa-angle-double-right"></i></button>`;
        p.innerHTML = html;
        p.querySelector('.page-first')?.addEventListener('click', ()=> renderTable(dbKey, filter, 1));
        p.querySelector('.page-prev')?.addEventListener('click', ()=> renderTable(dbKey, filter, cp-1));
        p.querySelector('.page-next')?.addEventListener('click', ()=> renderTable(dbKey, filter, cp+1));
        p.querySelector('.page-last')?.addEventListener('click', ()=> renderTable(dbKey, filter, tp));
        const inp = document.getElementById(`pageInput_${dbKey}`);
        inp?.addEventListener('change', function() { let np = parseInt(this.value); if (np<1) np=1; if (np>tp) np=tp; renderTable(dbKey, filter, np); });
    }

    // æ–°å¢ç©ºç™½è¡Œ
    async function addEmptyRow(dbKey) {
        if (!requireLogin()) return;
        const conf = dbMap[dbKey];
        if (!conf) return;
        const { db, headers, idPrefix } = conf;
        const newDoc = { _id: idPrefix+'_'+Date.now()+'_'+Math.random().toString(36).substr(2,4), _ctime: Date.now() };
        headers.forEach(h=> newDoc[h]='');
        if (headers.includes('å½’å±ç­ä¸»ä»»')) newDoc['å½’å±ç­ä¸»ä»»'] = currentUser?.è´¦å·||'';
        if (headers.includes('ç­ä¸»ä»»')) newDoc['ç­ä¸»ä»»'] = currentUser?.è´¦å·||'';
        if (headers.includes('å½’å±ä¸»ä½“')) newDoc['å½’å±ä¸»ä½“'] = 'èŒ¶ç±³æ•™è‚²';
        if (dbKey==='classes') { newDoc['è€ƒæœŸ']='2025'; newDoc['ç­çº§']='1'; newDoc['è®¡åˆ’æ‹›ç”Ÿäººæ•°']='30'; newDoc['æ˜¯å¦åœæ‹›æ–°ç”Ÿ']='å¦'; }
        await db.put(newDoc);
        renderTable(currentTab, document.getElementById('searchInput').value, 1);
    }

    // ç¼–è¾‘å¼¹çª—
    let currentEditId=null, currentEditDbKey=null, currentEditDoc=null;
    async function showEditModal(rowId, dbKey) {
        const conf = dbMap[dbKey];
        if (!conf) return;
        try {
            const doc = await conf.db.get(rowId);
            currentEditId=rowId; currentEditDbKey=dbKey; currentEditDoc=doc;
            const headers = conf.headers;
            let fieldsHtml = '';
            for (let header of headers) {
                let val = doc[header]!==undefined? doc[header]:'';
                if (typeof val==='object') val=JSON.stringify(val);
                const escapedVal = escapeHtml(val);
                if (shouldUseTextarea(header)) {
                    fieldsHtml += `<div><label class="block font-medium">${escapeHtml(header)}</label><textarea class="w-full border p-1 rounded text-sm modal-field" data-field="${escapeHtml(header)}" rows="3">${escapedVal}</textarea></div>`;
                } else if (header.includes('æ˜¯å¦')) {
                    const selYes = val==='æ˜¯'?'selected':'';
                    const selNo = val==='å¦'?'selected':'';
                    fieldsHtml += `<div><label class="block font-medium">${escapeHtml(header)}</label><select class="w-full border p-1 rounded text-sm modal-field" data-field="${escapeHtml(header)}"><option value="" ${!val?'selected':''}>--</option><option value="æ˜¯" ${selYes}>æ˜¯</option><option value="å¦" ${selNo}>å¦</option></select></div>`;
                } else {
                    fieldsHtml += `<div><label class="block font-medium">${escapeHtml(header)}</label><input type="text" class="w-full border p-1 rounded text-sm modal-field" data-field="${escapeHtml(header)}" value="${escapedVal}"></div>`;
                }
            }
            document.getElementById('modalFields').innerHTML = fieldsHtml;
            document.getElementById('modalTitle').innerText = `ç¼–è¾‘ - ${doc.å­¦å‘˜å§“å||doc.å§“å||doc.å¿«æ·æ ‡ç­¾||doc.ä¸“ä¸šåç§°||'æ•°æ®è¡Œ'}`;
            document.getElementById('editModal').classList.remove('hidden');
        } catch { alert('æ— æ³•åŠ è½½æ•°æ®'); }
    }

    async function saveModalEdit() {
        if (!currentEditId||!currentEditDbKey||!currentEditDoc) return;
        const conf = dbMap[currentEditDbKey];
        if (!conf) return;
        document.querySelectorAll('#modalFields .modal-field').forEach(inp => {
            const f = inp.dataset.field;
            if (f) currentEditDoc[f] = inp.value;
        });
        currentEditDoc._ctime = Date.now();
        try {
            await conf.db.put(currentEditDoc);
            if (currentEditDbKey==='students') await syncAfterSalesFromStudent(currentEditDoc);
            if (currentTab==='classes') renderTable('classes', document.getElementById('searchInput').value, pageStates.classes);
            alert('ä¿å­˜æˆåŠŸ');
            closeModal();
            renderTable(currentTab, document.getElementById('searchInput').value, pageStates[currentTab]);
        } catch { alert('ä¿å­˜å¤±è´¥'); }
    }
    function closeModal() { document.getElementById('editModal').classList.add('hidden'); currentEditId=null; }

    // å¯¼å‡ºå…¨éƒ¨è¡¨æ ¼
    async function exportAllTables() {
        if (!requireLogin()) return;
        const wb = XLSX.utils.book_new();
        for (const [key, conf] of Object.entries(dbMap)) {
            const all = await conf.db.allDocs({ include_docs: true });
            let rows = all.rows.map(r=>r.doc).filter(d=>!d._id.startsWith('_design'));
            const headers = conf.headers;
            if (key==='classes') {
                const stats = await getClassStats();
                rows = rows.map(doc=>{
                    const k = `${doc.è€ƒæœŸ}_${doc.ç­çº§}`;
                    const actual = stats[k]?stats[k].size:0;
                    const plan = parseInt(doc.è®¡åˆ’æ‹›ç”Ÿäººæ•°)||0;
                    return {...doc, å®é™…æŠ¥åäººæ•°:actual, æ˜¯å¦æ»¡å‘˜:(plan>0&&actual>=plan)?'æ˜¯':'å¦'};
                });
            }
            const data = rows.map(d=> headers.map(h=> d[h]!==undefined? d[h]:''));
            const ws = XLSX.utils.aoa_to_sheet([headers, ...data]);
            let name = key;
            if (key==='students') name='å­¦å‘˜å¤§è¡¨';
            else if (key==='invoices') name='å‘ç¥¨è¡¨';
            else if (key==='mailings') name='é‚®å¯„è¡¨';
            else if (key==='after_sales') name='å”®åè¡¨';
            else if (key==='project_category') name='é¡¹ç›®ç±»åˆ«';
            else if (key==='major_codes') name='ä¸“ä¸šä»£ç ';
            else if (key==='classes') name='ç­çº§è¡¨';
            else if (key==='memo_phrase') name='è®°å•è¯æœ¯';
            XLSX.utils.book_append_sheet(wb, ws, name);
        }
        XLSX.writeFile(wb, `å…¨éƒ¨è¡¨æ ¼_${new Date().toISOString().slice(0,10)}.xlsx`);
    }

    // é€‰é¡¹å¡åˆ‡æ¢
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', e => {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('text-blue-600', 'border-b-2', 'border-blue-500'));
            btn.classList.add('text-blue-600', 'border-b-2', 'border-blue-500');
            document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
            const tab = btn.dataset.tab;
            currentTab = tab;
            let dbKey = 'students';
            if (tab==='invoice') dbKey='invoices';
            else if (tab==='mail') dbKey='mailings';
            else if (tab==='afterSales') dbKey='after_sales';
            else if (tab==='project') dbKey='project_category';
            else if (tab==='major') dbKey='major_codes';
            else if (tab==='class') dbKey='classes';
            else if (tab==='phrase') dbKey='memo_phrase';
            document.getElementById(`tab-${tab}`).classList.remove('hidden');
            renderTable(dbKey, document.getElementById('searchInput').value, pageStates[dbKey]||1);
        });
    });

    // æœç´¢
    document.getElementById('searchInput').addEventListener('input', e => {
        const val = e.target.value;
        let dbKey = 'students';
        if (currentTab==='invoice') dbKey='invoices';
        else if (currentTab==='mail') dbKey='mailings';
        else if (currentTab==='afterSales') dbKey='after_sales';
        else if (currentTab==='project') dbKey='project_category';
        else if (currentTab==='major') dbKey='major_codes';
        else if (currentTab==='class') dbKey='classes';
        else if (currentTab==='phrase') dbKey='memo_phrase';
        renderTable(dbKey, val, 1);
    });

    // æ–°å¢è¡ŒæŒ‰é’®
    document.querySelectorAll('.add-row-btn').forEach(btn => {
        btn.addEventListener('click', e => addEmptyRow(btn.dataset.db));
    });

    // å…¨å±
    const container = document.querySelector('.max-w-7xl.mx-auto.bg-white.p-4.rounded.shadow');
    document.getElementById('fullscreenBtn').addEventListener('click', ()=>{
        if (!document.fullscreenElement) container.requestFullscreen().catch(()=>alert('å…¨å±å¤±è´¥'));
        else document.exitFullscreen();
    });

    // å¯¼å‡ºå½“å‰è§†å›¾
    document.getElementById('exportFilteredBtn').addEventListener('click', async ()=>{
        if (!requireLogin()) return;
        const dbKey = currentTab==='student'?'students': currentTab==='invoice'?'invoices': currentTab==='mail'?'mailings': currentTab==='afterSales'?'after_sales': currentTab==='project'?'project_category': currentTab==='major'?'major_codes': currentTab==='class'?'classes': currentTab==='phrase'?'memo_phrase':'';
        const conf = dbMap[dbKey];
        if (!conf) return;
        const all = await conf.db.allDocs({ include_docs: true });
        let rows = all.rows.map(r=>r.doc).filter(d=>!d._id.startsWith('_design'));
        const filter = document.getElementById('searchInput').value.toLowerCase();
        if (filter) rows = rows.filter(d=>Object.values(d).some(v=>v&&v.toString().toLowerCase().includes(filter)));
        if (dbKey==='classes') {
            const stats = await getClassStats();
            rows = rows.map(doc=>{
                const k = `${doc.è€ƒæœŸ}_${doc.ç­çº§}`;
                const actual = stats[k]?stats[k].size:0;
                const plan = parseInt(doc.è®¡åˆ’æ‹›ç”Ÿäººæ•°)||0;
                return {...doc, å®é™…æŠ¥åäººæ•°:actual, æ˜¯å¦æ»¡å‘˜:(plan>0&&actual>=plan)?'æ˜¯':'å¦'};
            });
        }
        const headers = conf.headers;
        const data = rows.map(d=> headers.map(h=> d[h]!==undefined? d[h]:''));
        const ws = XLSX.utils.aoa_to_sheet([headers, ...data]);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, currentTab);
        XLSX.writeFile(wb, `è¿è¥ç™»è®°è¡¨_${currentTab}_filtered.xlsx`);
    });

    document.getElementById('exportAllBtn').addEventListener('click', exportAllTables);
    document.getElementById('importBtn').addEventListener('click', ()=>{
        alert('å¯¼å…¥åŠŸèƒ½å¯é€šè¿‡è§£æExcelæ›´æ–°æ•°æ®åº“ï¼Œå…·ä½“å®ç°å¯è‡ªè¡Œæ‰©å±•ã€‚\n\næ‰€æœ‰æ•°æ®å­˜å‚¨åœ¨IndexedDBï¼Œå¯ä½¿ç”¨å¯¼å‡ºå¤‡ä»½ã€‚');
    });
    document.getElementById('closeModalBtn').addEventListener('click', closeModal);
    document.getElementById('saveModalBtn').addEventListener('click', saveModalEdit);

    // åˆå§‹æ¸²æŸ“
    renderTable('students', '', 1);
})();
</script>
<!-- æ•°æ®å­˜å‚¨è¯´æ˜ï¼šæ‰€æœ‰è¡¨æ ¼æ•°æ®ä¿å­˜åœ¨æµè§ˆå™¨æœ¬åœ°IndexedDBï¼Œå¹¶ä¸è¿œç¨‹CouchDBå®æ—¶åŒæ­¥ã€‚è¯·å®šæœŸå¯¼å‡ºå¤‡ä»½ã€‚ -->
</body>
</html>