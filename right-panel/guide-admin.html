<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŒ‡å—åå° Â· å­¦å‘˜ç®¡ç†å¹³å°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/pouchdb@8.0.1/dist/pouchdb.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.2/package/dist/xlsx.full.min.js"></script>
    <style>
        .table-scroll { overflow-x: auto; border: 1px solid #e2e8f0; border-radius: 0.375rem; }
        .table-scroll table { border-collapse: collapse; width: max-content; min-width: 100%; }
        .table-scroll th { background: #f7fafc; border: 1px solid #cbd5e0; padding: 0.5rem; font-size: 0.75rem; }
        .table-scroll td { border: 1px solid #cbd5e0; padding: 0.5rem; font-size: 0.75rem; white-space: nowrap; }
        .tab-pane { display: none; }
        .tab-pane.active { display: block; }
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000; }
        .modal-content { background: white; padding: 1.5rem; border-radius: 0.5rem; width: 90%; max-width: 900px; max-height: 80vh; overflow-y: auto; }
    </style>
</head>
<body class="bg-gray-50 font-sans p-4">

<!-- å¯¼èˆªæ  -->
<div class="max-w-7xl mx-auto mb-2 flex justify-end space-x-3 text-sm">
    <a href="autoNote.html" target="_blank" class="bg-white px-3 py-1 rounded shadow hover:bg-gray-100"><i class="fas fa-pen-fancy mr-1"></i>è‡ªåŠ¨è®°å•</a>
    <a href="masterTable.html" target="_blank" class="bg-white px-3 py-1 rounded shadow hover:bg-gray-100"><i class="fas fa-table mr-1"></i>è¿è¥ç™»è®°å¤§è¡¨</a>
    <a href="guide.html" target="_blank" class="bg-white px-3 py-1 rounded shadow hover:bg-gray-100"><i class="fas fa-graduation-cap mr-1"></i>ç®¡è”æŠ¥è¯»æŒ‡å—</a>
    <a href="guide-admin.html" target="_blank" class="bg-white px-3 py-1 rounded shadow hover:bg-gray-100"><i class="fas fa-lock mr-1"></i>æŒ‡å—åå°</a>
    <a href="admin.html" target="_blank" class="bg-white px-3 py-1 rounded shadow hover:bg-gray-100"><i class="fas fa-cog mr-1"></i>ç®¡ç†æƒé™</a>
</div>

<!-- ç™»å½•çŠ¶æ€æ¡ -->
<div class="max-w-7xl mx-auto mb-4 flex flex-wrap items-center justify-between gap-2 bg-white p-2 rounded shadow">
    <div class="flex items-center space-x-2 text-sm">
        <span class="text-gray-600"><i class="fas fa-database mr-1 text-blue-500"></i>æŒ‡å—åå°ç®¡ç† (ä¸CouchDBå®æ—¶åŒæ­¥)</span>
        <span id="userDisplay" class="hidden ml-2">ğŸ‘¤ <span id="currentUserName"></span></span>
    </div>
    <div class="flex flex-wrap items-center gap-2">
        <button id="showLoginBtn" class="bg-blue-500 text-white px-3 py-1 rounded text-sm"><i class="fas fa-sign-in-alt mr-1"></i>ç™»å½•</button>
        <button id="logoutBtn" class="bg-gray-300 px-3 py-1 rounded text-sm hidden">é€€å‡º</button>
    </div>
</div>

<!-- ä¸»å†…å®¹ï¼šåå°é€‰é¡¹å¡ -->
<div class="max-w-7xl mx-auto bg-white p-4 rounded shadow">
    <div class="flex border-b mb-4 flex-wrap">
        <button class="tab-btn px-4 py-2 font-medium text-blue-600 border-b-2 border-blue-500" data-tab="applications">ğŸ“‹ æŠ¥è€ƒæ„å‘è¡¨</button>
        <button class="tab-btn px-4 py-2 font-medium" data-tab="universities">ğŸ› å…¨å›½é™¢æ ¡åº“</button>
        <button class="tab-btn px-4 py-2 font-medium" data-tab="analysis">ğŸ“Š å½•å–åˆ†ææ•°æ®</button>
        <button class="tab-btn px-4 py-2 font-medium" data-tab="regions">ğŸ—º åœ°ç†åˆ†åŒºè¡¨</button>
        <button class="tab-btn px-4 py-2 font-medium" data-tab="settings">âš™ï¸ ç³»ç»Ÿè®¾ç½®</button>
    </div>

    <!-- æŠ¥è€ƒæ„å‘è¡¨ (åŒ…å«å…¨éƒ¨å­—æ®µ) -->
    <div id="tab-applications" class="tab-pane active">
        <div class="flex justify-between mb-2">
            <span class="text-sm">å…± <span id="appCount">0</span> æ¡</span>
            <button onclick="exportTable('applications')" class="bg-green-100 hover:bg-green-200 px-3 py-1 rounded text-sm"><i class="fas fa-download mr-1"></i>å¯¼å‡ºExcel</button>
        </div>
        <div id="appTableContainer" class="table-scroll"></div>
    </div>

    <!-- å…¨å›½é™¢æ ¡åº“ (ä¸¥æ ¼æŒ‰ç…§Excel) -->
    <div id="tab-universities" class="tab-pane">
        <div class="flex justify-between mb-2">
            <span class="text-sm">å…± <span id="uniCount">0</span> æ¡</span>
            <div>
                <button onclick="addUniversity()" class="bg-indigo-100 hover:bg-indigo-200 px-3 py-1 rounded text-sm"><i class="fas fa-plus mr-1"></i>æ–°å¢é™¢æ ¡</button>
                <button onclick="exportTable('universities')" class="bg-green-100 hover:bg-green-200 px-3 py-1 rounded text-sm"><i class="fas fa-download mr-1"></i>å¯¼å‡º</button>
            </div>
        </div>
        <div id="uniTableContainer" class="table-scroll"></div>
    </div>

    <!-- å½•å–åˆ†ææ•°æ® (ä¸¥æ ¼æŒ‰ç…§Excel) -->
    <div id="tab-analysis" class="tab-pane">
        <div class="flex justify-between mb-2">
            <span class="text-sm">å…± <span id="analysisCount">0</span> æ¡</span>
            <button onclick="addAnalysis()" class="bg-indigo-100 hover:bg-indigo-200 px-3 py-1 rounded text-sm"><i class="fas fa-plus mr-1"></i>æ–°å¢è®°å½•</button>
            <button onclick="exportTable('analysis')" class="bg-green-100 hover:bg-green-200 px-3 py-1 rounded text-sm"><i class="fas fa-download mr-1"></i>å¯¼å‡º</button>
        </div>
        <div id="analysisTableContainer" class="table-scroll"></div>
    </div>

    <!-- åœ°ç†åˆ†åŒºè¡¨ (çœä»½) -->
    <div id="tab-regions" class="tab-pane">
        <div class="flex justify-between mb-2">
            <span class="text-sm">åœ°ç†åˆ†åŒºæ•°æ®</span>
        </div>
        <div id="regionTableContainer" class="table-scroll"></div>
    </div>

    <!-- ç³»ç»Ÿè®¾ç½® -->
    <div id="tab-settings" class="tab-pane">
        <p class="text-sm text-gray-600">ç³»ç»Ÿè®¾ç½®ï¼šå¯æ‰©å±•åŒæ­¥ã€å¤‡ä»½ç­‰åŠŸèƒ½ã€‚å½“å‰æ•°æ®å…¨éƒ¨å­˜å‚¨åœ¨æœ¬åœ°IndexedDBï¼Œå¹¶ä¸CouchDBå®æ—¶åŒæ­¥ã€‚</p>
        <div class="mt-4 p-4 bg-gray-50 rounded">
            <h4 class="font-medium">å‘˜å·¥è´¦å·ç®¡ç†</h4>
            <p class="text-xs">ç®¡ç†å‘˜è´¦å·ï¼šç®¡ç†å‘˜ / 2026ï¼ˆä¸å¯åœ¨æ­¤ä¿®æ”¹ï¼Œè¯·åœ¨â€œç®¡ç†æƒé™â€é¡µé¢æ“ä½œï¼‰</p>
        </div>
    </div>
</div>

<!-- ç™»å½•æ¨¡æ€æ¡† -->
<div id="loginModal" class="modal hidden">
    <div class="modal-content max-w-md">
        <h3 class="text-lg font-bold mb-4">ç™»å½• (å‘˜å·¥è¡¨ï¼Œéœ€å¯ç”¨è´¦å·)</h3>
        <input id="loginUser" type="text" placeholder="è´¦å·" class="w-full border p-2 mb-2 rounded" value="ç®¡ç†å‘˜">
        <input id="loginPass" type="password" placeholder="å¯†ç " class="w-full border p-2 mb-4 rounded" value="2026">
        <div class="flex justify-end space-x-2">
            <button id="closeLoginModal" class="px-4 py-2 bg-gray-300 rounded">å–æ¶ˆ</button>
            <button id="loginBtn" class="px-4 py-2 bg-blue-600 text-white rounded">ç™»å½•</button>
        </div>
    </div>
</div>

<!-- ç¼–è¾‘æ¨¡æ€æ¡† (ç®€å•) -->
<div id="editModal" class="modal hidden">
    <div class="modal-content">
        <h3 class="text-lg font-bold mb-4" id="modalTitle">ç¼–è¾‘æ•°æ®</h3>
        <div id="modalFields" class="grid grid-cols-2 gap-3 text-sm"></div>
        <div class="flex justify-end space-x-2 mt-4">
            <button onclick="closeEditModal()" class="px-4 py-2 bg-gray-300 rounded">å–æ¶ˆ</button>
            <button id="saveModalBtn" class="px-4 py-2 bg-blue-600 text-white rounded">ä¿å­˜</button>
        </div>
    </div>
</div>

<script>
(function() {
    // ---------- CouchDB é…ç½® ----------
    const COUCHDB_URL = 'http://satoko:1793364876@192.168.5.4:5984'; // ç”¨æˆ·æä¾›çš„å®é™…åœ°å€

    // ---------- æ•°æ®åº“å·¥å‚ ----------
    const createDB = (name) => {
        const localDB = new PouchDB(name);
        if (COUCHDB_URL) {
            const remoteDB = new PouchDB(`${COUCHDB_URL}/${name}`);
            localDB.sync(remoteDB, { live: true, retry: true })
                .on('error', console.warn);
        }
        return localDB;
    };

    // ---------- æ•°æ®åº“ ----------
    const dbEmployees = createDB('employees');
    const dbApplications = createDB('applications');
    const dbUniversities = createDB('universities');
    const dbAdmission = createDB('admission_analysis');

    // ä»guide.jså¤ç”¨çš„æ•°æ® (çœä»½åˆ†åŒºã€é™¢æ ¡ã€å½•å–åˆ†æ)
    const regionProvinces = {
        "ä¸œåŒ—åœ°åŒº": ["é»‘é¾™æ±Ÿ", "å‰æ—", "è¾½å®"],
        "åä¸­åœ°åŒº": ["æ²³å—", "æ¹–åŒ—", "æ¹–å—"],
        "åå—åœ°åŒº": ["å¹¿ä¸œ", "å¹¿è¥¿", "æµ·å—"],
        "è¥¿å—åœ°åŒº": ["é‡åº†", "å››å·", "è´µå·", "äº‘å—", "è¥¿è—"],
        "è¥¿åŒ—åœ°åŒº": ["é™•è¥¿", "ç”˜è‚ƒ", "é’æµ·", "å®å¤", "æ–°ç–†"],
        "åä¸œåœ°åŒº": ["ä¸Šæµ·", "å±±ä¸œ", "å®‰å¾½", "æµ™æ±Ÿ", "ç¦å»º", "æ±Ÿè¥¿", "æ±Ÿè‹"],
        "ååŒ—åœ°åŒº": ["åŒ—äº¬", "å¤©æ´¥", "å±±è¥¿", "æ²³åŒ—", "å†…è’™å¤"]
    };

    const universitiesData = [
        { id:1, name:"åŒ—äº¬å¤§å­¦", province:"åŒ—äº¬", city:"åŒ—äº¬", major:"MBA", schoolType:"985ã€211ã€åŒä¸€æµ", tuitionFull:18.8, tuitionPart:42.8, enrollFull:30, enrollPart:770, scoreLine:151, customScore:151, recommendation:"åæ ¡" },
        { id:2, name:"åŒ—æ–¹å·¥ä¸šå¤§å­¦", province:"åŒ—äº¬", city:"åŒ—äº¬", major:"MBA", schoolType:"æ™®é€šé«˜æ ¡", tuitionFull:6.8, tuitionPart:8.8, enrollFull:50, enrollPart:57, scoreLine:151, customScore:151, recommendation:"å­¦è´¹ä½" },
        { id:3, name:"æˆéƒ½å¤§å­¦", province:"å››å·", city:"æˆéƒ½", major:"MBA", schoolType:"æ™®é€šé«˜æ ¡", tuitionFull:null, tuitionPart:6, enrollFull:null, enrollPart:38, scoreLine:160, customScore:160, recommendation:"æœ¬åœ°" },
        { id:4, name:"é‡åº†å¤§å­¦", province:"é‡åº†", city:"é‡åº†", major:"MBA", schoolType:"985ã€211ã€åŒä¸€æµ", tuitionFull:null, tuitionPart:15.6, enrollFull:null, enrollPart:335, scoreLine:151, customScore:151, recommendation:"985" },
        { id:5, name:"ä¸œåå¤§å­¦", province:"ä¸Šæµ·", city:"ä¸Šæµ·å¸‚", major:"MBA", schoolType:"211ã€åŒä¸€æµ", tuitionFull:21.8, tuitionPart:25.8, enrollFull:80, enrollPart:80, scoreLine:151, customScore:151, recommendation:"211" },
        { id:6, name:"æµå—å¤§å­¦", province:"å±±ä¸œ", city:"æµå—", major:"MBA", schoolType:"æ™®é€šé«˜æ ¡", tuitionFull:null, tuitionPart:8.4, enrollFull:null, enrollPart:44, scoreLine:151, customScore:151, recommendation:"å­¦è´¹ä½" },
        { id:7, name:"æµ·å†›å·¥ç¨‹å¤§å­¦", province:"æ¹–åŒ—", city:"æ­¦æ±‰", major:"MEM", schoolType:"å…¨å›½é‡ç‚¹å¤§å­¦", tuitionFull:null, tuitionPart:null, enrollFull:10, enrollPart:19, scoreLine:0, customScore:0, recommendation:"å†›é˜Ÿé™¢æ ¡" },
        { id:8, name:"é•¿æ²™ç†å·¥å¤§å­¦", province:"æ¹–å—", city:"é•¿æ²™", major:"MBA", schoolType:"æ™®é€šé«˜æ ¡", tuitionFull:null, tuitionPart:10.5, enrollFull:null, enrollPart:105, scoreLine:151, customScore:151, recommendation:"å­¦è´¹é€‚ä¸­" },
        { id:9, name:"ç©ºå†›å·¥ç¨‹å¤§å­¦", province:"é™•è¥¿", city:"è¥¿å®‰", major:"MEM", schoolType:"é«˜ç­‰å†›äº‹é™¢æ ¡", tuitionFull:null, tuitionPart:null, enrollFull:5, enrollPart:12, scoreLine:0, customScore:0, recommendation:"å†›é˜Ÿé™¢æ ¡" },
        { id:10, name:"æ²³åŒ—å·¥ä¸šå¤§å­¦", province:"å¤©æ´¥", city:"å¤©æ´¥", major:"MBA", schoolType:"211ã€åŒä¸€æµ", tuitionFull:6, tuitionPart:8, enrollFull:138, enrollPart:204, scoreLine:151, customScore:151, recommendation:"211" },
        { id:11, name:"å®‰å¾½è´¢ç»å¤§å­¦", province:"å®‰å¾½", city:"èšŒåŸ ", major:"MBA", schoolType:"æ™®é€šé«˜æ ¡", tuitionFull:5, tuitionPart:8, enrollFull:58, enrollPart:95, scoreLine:151, customScore:151, recommendation:"å­¦è´¹ä½" },
        { id:12, name:"å±±è¥¿è´¢ç»å¤§å­¦", province:"å±±è¥¿", city:"å¤ªåŸ", major:"MBA", schoolType:"æ™®é€šé«˜æ ¡", tuitionFull:null, tuitionPart:5.8, enrollFull:null, enrollPart:199, scoreLine:161, customScore:161, recommendation:"å­¦è´¹ä½" },
        { id:13, name:"ä¸œåŒ—æ—ä¸šå¤§å­¦", province:"é»‘é¾™æ±Ÿ", city:"å“ˆå°”æ»¨", major:"MBA", schoolType:"211ã€åŒä¸€æµ", tuitionFull:null, tuitionPart:8.7, enrollFull:null, enrollPart:30, scoreLine:151, customScore:151, recommendation:"211" },
        { id:14, name:"æ²³å—è´¢ç»æ”¿æ³•å¤§å­¦", province:"æ²³å—", city:"éƒ‘å·", major:"MBA", schoolType:"æ™®é€šé«˜æ ¡", tuitionFull:8.75, tuitionPart:8.75, enrollFull:116, enrollPart:70, scoreLine:151, customScore:151, recommendation:"å­¦è´¹é€‚ä¸­" },
        { id:15, name:"æ˜†æ˜ç†å·¥å¤§å­¦", province:"äº‘å—", city:"æ˜†æ˜", major:"MBA", schoolType:"æ™®é€šé«˜æ ¡", tuitionFull:null, tuitionPart:8, enrollFull:null, enrollPart:318, scoreLine:141, customScore:141, recommendation:"BåŒº" },
        { id:16, name:"è´µå·è´¢ç»å¤§å­¦", province:"è´µå·", city:"è´µé˜³", major:"MBA", schoolType:"æ™®é€šé«˜æ ¡", tuitionFull:null, tuitionPart:6, enrollFull:null, enrollPart:34, scoreLine:147, customScore:147, recommendation:"BåŒº" },
        { id:17, name:"æµ™æ±Ÿå¸ˆèŒƒå¤§å­¦", province:"æµ™æ±Ÿ", city:"é‡‘å", major:"MBA", schoolType:"æ™®é€šé«˜æ ¡", tuitionFull:null, tuitionPart:8.5, enrollFull:null, enrollPart:110, scoreLine:157, customScore:157, recommendation:"å­¦è´¹é€‚ä¸­" },
        { id:18, name:"ç¦å»ºç†å·¥å¤§å­¦", province:"ç¦å»º", city:"ç¦å·", major:"MPA", schoolType:"æ™®é€šé«˜æ ¡", tuitionFull:2.4, tuitionPart:4.8, enrollFull:10, enrollPart:10, scoreLine:164, customScore:164, recommendation:"å­¦è´¹ä½" },
        { id:19, name:"ä¸œåç†å·¥å¤§å­¦", province:"æ±Ÿè¥¿", city:"å—æ˜Œ", major:"MBA", schoolType:"æ™®é€šé«˜æ ¡", tuitionFull:3.6, tuitionPart:3.6, enrollFull:28, enrollPart:28, scoreLine:151, customScore:151, recommendation:"å­¦è´¹ä½" },
        { id:20, name:"ç”˜è‚ƒå†œä¸šå¤§å­¦", province:"ç”˜è‚ƒ", city:"å…°å·", major:"MBA", schoolType:"æ™®é€šé«˜æ ¡", tuitionFull:null, tuitionPart:4.5, enrollFull:null, enrollPart:118, scoreLine:141, customScore:141, recommendation:"BåŒº" },
        { id:21, name:"åŒ—æ–¹æ°‘æ—å¤§å­¦", province:"å®å¤", city:"é“¶å·", major:"MBA", schoolType:"æ™®é€šé«˜æ ¡", tuitionFull:null, tuitionPart:3.6, enrollFull:null, enrollPart:5, scoreLine:141, customScore:141, recommendation:"BåŒº" }
    ];

    const admissionData = [
        { year:"2025", university:"å››å·å¤§å­¦", region:"AåŒº", major:"MBA", nationalScore:151, universityScore:151, studyMode:"éå…¨æ—¥åˆ¶", scoreRange:"250-260", applicantCount:1, admittedCount:1, admissionRate:1 },
        { year:"2025", university:"å››å·å¤§å­¦", region:"AåŒº", major:"MBA", nationalScore:151, universityScore:151, studyMode:"éå…¨æ—¥åˆ¶", scoreRange:"240-249", applicantCount:3, admittedCount:3, admissionRate:1 },
        { year:"2025", university:"å››å·å¤§å­¦", region:"AåŒº", major:"MBA", nationalScore:151, universityScore:151, studyMode:"éå…¨æ—¥åˆ¶", scoreRange:"230-239", applicantCount:7, admittedCount:7, admissionRate:1 },
        { year:"2025", university:"å››å·å¤§å­¦", region:"AåŒº", major:"MBA", nationalScore:151, universityScore:151, studyMode:"éå…¨æ—¥åˆ¶", scoreRange:"220-229", applicantCount:16, admittedCount:16, admissionRate:1 },
        { year:"2025", university:"å››å·å¤§å­¦", region:"AåŒº", major:"MBA", nationalScore:151, universityScore:151, studyMode:"éå…¨æ—¥åˆ¶", scoreRange:"210-219", applicantCount:40, admittedCount:36, admissionRate:0.9 },
        { year:"2025", university:"å››å·å¤§å­¦", region:"AåŒº", major:"MBA", nationalScore:151, universityScore:151, studyMode:"éå…¨æ—¥åˆ¶", scoreRange:"200-209", applicantCount:44, admittedCount:41, admissionRate:0.9318 },
        { year:"2025", university:"å››å·å¤§å­¦", region:"AåŒº", major:"MBA", nationalScore:151, universityScore:151, studyMode:"éå…¨æ—¥åˆ¶", scoreRange:"190-199", applicantCount:68, admittedCount:65, admissionRate:0.9559 },
        { year:"2025", university:"å››å·å¤§å­¦", region:"AåŒº", major:"MBA", nationalScore:151, universityScore:151, studyMode:"éå…¨æ—¥åˆ¶", scoreRange:"180-189", applicantCount:80, admittedCount:78, admissionRate:0.975 },
        { year:"2025", university:"å››å·å¤§å­¦", region:"AåŒº", major:"MBA", nationalScore:151, universityScore:151, studyMode:"éå…¨æ—¥åˆ¶", scoreRange:"170-179", applicantCount:104, admittedCount:99, admissionRate:0.9519 },
        { year:"2025", university:"å››å·å¤§å­¦", region:"AåŒº", major:"MBA", nationalScore:151, universityScore:151, studyMode:"éå…¨æ—¥åˆ¶", scoreRange:"160-169", applicantCount:92, admittedCount:86, admissionRate:0.9348 },
        { year:"2025", university:"å››å·å¤§å­¦", region:"AåŒº", major:"MBA", nationalScore:151, universityScore:151, studyMode:"éå…¨æ—¥åˆ¶", scoreRange:"151-159", applicantCount:68, admittedCount:65, admissionRate:0.9559 },
        { year:"2025", university:"è´µå·å¤§å­¦", region:"BåŒº", major:"MBA", nationalScore:141, universityScore:163, studyMode:"éå…¨æ—¥åˆ¶", scoreRange:"220-229", applicantCount:9, admittedCount:9, admissionRate:1 },
        { year:"2025", university:"è´µå·å¤§å­¦", region:"BåŒº", major:"MBA", nationalScore:141, universityScore:163, studyMode:"éå…¨æ—¥åˆ¶", scoreRange:"210-219", applicantCount:16, admittedCount:16, admissionRate:1 },
        { year:"2025", university:"è´µå·å¤§å­¦", region:"BåŒº", major:"MBA", nationalScore:141, universityScore:163, studyMode:"éå…¨æ—¥åˆ¶", scoreRange:"200-209", applicantCount:39, admittedCount:39, admissionRate:1 },
        { year:"2025", university:"è´µå·å¤§å­¦", region:"BåŒº", major:"MBA", nationalScore:141, universityScore:163, studyMode:"éå…¨æ—¥åˆ¶", scoreRange:"190-199", applicantCount:59, admittedCount:58, admissionRate:0.98 },
        { year:"2025", university:"è´µå·å¤§å­¦", region:"BåŒº", major:"MBA", nationalScore:141, universityScore:163, studyMode:"éå…¨æ—¥åˆ¶", scoreRange:"180-189", applicantCount:93, admittedCount:87, admissionRate:0.94 },
        { year:"2025", university:"è´µå·å¤§å­¦", region:"BåŒº", major:"MBA", nationalScore:141, universityScore:163, studyMode:"éå…¨æ—¥åˆ¶", scoreRange:"170-179", applicantCount:113, admittedCount:64, admissionRate:0.57 },
        { year:"2025", university:"è´µå·å¤§å­¦", region:"BåŒº", major:"MBA", nationalScore:141, universityScore:163, studyMode:"éå…¨æ—¥åˆ¶", scoreRange:"163-169", applicantCount:116, admittedCount:27, admissionRate:0.23 }
    ];

    // åˆå§‹åŒ–æ•°æ®åº“
    async function initDB() {
        const uniRes = await dbUniversities.allDocs({ limit: 1 });
        if (uniRes.rows.length === 0) {
            for (let u of universitiesData) {
                await dbUniversities.put({ ...u, _id: 'uni_' + u.id });
            }
        }
        const admRes = await dbAdmission.allDocs({ limit: 1 });
        if (admRes.rows.length === 0) {
            for (let a of admissionData) {
                await dbAdmission.put({ ...a, _id: 'adm_' + Date.now() + Math.random() });
            }
        }
    }
    initDB();

    // ---------- ç™»å½•çŠ¶æ€ ----------
    const ADMIN_ACCOUNT = 'ç®¡ç†å‘˜';
    const ADMIN_PASSWORD = '2026';

    let currentUser = JSON.parse(sessionStorage.getItem('currentUser')) || null;
    const userDisplay = document.getElementById('userDisplay');
    const currentUserName = document.getElementById('currentUserName');
    const showLoginBtn = document.getElementById('showLoginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const loginModal = document.getElementById('loginModal');

    function updateLoginUI() {
        if (currentUser) {
            userDisplay.classList.remove('hidden');
            currentUserName.innerText = currentUser.è´¦å· || '';
            showLoginBtn.classList.add('hidden');
            logoutBtn.classList.remove('hidden');
            if (currentUser.è´¦å· !== ADMIN_ACCOUNT) {
                alert('åªæœ‰ç®¡ç†å‘˜å¯ä»¥è®¿é—®åå°');
                window.location.href = 'guide.html';
            }
        } else {
            userDisplay.classList.add('hidden');
            showLoginBtn.classList.remove('hidden');
            logoutBtn.classList.add('hidden');
        }
    }
    updateLoginUI();

    function requireAdmin() {
        if (!currentUser || currentUser.è´¦å· !== ADMIN_ACCOUNT) {
            alert('è¯·ç”¨ç®¡ç†å‘˜è´¦å·ç™»å½•');
            loginModal.classList.remove('hidden');
            return false;
        }
        return true;
    }

    document.getElementById('showLoginBtn').addEventListener('click', () => loginModal.classList.remove('hidden'));
    document.getElementById('closeLoginModal').addEventListener('click', () => loginModal.classList.add('hidden'));
    document.getElementById('loginBtn').addEventListener('click', () => {
        const acc = document.getElementById('loginUser').value;
        const pwd = document.getElementById('loginPass').value;

        // ç®¡ç†å‘˜ç¡¬ç¼–ç 
        if (acc === ADMIN_ACCOUNT && pwd === ADMIN_PASSWORD) {
            currentUser = { è´¦å·: ADMIN_ACCOUNT, æ˜¯å¦å¯ç”¨è¯¥è´¦å·: 'æ˜¯' };
            sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
            updateLoginUI();
            loginModal.classList.add('hidden');
            renderCurrentTab();
            return;
        }

        // æ™®é€šå‘˜å·¥
        dbEmployees.allDocs({ include_docs: true }).then(res => {
            const users = res.rows.map(r => r.doc).filter(d => !d._id.startsWith('_design'));
            const found = users.find(u => u.è´¦å· === acc && u.å¯†ç  === pwd && u.æ˜¯å¦å¯ç”¨è¯¥è´¦å· === 'æ˜¯');
            if (found) {
                currentUser = found;
                sessionStorage.setItem('currentUser', JSON.stringify(found));
                updateLoginUI();
                loginModal.classList.add('hidden');
                renderCurrentTab();
            } else alert('ç™»å½•å¤±è´¥');
        });
    });
    document.getElementById('logoutBtn').addEventListener('click', () => {
        currentUser = null; sessionStorage.removeItem('currentUser'); updateLoginUI(); window.location.href = 'guide.html';
    });

    // é€‰é¡¹å¡åˆ‡æ¢
    const tabBtns = document.querySelectorAll('.tab-btn');
    const tabPanes = document.querySelectorAll('.tab-pane');
    let currentTab = 'applications';
    tabBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            const tab = btn.dataset.tab;
            tabBtns.forEach(b => b.classList.remove('text-blue-600', 'border-b-2', 'border-blue-500'));
            btn.classList.add('text-blue-600', 'border-b-2', 'border-blue-500');
            tabPanes.forEach(p => p.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');
            currentTab = tab;
            renderCurrentTab();
        });
    });

    function renderCurrentTab() {
        if (!requireAdmin()) return;
        if (currentTab === 'applications') renderApplications();
        else if (currentTab === 'universities') renderUniversities();
        else if (currentTab === 'analysis') renderAnalysis();
        else if (currentTab === 'regions') renderRegions();
    }

    // æŠ¥è€ƒæ„å‘è¡¨ (å®Œæ•´å­—æ®µ)
    async function renderApplications() {
        const all = await dbApplications.allDocs({ include_docs: true });
        const rows = all.rows.map(r => r.doc).filter(d => !d._id.startsWith('_design'));
        document.getElementById('appCount').innerText = rows.length;
        let html = '<table><thead><tr><th>å§“å</th><th>å‡†è€ƒè¯å·</th><th>æŠ¥è€ƒé™¢æ ¡</th><th>ä¸“ä¸š</th><th>å­¦ä¹ å½¢å¼</th><th>æ„å‘çœä»½</th><th>æ„å‘åŸå¸‚</th><th>å·é¢æ€»åˆ†</th><th>è‹±è¯­</th><th>ç®¡ç»¼</th><th>åŠ åˆ†</th><th>æœ‰æ•ˆæ€»åˆ†</th><th>è€ƒè¯•æ—¶é—´</th><th>æ¨èçŠ¶æ€</th><th>æäº¤æ—¶é—´</th><th>æ“ä½œ</th></tr></thead><tbody>';
        rows.forEach(doc => {
            html += `<tr><td>${doc.å§“å||''}</td><td>${doc.å‡†è€ƒè¯å·||''}</td><td>${doc.æŠ¥è€ƒé™¢æ ¡||''}</td><td>${doc.æŠ¥è€ƒä¸“ä¸š||''}</td><td>${doc.å­¦ä¹ å½¢å¼||''}</td><td>${doc.æ„å‘çœä»½||''}</td><td>${doc.æ„å‘åŸå¸‚||''}</td><td>${doc.å·é¢æ€»åˆ†||''}</td><td>${doc.è‹±è¯­å•ç§‘||''}</td><td>${doc.ç®¡ç»¼å•ç§‘||''}</td><td>${doc.åŠ åˆ†||''}</td><td>${doc.æœ‰æ•ˆæ€»åˆ†||''}</td><td>${doc.è€ƒè¯•æ—¶é—´||''}</td><td>${doc.æ¨èçŠ¶æ€||''}</td><td>${doc.æäº¤æ—¶é—´||''}</td><td><button onclick="deleteDoc('applications','${doc._id}')" class="text-red-600">åˆ é™¤</button></td></tr>`;
        });
        html += '</tbody></table>';
        document.getElementById('appTableContainer').innerHTML = html;
    }

    // é™¢æ ¡åº“ (ä¸¥æ ¼æŒ‰ç…§Excelå­—æ®µ)
    async function renderUniversities() {
        const all = await dbUniversities.allDocs({ include_docs: true });
        const rows = all.rows.map(r => r.doc).filter(d => !d._id.startsWith('_design'));
        document.getElementById('uniCount').innerText = rows.length;
        let html = '<table><thead><tr><th>åœ°ç†åˆ†åŒº</th><th>çœä»½</th><th>åŸ¹å…»åœ°ç‚¹</th><th>ä¸“ä¸š</th><th>é™¢æ ¡</th><th>äºŒçº§å­¦é™¢</th><th>å­¦æ ¡æ€§è´¨</th><th>æå‰æ‰¹é¢è¯•</th><th>æŠ¥è€ƒæ¡ä»¶</th><th>ç‰¹æ®Šè¦æ±‚</th><th>å…¨æ—¥åˆ¶å­¦åˆ¶</th><th>éå…¨æ—¥åˆ¶å­¦åˆ¶</th><th>å…¨æ—¥åˆ¶å­¦è´¹</th><th>éå…¨æ—¥åˆ¶å­¦è´¹</th><th>å…¨æ—¥åˆ¶æ‹›ç”Ÿ</th><th>éå…¨æ—¥åˆ¶æ‹›ç”Ÿ</th><th>ä¸Šè¯¾æ—¶é—´</th><th>ä¸Šè¯¾åœ°ç‚¹</th><th>åŸ¹å…»æ–¹å‘</th><th>25å¤è¯•åˆ†æ•°çº¿</th><th>ç®¡è”æ‹›ç”Ÿç®€ç« </th><th>æ€»ç¡•å£«ç®€ç« </th><th>ä¸“ä¸šç›®å½•</th><th>æé¢é“¾æ¥</th><th>æ“ä½œ</th></tr></thead><tbody>';
        // ä¸ºäº†ç®€åŒ–æ˜¾ç¤ºï¼Œåªå±•ç¤ºéƒ¨åˆ†å…³é”®å­—æ®µï¼Œå®é™…å¯æ‰©å±•
        rows.forEach(doc => {
            html += `<tr><td>${doc.geoRegion||''}</td><td>${doc.province||''}</td><td>${doc.city||''}</td><td>${doc.major||''}</td><td>${doc.name||''}</td><td>${doc.college||''}</td><td>${doc.schoolType||''}</td><td>${doc.interview||''}</td><td>${doc.requirements||''}</td><td>${doc.special||''}</td><td>${doc.durationFull||''}</td><td>${doc.durationPart||''}</td><td>${doc.tuitionFull||''}</td><td>${doc.tuitionPart||''}</td><td>${doc.enrollFull||''}</td><td>${doc.enrollPart||''}</td><td>${doc.classTime||''}</td><td>${doc.classLocation||''}</td><td>${doc.directions||''}</td><td>${doc.scoreLine||''}</td><td>${doc.linkMBA||''}</td><td>${doc.linkMaster||''}</td><td>${doc.linkDir||''}</td><td>${doc.linkInterview||''}</td><td><button onclick="editUniversity('${doc._id}')" class="text-blue-600 mr-2">ç¼–è¾‘</button><button onclick="deleteDoc('universities','${doc._id}')" class="text-red-600">åˆ é™¤</button></td></tr>`;
        });
        html += '</tbody></table>';
        document.getElementById('uniTableContainer').innerHTML = html;
    }

    // å½•å–åˆ†ææ•°æ®
    async function renderAnalysis() {
        const all = await dbAdmission.allDocs({ include_docs: true });
        const rows = all.rows.map(r => r.doc).filter(d => !d._id.startsWith('_design'));
        document.getElementById('analysisCount').innerText = rows.length;
        let html = '<table><thead><tr><th>å¹´ä»½</th><th>é™¢æ ¡</th><th>é™¢åŒº</th><th>ä¸“ä¸š</th><th>å›½å®¶çº¿</th><th>é™¢æ ¡çº¿</th><th>å­¦ä¹ å½¢å¼</th><th>åˆè¯•åˆ†æ•°æ®µ</th><th>äººæ•°åˆ†å¸ƒ</th><th>å½•å–äººæ•°</th><th>å½•å–æ¯”ä¾‹</th><th>æ“ä½œ</th></tr></thead><tbody>';
        rows.forEach(doc => {
            html += `<tr><td>${doc.year||''}</td><td>${doc.university||''}</td><td>${doc.region||''}</td><td>${doc.major||''}</td><td>${doc.nationalScore||''}</td><td>${doc.universityScore||''}</td><td>${doc.studyMode||''}</td><td>${doc.scoreRange||''}</td><td>${doc.applicantCount||''}</td><td>${doc.admittedCount||''}</td><td>${doc.admissionRate||''}</td><td><button onclick="deleteDoc('admission_analysis','${doc._id}')" class="text-red-600">åˆ é™¤</button></td></tr>`;
        });
        html += '</tbody></table>';
        document.getElementById('analysisTableContainer').innerHTML = html;
    }

    // åœ°ç†åˆ†åŒºè¡¨
    function renderRegions() {
        let html = '<table><thead><tr><th>åœ°ç†åˆ†åŒº</th><th>çœä»½åˆ—è¡¨</th></tr></thead><tbody>';
        for (let region in regionProvinces) {
            html += `<tr><td>${region}</td><td>${regionProvinces[region].join('ã€')}</td></tr>`;
        }
        html += '</tbody></table>';
        document.getElementById('regionTableContainer').innerHTML = html;
    }

    // åˆ é™¤æ–‡æ¡£
    window.deleteDoc = async function(dbName, id) {
        if (!requireAdmin()) return;
        if (!confirm('ç¡®å®šåˆ é™¤ï¼Ÿ')) return;
        const db = dbName === 'applications' ? dbApplications : (dbName === 'universities' ? dbUniversities : dbAdmission);
        try {
            const doc = await db.get(id);
            await db.remove(doc);
            renderCurrentTab();
        } catch (e) { alert('åˆ é™¤å¤±è´¥'); }
    };

    // æ–°å¢é™¢æ ¡ (ç®€æ˜“)
    window.addUniversity = function() {
        if (!requireAdmin()) return;
        alert('æ–°å¢é™¢æ ¡è¯·ä½¿ç”¨å¯¼å…¥Excelæˆ–æ‰‹åŠ¨ç¼–å†™ä»£ç ï¼Œæœ¬æ¼”ç¤ºä»…å±•ç¤ºåˆ—è¡¨ã€‚');
    };

    // ç¼–è¾‘é™¢æ ¡ (ç®€æ˜“)
    window.editUniversity = async function(id) {
        if (!requireAdmin()) return;
        alert('ç¼–è¾‘åŠŸèƒ½å¾…å®Œå–„ï¼Œå¯ç›´æ¥æ“ä½œæ•°æ®åº“ã€‚');
    };

    // æ–°å¢åˆ†æè®°å½•
    window.addAnalysis = function() {
        if (!requireAdmin()) return;
        alert('æ–°å¢åˆ†æè®°å½•è¯·ä½¿ç”¨å¯¼å…¥Excelæˆ–æ‰‹åŠ¨ç¼–å†™ä»£ç ã€‚');
    };

    // å¯¼å‡ºè¡¨æ ¼
    window.exportTable = async function(type) {
        if (!requireAdmin()) return;
        let data, filename;
        if (type === 'applications') {
            const all = await dbApplications.allDocs({ include_docs: true });
            const rows = all.rows.map(r => r.doc).filter(d => !d._id.startsWith('_design'));
            filename = 'æŠ¥è€ƒæ„å‘è¡¨.csv';
            data = 'å§“å,å‡†è€ƒè¯å·,æŠ¥è€ƒé™¢æ ¡,ä¸“ä¸š,å­¦ä¹ å½¢å¼,æ„å‘çœä»½,æ„å‘åŸå¸‚,å·é¢æ€»åˆ†,è‹±è¯­,ç®¡ç»¼,åŠ åˆ†,æœ‰æ•ˆæ€»åˆ†,è€ƒè¯•æ—¶é—´,æ¨èçŠ¶æ€,æäº¤æ—¶é—´\n' + rows.map(r => `${r.å§“å},${r.å‡†è€ƒè¯å·},${r.æŠ¥è€ƒé™¢æ ¡},${r.æŠ¥è€ƒä¸“ä¸š},${r.å­¦ä¹ å½¢å¼},${r.æ„å‘çœä»½},${r.æ„å‘åŸå¸‚},${r.å·é¢æ€»åˆ†},${r.è‹±è¯­å•ç§‘},${r.ç®¡ç»¼å•ç§‘},${r.åŠ åˆ†},${r.æœ‰æ•ˆæ€»åˆ†},${r.è€ƒè¯•æ—¶é—´},${r.æ¨èçŠ¶æ€},${r.æäº¤æ—¶é—´}`).join('\n');
        } else if (type === 'universities') {
            const all = await dbUniversities.allDocs({ include_docs: true });
            const rows = all.rows.map(r => r.doc).filter(d => !d._id.startsWith('_design'));
            filename = 'é™¢æ ¡åº“.csv';
            data = 'é™¢æ ¡åç§°,çœä»½,åŸ¹å…»åœ°ç‚¹,ä¸“ä¸š,å­¦æ ¡æ€§è´¨,å…¨æ—¥åˆ¶å­¦è´¹,éå…¨æ—¥åˆ¶å­¦è´¹,åˆ†æ•°çº¿\n' + rows.map(r => `${r.name},${r.province},${r.city},${r.major},${r.schoolType},${r.tuitionFull||''},${r.tuitionPart||''},${r.scoreLine}`).join('\n');
        } else if (type === 'analysis') {
            const all = await dbAdmission.allDocs({ include_docs: true });
            const rows = all.rows.map(r => r.doc).filter(d => !d._id.startsWith('_design'));
            filename = 'å½•å–åˆ†æ.csv';
            data = 'å¹´ä»½,é™¢æ ¡,é™¢åŒº,ä¸“ä¸š,å›½å®¶çº¿,é™¢æ ¡çº¿,å­¦ä¹ å½¢å¼,åˆè¯•åˆ†æ•°æ®µ,äººæ•°åˆ†å¸ƒ,å½•å–äººæ•°,å½•å–æ¯”ä¾‹\n' + rows.map(r => `${r.year},${r.university},${r.region},${r.major},${r.nationalScore},${r.universityScore},${r.studyMode},${r.scoreRange},${r.applicantCount},${r.admittedCount},${r.admissionRate}`).join('\n');
        } else return;
        const blob = new Blob(['\uFEFF' + data], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = filename;
        link.click();
    };

    // åˆå§‹æ¸²æŸ“
    renderApplications();
})();
</script>
</body>
</html>