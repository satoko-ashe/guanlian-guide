<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½è¯¾ç¨‹è¡¨ Â· æ—¥å†è§†å›¾</title>
    <style>
        /* === å…¨å±€æ ·å¼ (ä¸åŸä¸€è‡´ï¼Œç•¥ä½œç²¾ç®€) === */
        * { box-sizing: border-box; font-family: 'Segoe UI', Roboto, sans-serif; }
        body {
            background: #f4f7fb; margin: 0; min-height: 100vh; display: flex;
            align-items: center; justify-content: center; padding: 20px;
        }
        .login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); backdrop-filter: blur(4px);
            display: flex; align-items: center; justify-content: center; z-index: 1000;
        }
        .login-card {
            background: white; border-radius: 32px; padding: 30px 40px;
            width: 400px; box-shadow: 0 30px 50px rgba(0,0,0,0.2);
        }
        .login-tabs { display: flex; gap: 10px; margin: 20px 0; }
        .tab-btn {
            flex: 1; padding: 12px; border: none; background: #eef2f7; border-radius: 40px;
            font-weight: 600; cursor: pointer; transition: 0.2s;
        }
        .tab-btn.active { background: #1e2f41; color: white; }
        .login-form { display: none; flex-direction: column; gap: 15px; }
        .login-form.active { display: flex; }
        .login-form input, .login-form select {
            padding: 14px 18px; border: 1px solid #cfddee; border-radius: 40px;
            font-size: 1rem; outline: none;
        }
        .login-btn {
            background: #1e2f41; color: white; border: none; padding: 16px;
            border-radius: 40px; font-weight: 700; font-size: 1.1rem; cursor: pointer;
        }
        .login-hint { font-size: 0.8rem; color: #6b7b8f; text-align: center; }

        .card {
            max-width: 1400px; width: 100%; background: white; border-radius: 32px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.08); padding: 28px 30px 36px;
        }
        .header {
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 28px; flex-wrap: wrap; gap: 15px;
        }
        .title-section h1 { font-size: 1.9rem; font-weight: 600; margin: 0 0 6px 0; color: #1a2639; }
        .current-month input {
            font-size: 1.2rem; border: 1px solid #cfddee; border-radius: 40px;
            padding: 6px 16px; background: #eef2f7; color: #1f2a3f; font-weight: 500;
        }
        .filter-area { display: flex; align-items: center; gap: 18px; flex-wrap: wrap; }
        .filter-label { font-weight: 600; color: #2c3e50; }
        #classFilter {
            padding: 12px 24px; border-radius: 40px; border: 1px solid #cfddee;
            background: white; font-size: 1rem; min-width: 240px; cursor: pointer;
        }
        .admin-btn, .logout-btn {
            padding: 10px 18px; border-radius: 40px; border: none; font-weight: 600;
            cursor: pointer; background: #eef2f7;
        }
        .admin-btn { background: #ffecbb; }
        .logout-btn { background: #ffe1d9; color: #a13e2d; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 14px; margin: 20px 0; }
        .weekday { text-align: center; font-weight: 600; color: #2c3e50; background: #e6edf6; padding: 12px; border-radius: 30px; }
        .calendar-cell {
            background: white; border: 1px solid #e2eaf2; border-radius: 24px; padding: 14px 10px 10px 14px;
            min-height: 150px; position: relative; box-shadow: 0 4px 12px rgba(0,0,0,0.02);
            display: flex; flex-direction: column; cursor: pointer;
        }
        .calendar-cell.has-lesson-future { background-color: #fff3f0; border-color: #f8c3b3; }
        .calendar-cell.has-lesson-past { background-color: #eceff4; border-color: #c0cbd8; }
        .cell-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px; }
        .date-info { font-weight: 600; font-size: 1.1rem; }
        .weekday-sm { font-size: 0.75rem; color: #6b7b8f; margin-left: 4px; }
        .lesson-badge {
            background: #e34f4f; color: white; font-size: 0.8rem; font-weight: 700;
            min-width: 24px; height: 24px; border-radius: 30px; display: flex;
            align-items: center; justify-content: center; padding: 0 6px;
        }
        .period-row { display: flex; justify-content: space-around; margin-top: 8px; border-top: 1px dashed #d8e2ed; padding-top: 12px; }
        .period-item { font-size: 0.9rem; font-weight: 500; color: #9aabbc; display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .period-item.active-future { color: #c44536; font-weight: 700; }
        .period-item.active-past { color: #6f7c8f; font-weight: 700; }
        .period-item .period-name { background: #f0f5fa; padding: 4px 8px; border-radius: 30px; }
        .period-item.active-future .period-name { background: #fce9e5; color: #b13e2d; }
        .period-item.active-past .period-name { background: #e1e6ec; color: #4a5a6e; }
        .detail-panel { background: #f8fafd; border-radius: 28px; padding: 24px 30px; margin-top: 20px; border: 1px solid #d9e4f0; }
        .lesson-list { display: flex; flex-direction: column; gap: 12px; max-height: 400px; overflow-y: auto; }
        .lesson-item {
            background: white; border-radius: 18px; padding: 16px 22px; display: flex;
            flex-wrap: wrap; align-items: center; gap: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.02);
            border: 1px solid #e2eaf1; position: relative;
        }
        .lesson-subject { font-weight: 700; font-size: 1.15rem; min-width: 180px; color: #153243; cursor: pointer; }
        .lesson-time { background: #eef4fa; padding: 6px 16px; border-radius: 40px; }
        .lesson-hours { background: #dde9f5; padding: 6px 16px; border-radius: 40px; font-weight: 600; }
        .lesson-teacher { display: flex; align-items: center; gap: 6px; color: #40627c; }
        .read-tag { color: green; font-weight: 600; margin-left: 10px; font-size: 0.9rem; }
        .status-btns { display: flex; gap: 8px; margin-left: auto; }
        .status-btn { border: 1px solid #ccc; background: white; border-radius: 20px; padding: 4px 12px; cursor: pointer; }
        .status-btn.active { background: #1e2f41; color: white; border-color: #1e2f41; }
        .add-course-btn { margin-top: 16px; padding: 12px; width: 100%; border-radius: 40px; background: #1e2f41; color: white; font-weight: 600; border: none; cursor: pointer; }
    </style>
    <!-- å¼•å…¥ PouchDB -->
    <script src="https://cdn.jsdelivr.net/npm/pouchdb@8.0.1/dist/pouchdb.min.js"></script>
</head>
<body>
    <!-- ç™»å½•é®ç½©å±‚ -->
    <div id="loginOverlay" class="login-overlay">
        <div class="login-card">
            <h2>ğŸ“˜ è¯¾ç¨‹è¡¨ç™»å½•</h2>
            <div class="login-tabs">
                <button class="tab-btn active" id="studentTab">å­¦å‘˜ç™»å½•</button>
                <button class="tab-btn" id="adminTab">ç®¡ç†å‘˜ç™»å½•</button>
            </div>
            <!-- å­¦å‘˜ç™»å½•è¡¨å• -->
            <div id="studentLoginForm" class="login-form active">
                <input type="text" id="studentName" placeholder="å§“å" value="å¼ ä¸‰">
                <input type="tel" id="studentPhone" placeholder="æ‰‹æœºå·" value="13800138000">
                <select id="studentClass"></select>
                <button id="studentLoginBtn" class="login-btn">è¿›å…¥è¯¾ç¨‹è¡¨</button>
                <p class="login-hint">è¯·ä½¿ç”¨èŠ±åå†Œä¸­çš„å§“åã€æ‰‹æœºå·å’Œç­çº§ç™»å½•</p>
            </div>
            <!-- ç®¡ç†å‘˜ç™»å½•è¡¨å• -->
            <div id="adminLoginForm" class="login-form">
                <input type="text" id="adminUser" placeholder="è´¦å·" value="admin">
                <input type="password" id="adminPwd" placeholder="å¯†ç " value="2026">
                <button id="adminLoginBtn" class="login-btn">ç®¡ç†å‘˜ç™»å½•</button>
            </div>
        </div>
    </div>

    <!-- ä¸»ç•Œé¢ -->
    <div id="mainApp" class="card" style="display: none;">
        <div class="header">
            <div class="title-section">
                <h1>ğŸ“… è€ƒæœŸè¯¾ç¨‹è¡¨</h1>
                <div class="current-month">
                    <input type="month" id="monthPicker" value="2025-04">
                </div>
            </div>
            <div class="filter-area">
                <span class="filter-label">ç­çº§ï¼š</span>
                <select id="classFilter" disabled></select>
                <!-- åå°ç®¡ç†æŒ‰é’®é“¾æ¥æ”¹ä¸º course-admin.html -->
                <button id="adminManageBtn" style="display: none;" class="admin-btn" onclick="window.open('course-admin.html', '_blank')">âš™ï¸ åå°ç®¡ç†</button>
                <button id="logoutBtn" class="logout-btn">ğŸšª é€€å‡º</button>
            </div>
        </div>

        <!-- æ—¥å†æ˜ŸæœŸ -->
        <div class="calendar-grid" id="weekdays-container">
            <div class="weekday">å‘¨æ—¥</div><div class="weekday">å‘¨ä¸€</div><div class="weekday">å‘¨äºŒ</div>
            <div class="weekday">å‘¨ä¸‰</div><div class="weekday">å‘¨å››</div><div class="weekday">å‘¨äº”</div><div class="weekday">å‘¨å…­</div>
        </div>
        <!-- æ—¥å†ç½‘æ ¼ -->
        <div class="calendar-grid" id="calendar-container"></div>

        <!-- è¯¦æƒ…é¢æ¿ -->
        <div class="detail-panel" id="detailPanel">
            <div class="detail-title">
                ğŸ“‹ è¯¾ç¨‹è¯¦æƒ…
                <span id="selected-date-label">è¯·ç‚¹å‡»æ—¥æœŸ</span>
            </div>
            <div id="lessonDetailList" class="lesson-list"></div>
            <button id="addCourseBtn" class="add-course-btn" style="display: none;">+ æ–°å¢è¯¾ç¨‹</button>
        </div>
    </div>

    <!-- æ•°æ®åŠ è½½æç¤º -->
    <div id="loading" style="display: none; text-align: center;">åŠ è½½æ•°æ®ä¸­...</div>

    <script>
        (function() {
            // ---------- CouchDB é…ç½® ----------
            const COUCHDB_URL = 'http://satoko:1793364876@192.168.5.4:5984'; // è¯·æ ¹æ®å®é™…éƒ¨ç½²ä¿®æ”¹

            // ---------- æ•°æ®åº“å·¥å‚ ----------
            const createDB = (name) => {
                const localDB = new PouchDB(name);
                if (COUCHDB_URL) {
                    const remoteDB = new PouchDB(`${COUCHDB_URL}/${name}`);
                    localDB.sync(remoteDB, { live: true, retry: true })
                        .on('error', console.warn);
                }
                return localDB;
            };

            // ---------- PouchDB å®ä¾‹ ----------
            const dbClasses = createDB('classes');
            const dbProducts = createDB('products');
            const dbStaff = createDB('course_staff');      // æ•™åŠ¡/è®²å¸ˆå‘˜å·¥è¡¨
            const dbCourses = createDB('courses');
            const dbStudents = createDB('students');
            const dbSpecials = createDB('specials');
            const dbClickRecords = createDB('click_records');
            const dbCustomStatus = createDB('custom_status');
            const dbAttendance = createDB('attendance');

            // ---------- é»˜è®¤æ•°æ® (ä¸åŸdata.jsä¿æŒä¸€è‡´ï¼Œä½†æ·»åŠ é‚®ç®±å­—æ®µåˆ°å‘˜å·¥è¡¨) ----------
            const defaultClasses = [
                { id: 1, name: '25è€ƒæœŸ1ç­', period: '25è€ƒæœŸ' }, { id: 2, name: '25è€ƒæœŸ2ç­', period: '25è€ƒæœŸ' },
                { id: 3, name: '25è€ƒæœŸ3ç­', period: '25è€ƒæœŸ' }, { id: 4, name: '25è€ƒæœŸ4ç­', period: '25è€ƒæœŸ' },
                { id: 5, name: '25è€ƒæœŸ5ç­', period: '25è€ƒæœŸ' }, { id: 6, name: '25è€ƒæœŸ6ç­', period: '25è€ƒæœŸ' },
                { id: 7, name: '25è€ƒæœŸ7ç­', period: '25è€ƒæœŸ' }, { id: 8, name: '25è€ƒæœŸ8ç­', period: '25è€ƒæœŸ' },
                { id: 9, name: '25è€ƒæœŸ9ç­', period: '25è€ƒæœŸ' }, { id: 10, name: '26è€ƒæœŸ1ç­', period: '26è€ƒæœŸ' },
                { id: 11, name: '26è€ƒæœŸ2ç­', period: '26è€ƒæœŸ' }, { id: 12, name: '26è€ƒæœŸ3ç­', period: '26è€ƒæœŸ' },
                { id: 13, name: '26è€ƒæœŸ4ç­', period: '26è€ƒæœŸ' }, { id: 14, name: '26è€ƒæœŸ5ç­', period: '26è€ƒæœŸ' },
                { id: 15, name: '26è€ƒæœŸ6ç­', period: '26è€ƒæœŸ' }, { id: 16, name: '26è€ƒæœŸ7ç­', period: '26è€ƒæœŸ' },
                { id: 17, name: '26è€ƒæœŸ8ç­', period: '26è€ƒæœŸ' }, { id: 18, name: '26è€ƒæœŸ9ç­', period: '26è€ƒæœŸ' },
                { id: 19, name: '27è€ƒæœŸ1ç­', period: '27è€ƒæœŸ' }, { id: 20, name: '27è€ƒæœŸ2ç­', period: '27è€ƒæœŸ' },
                { id: 21, name: '27è€ƒæœŸ3ç­', period: '27è€ƒæœŸ' }
            ];
            const defaultProducts = [
                { id: 1, name: 'ã€Šç²¾å“ä¿éšœç­ã€‹', subjects: ['æ•°å­¦é¢„å¤‡', 'æ¨¡æ‹Ÿæµ‹è¯•', 'è‹±è¯­å†™ä½œ', 'è‹±è¯­é˜…è¯»', 'å†™ä½œåŸºç¡€', 'é€»è¾‘å¯¼è®º', 'è‹±è¯­åŸºç¡€å¿…ä¿®'] },
                { id: 2, name: 'ã€Šå…¨èƒ½å­¦ä¹ ç­ã€‹', subjects: ['è‹±è¯­å¯¼å­¦å…¥é—¨', 'æ•°å­¦å¯¼å­¦å…¥é—¨', 'æ•°å­¦é¢„å¤‡', 'æ¨¡æ‹Ÿæµ‹è¯•', 'è‹±è¯­å†™ä½œ', 'è‹±è¯­é˜…è¯»', 'å†™ä½œåŸºç¡€', 'é€»è¾‘å¯¼è®º', 'è‹±è¯­åŸºç¡€å¿…ä¿®'] },
                { id: 3, name: 'ã€Šé«˜çº§å¥—é¤ç­ã€‹', subjects: ['è‹±è¯­å¯¼å­¦å…¥é—¨', 'æ•°å­¦å¯¼å­¦å…¥é—¨', 'æ”¿æ²»åŸºç¡€æ¢³ç†', 'æ•°å­¦é¢„å¤‡', 'æ¨¡æ‹Ÿæµ‹è¯•', 'è‹±è¯­å†™ä½œ', 'è‹±è¯­é˜…è¯»', 'å†™ä½œåŸºç¡€', 'é€»è¾‘å¯¼è®º', 'è‹±è¯­åŸºç¡€å¿…ä¿®', 'åå¸ˆç²¾è®²è¯¾'] }
            ];
            const defaultStaff = [
                { id: 1, name: 'ç®¡ç†å‘˜', account: 'admin', password: '2026', email: 'admin@example.com' },
                { id: 2, name: 'æè€å¸ˆ', account: 'lisan', password: '2025', email: 'lisan@example.com' },
                { id: 3, name: 'ç‹è€å¸ˆ', account: 'wang', password: '2025', email: 'wang@example.com' },
                { id: 4, name: 'å¼ è€å¸ˆ', account: 'zhang', password: '2025', email: 'zhang@example.com' }
            ];
            const defaultCourses = [
                { id: 1, class_id: 1, category: 'è‹±è¯­å¯¼å­¦å…¥é—¨', subject_name: 'è‹±è¯­å¯¼å­¦å…¥é—¨1', teacher: 'æ¥è¶…', course_date: '2025-04-12', period: 'evening', start_time: '19:30', end_time: '21:30', hours: 2.0, link: 'https://example.com/english1' },
                { id: 2, class_id: 1, category: 'æ”¿æ²»åŸºç¡€æ¢³ç†', subject_name: 'æ”¿æ²»åŸºç¡€æ¢³ç†', teacher: 'èµµå“', course_date: '2025-04-12', period: 'morning', start_time: '09:00', end_time: '11:00', hours: 2.0, link: '' },
                { id: 3, class_id: 1, category: 'æ•°å­¦é¢„å¤‡', subject_name: 'æ•°å­¦é¢„å¤‡', teacher: 'æé˜³', course_date: '2025-04-15', period: 'afternoon', start_time: '14:00', end_time: '16:30', hours: 2.5, link: '' },
                { id: 4, class_id: 1, category: 'æ¨¡æ‹Ÿæµ‹è¯•', subject_name: 'æ¨¡æ‹Ÿæµ‹è¯•', teacher: 'ä½•ç¿”', course_date: '2025-04-22', period: 'morning', start_time: '08:30', end_time: '11:30', hours: 3.0, link: '' },
                { id: 5, class_id: 1, category: 'è‹±è¯­å†™ä½œ', subject_name: 'è‹±è¯­å†™ä½œ', teacher: 'æ¥è¶…', course_date: '2025-04-22', period: 'evening', start_time: '19:00', end_time: '21:00', hours: 2.0, link: '' },
                { id: 6, class_id: 2, category: 'è‹±è¯­é˜…è¯»', subject_name: 'è‹±è¯­é˜…è¯»', teacher: 'é™ˆé›…', course_date: '2025-04-12', period: 'morning', start_time: '10:00', end_time: '12:00', hours: 2.0, link: '' },
                { id: 7, class_id: 2, category: 'å†™ä½œåŸºç¡€', subject_name: 'å†™ä½œåŸºç¡€', teacher: 'ç‹ä¸½', course_date: '2025-04-21', period: 'afternoon', start_time: '13:30', end_time: '15:30', hours: 2.0, link: '' },
                { id: 8, class_id: 3, category: 'é€»è¾‘å¯¼è®º', subject_name: 'é€»è¾‘å¯¼è®º', teacher: 'å‘¨å²©', course_date: '2025-04-20', period: 'evening', start_time: '18:30', end_time: '20:30', hours: 2.0, link: '' },
                { id: 9, class_id: 1, category: 'è‹±è¯­å¯¼å­¦å…¥é—¨', subject_name: 'è‹±è¯­å¯¼å­¦å…¥é—¨2', teacher: 'æ¥è¶…', course_date: '2025-05-21', period: 'evening', start_time: '19:00', end_time: '21:00', hours: 2.0, link: '' },
                { id: 11, class_id: 1, category: 'è‹±è¯­åŸºç¡€å¿…ä¿®', subject_name: 'è‹±è¯­åŸºç¡€å¿…ä¿®3', teacher: 'æ¥è¶…', course_date: '2025-07-23', period: 'evening', start_time: '19:00', end_time: '21:00', hours: 2.0, link: '' },
                { id: 12, class_id: 1, category: 'è‹±è¯­åŸºç¡€å¿…ä¿®', subject_name: 'è‹±è¯­åŸºç¡€å¿…ä¿®4', teacher: 'æ¥è¶…', course_date: '2025-05-24', period: 'morning', start_time: '10:00', end_time: '12:00', hours: 2.0, link: '' },
                { id: 13, class_id: 1, category: 'è‹±è¯­åŸºç¡€å¿…ä¿®', subject_name: 'è‹±è¯­åŸºç¡€å¿…ä¿®5', teacher: 'æ¥è¶…', course_date: '2025-04-25', period: 'afternoon', start_time: '13:30', end_time: '15:30', hours: 2.0, link: '' },
                { id: 21, class_id: 7, category: 'è‹±è¯­åŸºç¡€å¿…ä¿®', subject_name: 'è‹±è¯­åŸºç¡€å¿…ä¿®3', teacher: 'é™ˆé›…', course_date: '2025-07-23', period: 'evening', start_time: '19:00', end_time: '21:00', hours: 2.0, link: '' },
                { id: 22, class_id: 7, category: 'è‹±è¯­åŸºç¡€å¿…ä¿®', subject_name: 'è‹±è¯­åŸºç¡€å¿…ä¿®4', teacher: 'é™ˆé›…', course_date: '2025-05-24', period: 'morning', start_time: '10:00', end_time: '12:00', hours: 2.0, link: '' },
                { id: 23, class_id: 7, category: 'è‹±è¯­åŸºç¡€å¿…ä¿®', subject_name: 'è‹±è¯­åŸºç¡€å¿…ä¿®5', teacher: 'é™ˆé›…', course_date: '2025-04-25', period: 'afternoon', start_time: '13:30', end_time: '15:30', hours: 2.0, link: '' },
                { id: 24, class_id: 7, category: 'è‹±è¯­åŸºç¡€å¿…ä¿®', subject_name: 'è‹±è¯­åŸºç¡€å¿…ä¿®6', teacher: 'é™ˆé›…', course_date: '2025-04-26', period: 'evening', start_time: '19:00', end_time: '21:00', hours: 2.0, link: '' }
            ];
            const defaultStudents = [
                { id: 1, name: 'å¼ ä¸‰', phone: '13800138000', product_name: 'ã€Šç²¾å“ä¿éšœç­ã€‹', class_id: 1, remark: 'ç¤ºä¾‹' },
                { id: 2, name: 'å¼ å®‡å©·', phone: '18200403276', product_name: 'ã€Šå…¨èƒ½å­¦ä¹ ç­ã€‹', class_id: 5, remark: '24è€ƒæœŸæ²¡è¿‡' },
                { id: 3, name: 'é™ˆç»´ä½³', phone: '13594599932', product_name: 'ã€Šé«˜çº§å¥—é¤ç­ã€‹', class_id: 6, remark: 'è½¬ç­' },
                { id: 4, name: 'æ²ˆå¦™èŠ¹', phone: '18181843560', product_name: 'ã€Šç²¾å“ä¿éšœç­ã€‹', class_id: 6, remark: '' }
            ];
            const defaultSpecials = [
                { id: 1, name: 'å¼ ä¸‰', phone: '13800138000', product_name: 'ã€Šç²¾å“ä¿éšœç­ã€‹', replace_category: 'è‹±è¯­åŸºç¡€å¿…ä¿®', original_class: '25è€ƒæœŸ1ç­', target_class: '25è€ƒæœŸ7ç­' }
            ];

            // å…¨å±€å˜é‡ï¼ˆç¼“å­˜ï¼‰
            let classList = [];
            let products = [];
            let staff = [];
            let courses = [];
            let students = [];
            let specials = [];
            let clickRecords = [];
            let customStatus = [];
            let attendanceRecords = [];

            // åŠ è½½æ‰€æœ‰æ•°æ®ï¼ˆå¦‚æœæ•°æ®åº“ä¸ºç©ºåˆ™å¡«å……é»˜è®¤æ•°æ®ï¼‰
            async function loadAllData() {
                // ç­çº§è¡¨
                const classDocs = await dbClasses.allDocs({ include_docs: true });
                if (classDocs.rows.length === 0) {
                    for (let cls of defaultClasses) {
                        await dbClasses.put({ ...cls, _id: 'class_' + cls.id, _ctime: Date.now() - cls.id * 1000 });
                    }
                }
                classList = (await dbClasses.allDocs({ include_docs: true })).rows.map(r => r.doc);

                // äº§å“è¡¨
                const productDocs = await dbProducts.allDocs({ include_docs: true });
                if (productDocs.rows.length === 0) {
                    for (let p of defaultProducts) {
                        await dbProducts.put({ ...p, _id: 'product_' + p.id, _ctime: Date.now() - p.id * 1000 });
                    }
                }
                products = (await dbProducts.allDocs({ include_docs: true })).rows.map(r => r.doc);

                // å‘˜å·¥è¡¨ï¼ˆæ•™åŠ¡/è®²å¸ˆï¼‰
                const staffDocs = await dbStaff.allDocs({ include_docs: true });
                if (staffDocs.rows.length === 0) {
                    for (let s of defaultStaff) {
                        await dbStaff.put({ ...s, _id: 'staff_' + s.id, _ctime: Date.now() - s.id * 1000 });
                    }
                }
                staff = (await dbStaff.allDocs({ include_docs: true })).rows.map(r => r.doc);

                // è¯¾ç¨‹è¡¨
                const courseDocs = await dbCourses.allDocs({ include_docs: true });
                if (courseDocs.rows.length === 0) {
                    for (let c of defaultCourses) {
                        await dbCourses.put({ ...c, _id: 'course_' + c.id, _ctime: Date.now() - c.id * 1000 });
                    }
                }
                courses = (await dbCourses.allDocs({ include_docs: true })).rows.map(r => r.doc);

                // å­¦å‘˜è¡¨
                const studentDocs = await dbStudents.allDocs({ include_docs: true });
                if (studentDocs.rows.length === 0) {
                    for (let s of defaultStudents) {
                        await dbStudents.put({ ...s, _id: 'student_' + s.id, _ctime: Date.now() - s.id * 1000 });
                    }
                }
                students = (await dbStudents.allDocs({ include_docs: true })).rows.map(r => r.doc);

                // ç‰¹æ®Šæ›´æ¢è¡¨
                const specialDocs = await dbSpecials.allDocs({ include_docs: true });
                if (specialDocs.rows.length === 0) {
                    for (let sp of defaultSpecials) {
                        await dbSpecials.put({ ...sp, _id: 'special_' + sp.id, _ctime: Date.now() - sp.id * 1000 });
                    }
                }
                specials = (await dbSpecials.allDocs({ include_docs: true })).rows.map(r => r.doc);

                // ç‚¹å‡»è®°å½•ç­‰å¯ä¸ºç©º
                clickRecords = (await dbClickRecords.allDocs({ include_docs: true })).rows.map(r => r.doc);
                customStatus = (await dbCustomStatus.allDocs({ include_docs: true })).rows.map(r => r.doc);
                attendanceRecords = (await dbAttendance.allDocs({ include_docs: true })).rows.map(r => r.doc);

                // æš´éœ²ç»™å…¨å±€ï¼ˆæ–¹ä¾¿åŸæœ‰ä»£ç ä½¿ç”¨ï¼‰
                window.classList = classList;
                window.products = products;
                window.staff = staff;
                window.courses = courses;
                window.students = students;
                window.special = specials;
                window.clickRecords = clickRecords;
                window.customStatus = customStatus;
                window.attendanceRecords = attendanceRecords;
            }

            // ä¿å­˜å‡½æ•°ï¼ˆä¿®æ”¹åè°ƒç”¨ï¼‰
            async function saveData(type, data) {
                const dbMap = {
                    class: dbClasses,
                    product: dbProducts,
                    staff: dbStaff,
                    course: dbCourses,
                    student: dbStudents,
                    special: dbSpecials,
                    click: dbClickRecords,
                    custom: dbCustomStatus,
                    attendance: dbAttendance
                };
                const db = dbMap[type];
                if (!db) return;
                for (let item of data) {
                    try {
                        await db.put(item);
                    } catch (e) {
                        // å¯èƒ½_idå†²çªï¼Œå¿½ç•¥
                    }
                }
            }

            // ---------- åŸscript.jsé€»è¾‘ï¼Œä½†æ”¹ä¸ºä½¿ç”¨ç¼“å­˜å˜é‡ï¼Œå¹¶åœ¨ä¿®æ”¹åè°ƒç”¨ä¿å­˜ ----------
            let currentUser = null;
            let isAdmin = false;
            let selectedClassId = 1;
            let currentMonth = '2025-04';
            let selectedDate = '';

            // DOM
            const loginOverlay = document.getElementById('loginOverlay');
            const mainApp = document.getElementById('mainApp');
            const monthPicker = document.getElementById('monthPicker');
            const classFilter = document.getElementById('classFilter');
            const calendarContainer = document.getElementById('calendar-container');
            const detailDateSpan = document.getElementById('selected-date-label');
            const lessonDetailList = document.getElementById('lessonDetailList');
            const adminManageBtn = document.getElementById('adminManageBtn');
            const addCourseBtn = document.getElementById('addCourseBtn');
            const logoutBtn = document.getElementById('logoutBtn');

            // è¾…åŠ©å‡½æ•°
            function getNow() { return new Date(); }
            function isCoursePast(course) {
                const now = getNow();
                const [y, m, d] = course.course_date.split('-').map(Number);
                const [eh, em] = course.end_time.split(':').map(Number);
                const endDate = new Date(y, m-1, d, eh, em, 0);
                return now > endDate;
            }

            function getClassIdByName(name) {
                const c = window.classList.find(cls => cls.name === name);
                return c ? c.id : null;
            }
            window.getClassIdByName = getClassIdByName;

            // è·å–å½“å‰ç”¨æˆ·å¯è§è¯¾ç¨‹åˆ—è¡¨
            function getVisibleCourses() {
                if (!currentUser) return [];
                if (isAdmin) {
                    return window.courses.filter(c => c.class_id === selectedClassId);
                } else {
                    let student = window.students.find(s => s.id === currentUser.id);
                    if (!student) return [];
                    const product = window.products.find(p => p.name === student.product_name);
                    const allowedCategories = product ? product.subjects : [];
                    let baseCourses = window.courses.filter(c => c.class_id === student.class_id && allowedCategories.includes(c.category));

                    const specials = window.special.filter(sp => sp.name === student.name && sp.phone === student.phone);
                    specials.forEach(sp => {
                        const origClassId = getClassIdByName(sp.original_class);
                        const targetClassId = getClassIdByName(sp.target_class);
                        if (!origClassId || !targetClassId) return;
                        baseCourses = baseCourses.filter(c => !(c.class_id === origClassId && c.category === sp.replace_category));
                        const targetCourses = window.courses.filter(c => c.class_id === targetClassId && c.category === sp.replace_category);
                        baseCourses = [...baseCourses, ...targetCourses];
                    });
                    return Array.from(new Map(baseCourses.map(c => [c.id, c])).values());
                }
            }

            function renderClassFilter() {
                let options = window.classList.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
                classFilter.innerHTML = options;
                if (!isAdmin && currentUser) {
                    classFilter.value = currentUser.class_id;
                    classFilter.disabled = true;
                } else {
                    classFilter.disabled = false;
                    classFilter.value = selectedClassId;
                }
            }

            function getMonthDays(year, month) { return new Date(year, month + 1, 0).getDate(); }

            function renderCalendar() {
                const [year, month] = currentMonth.split('-').map(Number);
                const firstDay = new Date(year, month-1, 1).getDay();
                const daysInMonth = getMonthDays(year, month-1);
                const visibleCourses = getVisibleCourses() || [];

                const courseMap = new Map();
                visibleCourses.forEach(c => {
                    if (!courseMap.has(c.course_date)) courseMap.set(c.course_date, []);
                    courseMap.get(c.course_date).push(c);
                });

                let html = '';
                for (let i = 0; i < firstDay; i++) html += `<div class="calendar-cell" style="background:#f6faff;"></div>`;

                for (let d = 1; d <= daysInMonth; d++) {
                    const dateStr = `${year}-${String(month).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                    const coursesToday = courseMap.get(dateStr) || [];
                    const lessonCount = coursesToday.length;
                    const hasAnyFuture = coursesToday.some(c => !isCoursePast(c));
                    const cellClass = lessonCount ? (hasAnyFuture ? 'has-lesson-future' : 'has-lesson-past') : '';

                    const periods = ['morning', 'afternoon', 'evening'];
                    let periodHtml = '';
                    periods.forEach(p => {
                        const hasFuture = coursesToday.some(c => c.period === p && !isCoursePast(c));
                        const hasCourse = coursesToday.some(c => c.period === p);
                        let activeClass = '';
                        if (hasCourse) activeClass = hasFuture ? 'active-future' : 'active-past';
                        periodHtml += `<div class="period-item ${activeClass}"><span class="period-name">${p==='morning'?'ä¸Šåˆ':p==='afternoon'?'ä¸‹åˆ':'æ™šä¸Š'}</span></div>`;
                    });

                    const weekday = new Date(year, month-1, d).getDay();
                    const weekdayStr = ['å‘¨æ—¥','å‘¨ä¸€','å‘¨äºŒ','å‘¨ä¸‰','å‘¨å››','å‘¨äº”','å‘¨å…­'][weekday];

                    html += `
                        <div class="calendar-cell ${cellClass}" data-date="${dateStr}">
                            <div class="cell-header">
                                <span class="date-info">${d} <span class="weekday-sm">${weekdayStr}</span></span>
                                ${lessonCount ? `<span class="lesson-badge">${lessonCount}</span>` : ''}
                            </div>
                            <div class="period-row">${periodHtml}</div>
                        </div>
                    `;
                }
                calendarContainer.innerHTML = html;
            }

            function showDetail(dateStr) {
                selectedDate = dateStr;
                detailDateSpan.textContent = dateStr.replace(/-/g,'/');
                const visibleCourses = getVisibleCourses() || [];
                const coursesToday = visibleCourses.filter(c => c.course_date === dateStr)
                    .sort((a,b) => a.start_time.localeCompare(b.start_time));

                if (!coursesToday.length) {
                    lessonDetailList.innerHTML = '<div class="empty-lessons">ğŸ“­ è¯¥æ—¥æ— è¯¾ç¨‹</div>';
                    return;
                }
                let html = '';
                coursesToday.forEach(c => {
                    const isPast = isCoursePast(c);
                    const hasClicked = currentUser && window.clickRecords.some(r => r.userId === currentUser.id && r.courseId === c.id);
                    const userStatus = currentUser ? (window.customStatus.find(s => s.userId === currentUser.id && s.courseId === c.id)?.status || 'waiting') : 'waiting';
                    const statusText = { attended: 'å·²å‡ºå‹¤', waiting: 'å¾…è§‚çœ‹', review: 'éœ€é‡æ¸©' };
                    const attendance = currentUser ? window.attendanceRecords.find(a => a.userId === currentUser.id && a.courseId === c.id) : null;
                    const actualHours = attendance ? ` (å®åˆ° ${attendance.actualHours}h)` : '';

                    html += `
                        <div class="lesson-item" data-course-id="${c.id}">
                            <span class="lesson-subject" data-link="${c.link || ''}" onclick="if(this.dataset.link) { window.open(this.dataset.link); window.recordClick(${c.id}); }">ğŸ“˜ ${c.subject_name}</span>
                            <span class="lesson-time">${c.start_time}-${c.end_time}</span>
                            <span class="lesson-hours">â±ï¸ ${c.hours}h${actualHours}</span>
                            <span class="lesson-teacher">${c.teacher}</span>
                            ${hasClicked ? '<span class="read-tag">âœ… å·²é˜…</span>' : ''}
                            ${!isAdmin && currentUser ? `
                            <div class="status-btns">
                                <button class="status-btn ${userStatus==='attended'?'active':''}" onclick="window.setCustomStatus(${c.id}, 'attended')">å·²å‡ºå‹¤</button>
                                <button class="status-btn ${userStatus==='waiting'?'active':''}" onclick="window.setCustomStatus(${c.id}, 'waiting')">å¾…è§‚çœ‹</button>
                                <button class="status-btn ${userStatus==='review'?'active':''}" onclick="window.setCustomStatus(${c.id}, 'review')">éœ€é‡æ¸©</button>
                            </div>` : ''}
                        </div>
                    `;
                });
                lessonDetailList.innerHTML = html;
            }

            window.recordClick = async function(courseId) {
                if (!currentUser) return;
                if (!window.clickRecords.some(r => r.userId === currentUser.id && r.courseId === courseId)) {
                    const newRec = { userId: currentUser.id, courseId, timestamp: new Date().toISOString(), _id: 'click_' + Date.now() + Math.random() };
                    window.clickRecords.push(newRec);
                    await saveData('click', window.clickRecords);
                    if (selectedDate) showDetail(selectedDate);
                }
            };

            window.setCustomStatus = async function(courseId, status) {
                if (!currentUser) return;
                const existing = window.customStatus.find(s => s.userId === currentUser.id && s.courseId === courseId);
                if (existing) {
                    existing.status = status;
                } else {
                    window.customStatus.push({ userId: currentUser.id, courseId, status, _id: 'custom_' + Date.now() + Math.random() });
                }
                await saveData('custom', window.customStatus);
                showDetail(selectedDate);
            };

            // ç™»å½•éªŒè¯
            const ADMIN_ACCOUNT = 'ç®¡ç†å‘˜';
            const ADMIN_PASSWORD = '2026';

            function initLogin() {
                document.getElementById('studentTab').addEventListener('click', () => {
                    document.getElementById('studentTab').classList.add('active');
                    document.getElementById('adminTab').classList.remove('active');
                    document.getElementById('studentLoginForm').classList.add('active');
                    document.getElementById('adminLoginForm').classList.remove('active');
                });
                document.getElementById('adminTab').addEventListener('click', () => {
                    document.getElementById('adminTab').classList.add('active');
                    document.getElementById('studentTab').classList.remove('active');
                    document.getElementById('adminLoginForm').classList.add('active');
                    document.getElementById('studentLoginForm').classList.remove('active');
                });

                // å­¦å‘˜ç™»å½•
                document.getElementById('studentLoginBtn').addEventListener('click', () => {
                    const name = document.getElementById('studentName').value.trim();
                    const phone = document.getElementById('studentPhone').value.trim();
                    const classId = parseInt(document.getElementById('studentClass').value);
                    const user = window.students.find(r => r.name === name && r.phone === phone && r.class_id === classId);
                    if (user) {
                        currentUser = { ...user, role: 'student' };
                        isAdmin = false;
                        selectedClassId = user.class_id;
                        loginSuccess();
                    } else alert('ä¿¡æ¯ä¸åŒ¹é…æˆ–ä¸åœ¨èŠ±åå†Œä¸­');
                });

                // ç®¡ç†å‘˜ç™»å½• (ä»stafféªŒè¯ + ç¡¬ç¼–ç )
                document.getElementById('adminLoginBtn').addEventListener('click', () => {
                    const account = document.getElementById('adminUser').value;
                    const pwd = document.getElementById('adminPwd').value;

                    // ç®¡ç†å‘˜ç¡¬ç¼–ç 
                    if (account === ADMIN_ACCOUNT && pwd === ADMIN_PASSWORD) {
                        currentUser = { id: 0, name: ADMIN_ACCOUNT, role: 'admin' };
                        isAdmin = true;
                        selectedClassId = 1;
                        loginSuccess();
                        return;
                    }

                    // æ™®é€šå‘˜å·¥éªŒè¯
                    const staffUser = window.staff.find(s => s.account === account && s.password === pwd);
                    if (staffUser) {
                        currentUser = { id: staffUser.id, name: staffUser.name, role: 'admin' };
                        isAdmin = true;
                        selectedClassId = 1;
                        loginSuccess();
                    } else alert('ç®¡ç†å‘˜è´¦å·æˆ–å¯†ç é”™è¯¯');
                });

                // ç­çº§ä¸‹æ‹‰åˆå§‹åŒ–
                const studentClass = document.getElementById('studentClass');
                window.classList.forEach(c => studentClass.add(new Option(c.name, c.id)));
            }

            function loginSuccess() {
                loginOverlay.style.display = 'none';
                mainApp.style.display = 'block';
                monthPicker.value = currentMonth;
                renderClassFilter();
                renderCalendar();
                adminManageBtn.style.display = isAdmin ? 'inline-block' : 'none';
                addCourseBtn.style.display = isAdmin ? 'block' : 'none';
                const todayStr = new Date().toISOString().slice(0,10);
                const visible = getVisibleCourses() || [];
                if (visible.some(c => c.course_date === todayStr)) showDetail(todayStr);
                else lessonDetailList.innerHTML = '<div class="empty-lessons">ç‚¹å‡»æ—¥æœŸæŸ¥çœ‹è¯¾ç¨‹</div>';
            }

            logoutBtn.addEventListener('click', () => { location.reload(); });

            monthPicker.addEventListener('change', (e) => { currentMonth = e.target.value; renderCalendar(); });

            classFilter.addEventListener('change', (e) => {
                selectedClassId = parseInt(e.target.value);
                renderCalendar();
                if (selectedDate) showDetail(selectedDate);
            });

            calendarContainer.addEventListener('click', (e) => {
                const cell = e.target.closest('.calendar-cell');
                if (cell?.dataset.date) showDetail(cell.dataset.date);
            });

            addCourseBtn.addEventListener('click', async () => {
                if (!isAdmin) return;
                const newCourse = {
                    id: Math.max(...window.courses.map(c=>c.id),0)+1,
                    class_id: selectedClassId,
                    category: prompt('è¯¾ç¨‹å¤§ç±» (å¦‚ è‹±è¯­å¯¼å­¦å…¥é—¨)'),
                    subject_name: prompt('ç§‘ç›®åç§°'),
                    teacher: prompt('ä¸»è®²äºº'),
                    course_date: selectedDate || prompt('æ—¥æœŸ YYYY-MM-DD'),
                    period: prompt('æ—¶æ®µ (morning/afternoon/evening)'),
                    start_time: prompt('å¼€å§‹æ—¶é—´ HH:MM'),
                    end_time: prompt('ç»“æŸæ—¶é—´ HH:MM'),
                    hours: parseFloat(prompt('è¯¾æ—¶')),
                    link: prompt('é“¾æ¥') || '',
                    _id: 'course_' + Date.now()
                };
                window.courses.push(newCourse);
                await saveData('course', window.courses);
                renderCalendar();
                if (selectedDate) showDetail(selectedDate);
            });

            // å¯åŠ¨ï¼šå…ˆåŠ è½½æ•°æ®å†åˆå§‹åŒ–ç•Œé¢
            async function start() {
                document.getElementById('loading').style.display = 'block';
                await loadAllData();
                document.getElementById('loading').style.display = 'none';
                initLogin();
            }
            start();
        })();
    </script>
</body>
</html>