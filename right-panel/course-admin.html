<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¯¾ç¨‹è¡¨åå°ç®¡ç† Â· åºå·æ’åºç‰ˆ</title>
    <!-- Font Awesome å›¾æ ‡åº“ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- å¼•å…¥ PouchDB -->
    <script src="https://cdn.jsdelivr.net/npm/pouchdb@8.0.1/dist/pouchdb.min.js"></script>
    <style>
        * { box-sizing: border-box; font-family: 'Segoe UI', Roboto, sans-serif; }
        body {
            background: #f4f7fb; margin: 0; min-height: 100vh; display: flex;
            align-items: flex-start; justify-content: center; padding: 20px;
        }
        .login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); backdrop-filter: blur(4px);
            display: flex; align-items: center; justify-content: center; z-index: 1000;
        }
        .login-card {
            background: white; border-radius: 32px; padding: 30px 40px;
            width: 400px; box-shadow: 0 30px 50px rgba(0,0,0,0.2);
        }
        .login-card h2 { margin-top: 0; }
        .login-form { display: flex; flex-direction: column; gap: 15px; }
        .login-form input {
            padding: 14px 18px; border: 1px solid #cfddee; border-radius: 40px;
            font-size: 1rem; outline: none;
        }
        .login-btn {
            background: #1e2f41; color: white; border: none; padding: 16px;
            border-radius: 40px; font-weight: 700; font-size: 1.1rem; cursor: pointer;
        }

        .card {
            max-width: 1200px; width: 100%; background: white; border-radius: 32px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.08); padding: 28px 30px 36px;
            min-height: calc(100vh - 40px);
            display: flex;
            flex-direction: column;
        }
        .header {
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 28px; flex-wrap: wrap; gap: 15px;
            flex-shrink: 0;
        }
        .title-section h1 { font-size: 1.9rem; font-weight: 600; margin: 0; color: #1a2639; }
        .logout-btn {
            padding: 10px 18px; border-radius: 40px; border: none; font-weight: 600;
            cursor: pointer; background: #ffe1d9; color: #a13e2d;
        }
        .admin-tabs {
            display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;
            border-bottom: 2px solid #e2eaf1; padding-bottom: 10px;
            flex-shrink: 0;
        }
        .admin-tab {
            padding: 8px 20px; border-radius: 40px; background: #d9e2ef; border: none;
            cursor: pointer; font-weight: 600; transition: 0.2s;
        }
        .admin-tab.active { background: #1e2f41; color: white; }
        .admin-section { 
            display: none; 
            flex: 1;
            flex-direction: column;
            min-height: 0;
        }
        .admin-section.active { 
            display: flex; 
        }

        /* è¡¨æ ¼å®¹å™¨ */
        .table-container {
            border: 1px solid #cfddee;
            border-radius: 16px;
            overflow: auto;
            flex: 1;
            min-height: 200px;
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            min-width: 800px;
            table-layout: auto;
        }
        .data-table th {
            background: #d9e2ef;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
            white-space: nowrap;
        }
        .data-table th:first-child,
        .data-table td:first-child {
            min-width: 60px;
            white-space: nowrap;
        }
        .data-table td {
            border-bottom: 1px solid #e2eaf1;
            padding: 12px;
            vertical-align: middle;
            word-break: break-word;
        }
        .data-table tr:hover { background: #f8fafd; }

        /* åºå·å•å…ƒæ ¼å¯ç¼–è¾‘ */
        .order-cell {
            cursor: pointer;
            color: #1e2f41;
            font-weight: 500;
            text-align: center;
        }
        .order-cell:hover {
            background: #e3f0ff;
            text-decoration: underline;
        }
        .order-input {
            width: 60px;
            text-align: center;
            border: 1px solid #1e2f41;
            border-radius: 20px;
            padding: 4px;
            font-weight: 500;
        }

        .editable-cell {
            cursor: text;
            padding: 4px 8px;
            border-radius: 8px;
        }
        .editable-cell:hover { background: #eef2f7; }

        .action-icon {
            color: #4a5a6e;
            margin: 0 6px;
            cursor: pointer;
            font-size: 1rem;
            transition: 0.2s;
        }
        .action-icon:hover { color: #1e2f41; }
        .action-icon.delete:hover { color: #dc3545; }

        .class-tag {
            display: inline-block;
            background: #eef2f7;
            border-radius: 40px;
            padding: 6px 14px;
            margin: 4px 8px 4px 0;
            font-size: 0.9rem;
            border: 1px solid #b0c4de;
            word-break: keep-all;
        }
        .class-tag .remove-icon {
            margin-left: 8px;
            cursor: pointer;
            color: #dc3545;
            font-size: 0.9rem;
        }
        .add-class-icon {
            color: #28a745;
            cursor: pointer;
            margin-left: 10px;
            font-size: 1.1rem;
        }

        .subject-checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            max-width: 100%;
        }
        .subject-checkbox-group label {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: #f0f5fa;
            padding: 5px 14px;
            border-radius: 40px;
            cursor: default;
            border: 1px solid #cfddee;
            font-size: 0.9rem;
            word-break: keep-all;
        }
        .subject-checkbox-group label.checked-label {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }
        .subject-checkbox-group.editable label {
            cursor: pointer;
        }
        .subject-checkbox-group.editable input[type=checkbox] {
            cursor: pointer;
            accent-color: #1e2f41;
        }
        .subject-checkbox-group input[type=checkbox] {
            pointer-events: none;
            accent-color: #1e2f41;
            margin-right: 2px;
        }
        .subject-checkbox-group.editable input[type=checkbox] {
            pointer-events: auto;
        }

        .product-edit-btn {
            background: none;
            border: 1px solid #b0c4de;
            border-radius: 30px;
            padding: 4px 12px;
            font-size: 0.8rem;
            cursor: pointer;
            color: #1e2f41;
            margin-left: 5px;
            white-space: nowrap;
        }
        .product-edit-btn i {
            margin-right: 4px;
        }
        .product-edit-btn.active {
            background: #1e2f41;
            color: white;
            border-color: #1e2f41;
        }

        .product-sub-tabs {
            display: flex;
            gap: 12px;
            margin: 20px 0 10px;
            flex-shrink: 0;
        }
        .product-sub-tab {
            padding: 6px 20px;
            border-radius: 30px;
            background: #e6edf5;
            border: none;
            font-weight: 600;
            cursor: pointer;
        }
        .product-sub-tab.active {
            background: #1e2f41;
            color: white;
        }
        .product-sub-panel {
            display: none;
            flex-direction: column;
            flex: 1;
            min-height: 0;
        }
        .product-sub-panel.active {
            display: flex;
        }

        .pagination {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
            font-size: 0.9rem;
            flex-shrink: 0;
        }
        .pagination button {
            padding: 6px 12px;
            border: 1px solid #cfddee;
            background: white;
            border-radius: 40px;
            cursor: pointer;
        }
        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .pagination input {
            width: 50px;
            text-align: center;
            border: 1px solid #cfddee;
            border-radius: 20px;
            padding: 4px;
        }

        .primary-btn {
            background: #1e2f41;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 40px;
            cursor: pointer;
            font-weight: 600;
            margin: 10px 0 0 0;
            flex-shrink: 0;
            align-self: flex-start;
        }
        .subject-actions {
            display: flex;
            gap: 5px;
            align-items: center;
        }
        .order-hint {
            font-size: 0.85rem;
            color: #6c7a8e;
            margin-left: 15px;
            font-weight: normal;
        }
        .order-hint i {
            margin-right: 4px;
        }
    </style>
</head>
<body>
    <!-- ç™»å½•é®ç½©å±‚ -->
    <div id="loginOverlay" class="login-overlay">
        <div class="login-card">
            <h2>ğŸ” ç®¡ç†å‘˜ç™»å½•</h2>
            <div class="login-form">
                <input type="text" id="adminUser" placeholder="è´¦å·" value="admin">
                <input type="password" id="adminPwd" placeholder="å¯†ç " value="2026">
                <button id="adminLoginBtn" class="login-btn">è¿›å…¥åå°</button>
            </div>
        </div>
    </div>

    <!-- ä¸»ç•Œé¢ -->
    <div id="mainApp" class="card" style="display: none;">
        <div class="header">
            <div class="title-section">
                <h1>âš™ï¸ è¯¾ç¨‹è¡¨åå°ç®¡ç†</h1>
            </div>
            <button id="logoutBtn" class="logout-btn">ğŸšª é€€å‡º</button>
        </div>

        <div class="admin-tabs">
            <button class="admin-tab active" data-tab="classTab">ç­çº§ç®¡ç†</button>
            <button class="admin-tab" data-tab="productTab">äº§å“ç§‘ç›®</button>
            <button class="admin-tab" data-tab="staffTab">èŒå‘˜ç®¡ç†</button>
            <button class="admin-tab" data-tab="specialTab">ç‰¹æ®Šæ›´æ¢</button>
            <button class="admin-tab" data-tab="attendanceTab">å‡ºå‹¤å¤§è¡¨</button>
            <button class="admin-tab" data-tab="importExport">å¯¼å…¥/å¯¼å‡º</button>
        </div>

        <!-- ç­çº§ç®¡ç† -->
        <div id="classTab" class="admin-section active">
            <h4>ğŸ“Œ ç­çº§åˆ—è¡¨ï¼ˆç‚¹å‡»âœ–åˆ é™¤ç­çº§ï¼Œç‚¹å‡»â•å‘è¯¥è€ƒæœŸæ–°å¢ç­çº§ï¼Œè‡ªåŠ¨æŒ‰é¡ºåºæ’åˆ—ï¼‰</h4>
            <div id="classTableContainer" class="table-container"></div>
            <button id="addPeriodBtn" class="primary-btn"><i class="fas fa-plus"></i> æ–°å¢è€ƒæœŸ</button>
        </div>

        <!-- äº§å“ç§‘ç›® -->
        <div id="productTab" class="admin-section">
            <div class="product-sub-tabs">
                <button class="product-sub-tab active" data-subtab="productList">ğŸ“¦ äº§å“ç®¡ç†</button>
                <button class="product-sub-tab" data-subtab="subjectList">ğŸ“š ç§‘ç›®åº“ <span class="order-hint"><i class="fas fa-sort-numeric-down"></i> ç‚¹å‡»åºå·ä¿®æ”¹æ’åº</span></button>
            </div>
            <!-- äº§å“é¢æ¿ -->
            <div id="productListPanel" class="product-sub-panel active">
                <h4 style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap; flex-shrink:0;">
                    äº§å“åˆ—è¡¨
                    <span style="font-size:0.85rem; font-weight:normal; color:#4a5a6e;">
                        <i class="far fa-lightbulb"></i> ç‚¹å‡»äº§å“æ—çš„ç¼–è¾‘æŒ‰é’®å¯ä¿®æ”¹ç§‘ç›®
                    </span>
                </h4>
                <div id="productTableContainer" class="table-container"></div>
                <button id="addProductBtn" class="primary-btn"><i class="fas fa-plus"></i> æ–°å¢äº§å“</button>
            </div>
            <!-- ç§‘ç›®é¢æ¿ (åºå·æ’åº) -->
            <div id="subjectListPanel" class="product-sub-panel">
                <h4 style="flex-shrink:0; display: flex; align-items: center;">
                    ç§‘ç›®åº“ (ç‚¹å‡»åºå·å¯ä¿®æ”¹æ’åºï¼Œæ•°å­—è¶Šå°è¶Šé å‰)
                </h4>
                <div id="subjectTableContainer" class="table-container"></div>
                <button id="addSubjectBtn" class="primary-btn"><i class="fas fa-plus"></i> æ–°å¢ç§‘ç›®</button>
            </div>
        </div>

        <!-- èŒå‘˜ç®¡ç† -->
        <div id="staffTab" class="admin-section">
            <h4>ğŸ‘¥ èŒå‘˜è´¦å·ï¼ˆç‚¹å‡»å•å…ƒæ ¼ç¼–è¾‘ï¼Œæ–°å¢é‚®ç®±å­—æ®µï¼‰</h4>
            <div id="staffTableContainer" class="table-container"></div>
            <button id="addStaffBtn" class="primary-btn"><i class="fas fa-plus"></i> æ–°å¢èŒå‘˜</button>
        </div>

        <!-- ç‰¹æ®Šæ›´æ¢ -->
        <div id="specialTab" class="admin-section">
            <h4>ğŸ”„ å­¦å‘˜ç§‘ç›®æ›´æ¢ï¼ˆç‚¹å‡»å•å…ƒæ ¼ç¼–è¾‘ï¼‰</h4>
            <div id="specialTableContainer" class="table-container"></div>
            <button id="addSpecialBtn" class="primary-btn"><i class="fas fa-plus"></i> æ–°å¢ç‰¹æ®Šæ›´æ¢</button>
        </div>

        <!-- å‡ºå‹¤å¤§è¡¨ -->
        <div id="attendanceTab" class="admin-section">
            <h4>ğŸ“Š å­¦å‘˜å‡ºå‹¤è®°å½•</h4>
            <div id="attendanceTableContainer" class="table-container"></div>
        </div>

        <!-- å¯¼å…¥å¯¼å‡º -->
        <div id="importExport" class="admin-section">
            <h4>ğŸ“¤ å¯¼å…¥/å¯¼å‡ºè¯¾ç¨‹ (CSV)</h4>
            <button id="exportBtn" class="primary-btn"><i class="fas fa-download"></i> å¯¼å‡ºè¯¾ç¨‹</button>
            <input type="file" id="importFile" accept=".csv" style="display: none;">
            <button id="importBtn" class="primary-btn"><i class="fas fa-upload"></i> å¯¼å…¥è¯¾ç¨‹</button>
        </div>
    </div>

    <script>
        (function() {
            // ---------- CouchDB é…ç½® ----------
            const COUCHDB_URL = 'http://satoko:1793364876@localhost:5984'; // è¯·æ ¹æ®å®é™…éƒ¨ç½²ä¿®æ”¹

            // ---------- æ•°æ®åº“å·¥å‚ ----------
            const createDB = (name) => {
                const localDB = new PouchDB(name);
                if (COUCHDB_URL) {
                    const remoteDB = new PouchDB(`${COUCHDB_URL}/${name}`);
                    localDB.sync(remoteDB, { live: true, retry: true })
                        .on('error', console.warn);
                }
                return localDB;
            };

            // ---------- PouchDB å®ä¾‹ ----------
            const dbClasses = createDB('classes');
            const dbProducts = createDB('products');
            const dbSubjects = createDB('subjects');
            const dbCourseStaff = createDB('course_staff');   // æ•™åŠ¡/è®²å¸ˆå‘˜å·¥è¡¨
            const dbCourses = createDB('courses');
            const dbStudents = createDB('students');
            const dbSpecials = createDB('specials');
            const dbAttendance = createDB('attendance');

            // é»˜è®¤æ•°æ® (æ·»åŠ é‚®ç®±å­—æ®µ)
            const defaultClasses = [
                { id: 1, name: '25è€ƒæœŸ1ç­', period: '25è€ƒæœŸ' }, { id: 2, name: '25è€ƒæœŸ2ç­', period: '25è€ƒæœŸ' },
                { id: 3, name: '25è€ƒæœŸ3ç­', period: '25è€ƒæœŸ' }, { id: 4, name: '25è€ƒæœŸ4ç­', period: '25è€ƒæœŸ' },
                { id: 5, name: '25è€ƒæœŸ5ç­', period: '25è€ƒæœŸ' }, { id: 6, name: '25è€ƒæœŸ6ç­', period: '25è€ƒæœŸ' },
                { id: 7, name: '25è€ƒæœŸ7ç­', period: '25è€ƒæœŸ' }, { id: 8, name: '25è€ƒæœŸ8ç­', period: '25è€ƒæœŸ' },
                { id: 9, name: '25è€ƒæœŸ9ç­', period: '25è€ƒæœŸ' }, { id: 10, name: '26è€ƒæœŸ1ç­', period: '26è€ƒæœŸ' },
                { id: 11, name: '26è€ƒæœŸ2ç­', period: '26è€ƒæœŸ' }, { id: 12, name: '26è€ƒæœŸ3ç­', period: '26è€ƒæœŸ' },
                { id: 13, name: '26è€ƒæœŸ4ç­', period: '26è€ƒæœŸ' }, { id: 14, name: '26è€ƒæœŸ5ç­', period: '26è€ƒæœŸ' },
                { id: 15, name: '26è€ƒæœŸ6ç­', period: '26è€ƒæœŸ' }, { id: 16, name: '26è€ƒæœŸ7ç­', period: '26è€ƒæœŸ' },
                { id: 17, name: '26è€ƒæœŸ8ç­', period: '26è€ƒæœŸ' }, { id: 18, name: '26è€ƒæœŸ9ç­', period: '26è€ƒæœŸ' },
                { id: 19, name: '27è€ƒæœŸ1ç­', period: '27è€ƒæœŸ' }, { id: 20, name: '27è€ƒæœŸ2ç­', period: '27è€ƒæœŸ' },
                { id: 21, name: '27è€ƒæœŸ3ç­', period: '27è€ƒæœŸ' }
            ];
            const defaultProducts = [
                { id: 1, name: 'ã€Šç²¾å“ä¿éšœç­ã€‹', subjectIds: [1,2,3,4,5,6,7] },
                { id: 2, name: 'ã€Šå…¨èƒ½å­¦ä¹ ç­ã€‹', subjectIds: [8,9,1,2,3,4,5,6,7] },
                { id: 3, name: 'ã€Šé«˜çº§å¥—é¤ç­ã€‹', subjectIds: [8,9,10,1,2,3,4,5,6,7,11] }
            ];
            const defaultSubjects = [
                { id: 1, name: 'æ•°å­¦é¢„å¤‡' }, { id: 2, name: 'æ¨¡æ‹Ÿæµ‹è¯•' }, { id: 3, name: 'è‹±è¯­å†™ä½œ' },
                { id: 4, name: 'è‹±è¯­é˜…è¯»' }, { id: 5, name: 'å†™ä½œåŸºç¡€' }, { id: 6, name: 'é€»è¾‘å¯¼è®º' },
                { id: 7, name: 'è‹±è¯­åŸºç¡€å¿…ä¿®' }, { id: 8, name: 'è‹±è¯­å¯¼å­¦å…¥é—¨' }, { id: 9, name: 'æ•°å­¦å¯¼å­¦å…¥é—¨' },
                { id: 10, name: 'æ”¿æ²»åŸºç¡€æ¢³ç†' }, { id: 11, name: 'åå¸ˆç²¾è®²è¯¾' }
            ];
            // èŒå‘˜è¡¨ï¼ˆæ•™åŠ¡/è®²å¸ˆï¼‰ï¼Œå¢åŠ é‚®ç®±å­—æ®µ
            const defaultCourseStaff = [
                { id: 1, è´¦å·: 'admin', å¯†ç : '2026', é‚®ç®±: 'admin@example.com', æ˜¯å¦å¯ç”¨è¯¥è´¦å·: 'æ˜¯', å¤‡æ³¨: 'è¶…çº§ç®¡ç†å‘˜' },
                { id: 2, è´¦å·: 'lisan', å¯†ç : '2025', é‚®ç®±: 'lisan@example.com', æ˜¯å¦å¯ç”¨è¯¥è´¦å·: 'æ˜¯', å¤‡æ³¨: 'æ•™åŠ¡è€å¸ˆ' },
                { id: 3, è´¦å·: 'wang', å¯†ç : '2025', é‚®ç®±: 'wang@example.com', æ˜¯å¦å¯ç”¨è¯¥è´¦å·: 'æ˜¯', å¤‡æ³¨: 'è®²å¸ˆ' },
                { id: 4, è´¦å·: 'zhang', å¯†ç : '2025', é‚®ç®±: 'zhang@example.com', æ˜¯å¦å¯ç”¨è¯¥è´¦å·: 'å¦', å¤‡æ³¨: 'ç¦»èŒ' }
            ];
            const defaultCourses = [];
            const defaultStudents = [];
            const defaultSpecials = [
                { id: 1, name: 'å¼ ä¸‰', phone: '13800138000', product_name: 'ã€Šç²¾å“ä¿éšœç­ã€‹', replace_category: 'è‹±è¯­åŸºç¡€å¿…ä¿®', original_class: '25è€ƒæœŸ1ç­', target_class: '25è€ƒæœŸ7ç­' }
            ];

            // ç¼“å­˜
            let classList = [];
            let products = [];
            let subjects = [];
            let staff = [];
            let courses = [];
            let students = [];
            let specials = [];
            let attendanceRecords = [];

            // åˆ†é¡µçŠ¶æ€
            const PAGE_SIZE = 15;
            const pagination = {
                class: 1, product: 1, subject: 1, staff: 1, special: 1, attendance: 1
            };

            let productEditMode = {};

            // åŠ è½½æ•°æ®
            async function loadAllData() {
                try {
                    const classDocs = await dbClasses.allDocs({ include_docs: true });
                    if (classDocs.rows.length === 0) {
                        for (let cls of defaultClasses) {
                            await dbClasses.put({ ...cls, _id: 'class_' + Date.now() + '_' + cls.id, order: cls.id, _ctime: Date.now() - cls.id*1000 });
                        }
                    }
                    classList = (await dbClasses.allDocs({ include_docs: true })).rows.map(r => r.doc);

                    const productDocs = await dbProducts.allDocs({ include_docs: true });
                    if (productDocs.rows.length === 0) {
                        for (let p of defaultProducts) {
                            await dbProducts.put({ ...p, _id: 'product_' + Date.now() + '_' + p.id, _ctime: Date.now() - p.id*1000 });
                        }
                    }
                    products = (await dbProducts.allDocs({ include_docs: true })).rows.map(r => r.doc);

                    const subjectDocs = await dbSubjects.allDocs({ include_docs: true });
                    if (subjectDocs.rows.length === 0) {
                        for (let s of defaultSubjects) {
                            await dbSubjects.put({ ...s, _id: 'subject_' + Date.now() + '_' + s.id, order: s.id, _ctime: Date.now() - s.id*1000 });
                        }
                    }
                    subjects = (await dbSubjects.allDocs({ include_docs: true })).rows.map(r => r.doc);
                    subjects.sort((a,b) => (a.order || a.id) - (b.order || b.id));

                    const staffDocs = await dbCourseStaff.allDocs({ include_docs: true });
                    if (staffDocs.rows.length === 0) {
                        for (let s of defaultCourseStaff) {
                            await dbCourseStaff.put({ ...s, _id: 'staff_' + Date.now() + '_' + s.id, _ctime: Date.now() - s.id*1000 });
                        }
                    }
                    staff = (await dbCourseStaff.allDocs({ include_docs: true })).rows.map(r => r.doc);

                    const specialDocs = await dbSpecials.allDocs({ include_docs: true });
                    if (specialDocs.rows.length === 0) {
                        for (let sp of defaultSpecials) {
                            await dbSpecials.put({ ...sp, _id: 'special_' + Date.now() + '_' + sp.id, _ctime: Date.now() - sp.id*1000 });
                        }
                    }
                    specials = (await dbSpecials.allDocs({ include_docs: true })).rows.map(r => r.doc);

                    courses = (await dbCourses.allDocs({ include_docs: true })).rows.map(r => r.doc);
                    students = (await dbStudents.allDocs({ include_docs: true })).rows.map(r => r.doc);
                    attendanceRecords = (await dbAttendance.allDocs({ include_docs: true })).rows.map(r => r.doc);
                } catch (e) {
                    console.error('æ•°æ®åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨å†…å­˜æ•°æ®', e);
                    // å†…å­˜åå¤‡ï¼ˆç•¥ï¼ŒåŸä»£ç å·²æœ‰ï¼‰
                }
                products.forEach(p => productEditMode[p.id] = false);
                subjects.forEach((s, idx) => { if (!s.order) s.order = s.id; });
            }

            async function saveData(db, dataArray) {
                for (let item of dataArray) {
                    try { await db.put(item); } catch (e) { }
                }
            }

            function sortByTime(arr) {
                return arr.sort((a,b) => (b._ctime || 0) - (a._ctime || 0));
            }

            // ç™»å½•
            const ADMIN_ACCOUNT = 'ç®¡ç†å‘˜';
            const ADMIN_PASSWORD = '2026';
            let currentUser = null;
            const loginOverlay = document.getElementById('loginOverlay');
            const mainApp = document.getElementById('mainApp');
            const logoutBtn = document.getElementById('logoutBtn');

            document.getElementById('adminLoginBtn').addEventListener('click', async () => {
                const account = document.getElementById('adminUser').value;
                const pwd = document.getElementById('adminPwd').value;

                // ç®¡ç†å‘˜ç¡¬ç¼–ç 
                if (account === ADMIN_ACCOUNT && pwd === ADMIN_PASSWORD) {
                    currentUser = { è´¦å·: ADMIN_ACCOUNT, æ˜¯å¦å¯ç”¨è¯¥è´¦å·: 'æ˜¯' };
                    loginOverlay.style.display = 'none';
                    mainApp.style.display = 'block';
                    await loadAllData();
                    renderAllSections();
                    return;
                }

                // æ™®é€šå‘˜å·¥éªŒè¯
                try {
                    await loadAllData();
                    const found = staff.find(s => s.è´¦å· === account && s.å¯†ç  === pwd && s.æ˜¯å¦å¯ç”¨è¯¥è´¦å· === 'æ˜¯');
                    if (found) {
                        currentUser = found;
                        loginOverlay.style.display = 'none';
                        mainApp.style.display = 'block';
                        renderAllSections();
                    } else {
                        alert('è´¦å·æˆ–å¯†ç é”™è¯¯ï¼Œæˆ–è´¦å·æœªå¯ç”¨');
                    }
                } catch (e) {
                    alert('ç™»å½•é”™è¯¯');
                }
            });

            logoutBtn.addEventListener('click', () => location.reload());

            document.querySelectorAll('.admin-tab').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.admin-tab').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    document.querySelectorAll('.admin-section').forEach(s => s.classList.remove('active'));
                    document.getElementById(e.target.dataset.tab).classList.add('active');
                    const tab = e.target.dataset.tab;
                    if (tab === 'classTab') pagination.class = 1;
                    else if (tab === 'productTab') { pagination.product = 1; pagination.subject = 1; }
                    else if (tab === 'staffTab') pagination.staff = 1;
                    else if (tab === 'specialTab') pagination.special = 1;
                    else if (tab === 'attendanceTab') pagination.attendance = 1;
                    renderAllSections();
                });
            });

            document.querySelectorAll('.product-sub-tab').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.product-sub-tab').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    const targetPanel = e.target.dataset.subtab;
                    document.querySelectorAll('.product-sub-panel').forEach(p => p.classList.remove('active'));
                    if (targetPanel === 'productList') {
                        document.getElementById('productListPanel').classList.add('active');
                        renderProductTable(); 
                    } else {
                        document.getElementById('subjectListPanel').classList.add('active');
                        renderSubjectTable();
                    }
                });
            });

            function renderAllSections() {
                renderClassTable();
                renderProductTable();
                renderSubjectTable();
                renderStaffTable();
                renderSpecialTable();
                renderAttendanceTable();
            }

            // ---------- ç­çº§ç®¡ç† ----------
            function renderClassTable() {
                const periods = [...new Set(classList.map(c => c.period))].sort();
                let html = '<table class="data-table"><thead><tr><th>è€ƒæœŸ</th><th>ç­çº§åˆ—è¡¨</th><th>æ“ä½œ</th></tr></thead><tbody>';
                periods.forEach(period => {
                    const periodNumber = period.replace('è€ƒæœŸ', '');
                    const classesInPeriod = classList.filter(c => c.period === period)
                        .sort((a, b) => {
                            const numA = parseInt(a.name.match(/\d+/)?.[0] || 0);
                            const numB = parseInt(b.name.match(/\d+/)?.[0] || 0);
                            return numA - numB;
                        });
                    const classTags = classesInPeriod.map(c => 
                        `<span class="class-tag" data-class-id="${c.id}">
                            ${c.name}
                            <i class="fas fa-times remove-icon" onclick="deleteClass(${c.id})"></i>
                        </span>`
                    ).join('');
                    html += `<tr>
                        <td><strong>${periodNumber}</strong></td>
                        <td><div class="class-tag-container">${classTags} <i class="fas fa-plus add-class-icon" onclick="addClassToPeriod('${period}')"></i></div></td>
                        <td><i class="fas fa-pen action-icon" onclick="editPeriod('${period}')"></i> <i class="fas fa-trash action-icon delete" onclick="deletePeriod('${period}')"></i></td>
                    </tr>`;
                });
                html += '</tbody></table>';
                document.getElementById('classTableContainer').innerHTML = html;
            }

            window.addClassToPeriod = async function(period) {
                const classesInPeriod = classList.filter(c => c.period === period);
                let maxNum = 0;
                classesInPeriod.forEach(c => {
                    const match = c.name.match(/(\d+)ç­/);
                    if (match) {
                        const num = parseInt(match[1], 10);
                        if (num > maxNum) maxNum = num;
                    }
                });
                const nextNum = maxNum + 1;
                const newName = `${period}${nextNum}ç­`;
                const maxId = Math.max(...classList.map(c => c.id), 0) + 1;
                const newClass = { id: maxId, name: newName, period, _id: 'class_' + Date.now() + '_' + maxId, order: maxId, _ctime: Date.now() };
                classList.push(newClass);
                await saveData(dbClasses, classList);
                renderClassTable();
            };

            window.deleteClass = async function(id) {
                if (confirm('ç¡®å®šåˆ é™¤è¯¥ç­çº§ï¼Ÿ')) {
                    classList = classList.filter(c => c.id !== id);
                    await saveData(dbClasses, classList);
                    renderClassTable();
                }
            };

            window.editPeriod = async function(period) {
                const newPeriod = prompt('ä¿®æ”¹è€ƒæœŸåç§° (ä¾‹å¦‚è¾“å…¥ 28è€ƒæœŸ)', period);
                if (newPeriod && newPeriod !== period) {
                    classList.forEach(c => { if (c.period === period) c.period = newPeriod; });
                    await saveData(dbClasses, classList);
                    renderClassTable();
                }
            };

            window.deletePeriod = async function(period) {
                if (confirm(`ç¡®å®šåˆ é™¤æ•´ä¸ªè€ƒæœŸ ${period} åŠå…¶æ‰€æœ‰ç­çº§ï¼Ÿ`)) {
                    classList = classList.filter(c => c.period !== period);
                    await saveData(dbClasses, classList);
                    renderClassTable();
                }
            };

            document.getElementById('addPeriodBtn').addEventListener('click', async () => {
                const period = prompt('è¾“å…¥æ–°è€ƒæœŸï¼ˆå¦‚ 28è€ƒæœŸï¼‰');
                if (!period) return;
                const maxId = Math.max(...classList.map(c => c.id), 0) + 1;
                const newClass = { id: maxId, name: `${period}1ç­`, period, _id: 'class_' + Date.now() + '_' + maxId, order: maxId, _ctime: Date.now() };
                classList.push(newClass);
                await saveData(dbClasses, classList);
                renderClassTable();
            });

            // ---------- äº§å“ç®¡ç† ----------
            function renderProductTable() {
                const sorted = sortByTime(products);
                const totalPages = Math.ceil(sorted.length / PAGE_SIZE) || 1;
                const page = pagination.product;
                const start = (page-1)*PAGE_SIZE;
                const pageData = sorted.slice(start, start+PAGE_SIZE);

                let html = '<table class="data-table"><thead><tr><th>äº§å“åç§°</th><th>åŒ…å«ç§‘ç›®</th><th>æ“ä½œ</th></tr></thead><tbody>';
                pageData.forEach(p => {
                    const isEditable = productEditMode[p.id] || false;
                    const editableClass = isEditable ? 'editable' : '';
                    html += `<tr data-id="${p.id}">
                        <td>${p.name}</td>
                        <td>
                            <div class="subject-checkbox-group ${editableClass}" id="product-group-${p.id}">
                                ${subjects.map(s => {
                                    const checked = p.subjectIds.includes(s.id);
                                    const checkedClass = checked ? 'checked-label' : '';
                                    return `<label class="${checkedClass}"><input type="checkbox" value="${s.id}" ${checked ? 'checked' : ''} ${isEditable ? '' : 'disabled'}> ${s.name}</label>`;
                                }).join('')}
                            </div>
                        </td>
                        <td style="white-space: nowrap;">
                            <button class="product-edit-btn ${isEditable ? 'active' : ''}" onclick="toggleProductEdit(${p.id})">
                                <i class="fas fa-${isEditable ? 'check' : 'pencil-alt'}"></i> ${isEditable ? 'å®Œæˆ' : 'ç¼–è¾‘'}
                            </button>
                            ${isEditable ? `<button class="product-edit-btn" onclick="saveProductSubjects(${p.id})" style="margin-left:5px;"><i class="fas fa-save"></i> ä¿å­˜</button>` : ''}
                        </td>
                    </tr>`;
                });
                html += '</tbody></table>';
                html += `<div class="pagination">
                    <button onclick="changePage('product', ${page-1})" ${page===1?'disabled':''}><i class="fas fa-chevron-left"></i></button>
                    <span>ç¬¬ <input type="number" value="${page}" min="1" max="${totalPages}" onchange="goToPage('product', this.value)"> é¡µ / å…± ${totalPages} é¡µ</span>
                    <button onclick="changePage('product', ${page+1})" ${page===totalPages?'disabled':''}><i class="fas fa-chevron-right"></i></button>
                </div>`;
                document.getElementById('productTableContainer').innerHTML = html;
            }

            window.toggleProductEdit = function(productId) {
                productEditMode[productId] = !productEditMode[productId];
                renderProductTable();
            };

            window.saveProductSubjects = async function(productId) {
                const prod = products.find(p => p.id === productId);
                if (!prod) return;
                const container = document.getElementById(`product-group-${productId}`);
                if (!container) return;
                const checkboxes = container.querySelectorAll('input[type=checkbox]');
                const newSubjectIds = [];
                checkboxes.forEach(cb => {
                    if (cb.checked) newSubjectIds.push(parseInt(cb.value));
                });
                prod.subjectIds = newSubjectIds;
                prod._ctime = Date.now();
                await saveData(dbProducts, products);
                productEditMode[productId] = false;
                renderProductTable();
            };

            document.getElementById('addProductBtn').addEventListener('click', async () => {
                const name = prompt('äº§å“åç§°');
                if (!name) return;
                const newId = Math.max(...products.map(p => p.id), 0) + 1;
                products.push({ id: newId, name, subjectIds: [], _id: 'product_' + Date.now() + '_' + newId, _ctime: Date.now() });
                await saveData(dbProducts, products);
                renderProductTable();
            });

            // ---------- ç§‘ç›®åº“ (åºå·æ’åº) ----------
            function renderSubjectTable() {
                // æŒ‰orderæ’åº
                const sorted = [...subjects].sort((a,b) => (a.order || a.id) - (b.order || b.id));
                const totalPages = Math.ceil(sorted.length / PAGE_SIZE) || 1;
                const page = pagination.subject;
                const start = (page-1)*PAGE_SIZE;
                const pageData = sorted.slice(start, start+PAGE_SIZE);

                let html = '<table class="data-table"><thead><tr><th>åºå·</th><th>ç§‘ç›®åç§°</th><th>æ“ä½œ</th></tr></thead><tbody id="subject-tbody">';
                pageData.forEach(s => {
                    html += `<tr data-id="${s.id}">
                        <td class="order-cell" onclick="editSubjectOrder(${s.id}, ${s.order || s.id})">${s.order || s.id}</td>
                        <td class="editable-cell" onclick="editSubject(${s.id})">${s.name}</td>
                        <td>
                            <div class="subject-actions">
                                <i class="fas fa-trash action-icon delete" onclick="deleteSubject(${s.id})"></i>
                            </div>
                        </td>
                    </tr>`;
                });
                html += '</tbody></table>';
                html += `<div class="pagination">
                    <button onclick="changePage('subject', ${page-1})" ${page===1?'disabled':''}><i class="fas fa-chevron-left"></i></button>
                    <span>ç¬¬ <input type="number" value="${page}" min="1" max="${totalPages}" onchange="goToPage('subject', this.value)"> é¡µ / å…± ${totalPages} é¡µ</span>
                    <button onclick="changePage('subject', ${page+1})" ${page===totalPages?'disabled':''}><i class="fas fa-chevron-right"></i></button>
                </div>`;
                document.getElementById('subjectTableContainer').innerHTML = html;
            }

            // ç¼–è¾‘åºå·
            window.editSubjectOrder = async function(id, currentOrder) {
                const newOrder = prompt('è¾“å…¥æ–°çš„åºå· (æ•°å­—è¶Šå°è¶Šé å‰)', currentOrder);
                if (newOrder === null) return;
                
                const orderNum = parseInt(newOrder);
                if (isNaN(orderNum) || orderNum < 1) {
                    alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æ­£æ•´æ•°');
                    return;
                }

                const subject = subjects.find(s => s.id === id);
                if (!subject) return;

                // æ›´æ–°å½“å‰ç§‘ç›®çš„åºå·
                subject.order = orderNum;
                subject._ctime = Date.now();

                // é‡æ–°æ’åºæ‰€æœ‰ç§‘ç›®ï¼ˆå¤„ç†åºå·å†²çªï¼šå¦‚æœåºå·é‡å¤ï¼Œåˆ™é‡æ–°åˆ†é…è¿ç»­åºå·ï¼‰
                subjects.sort((a,b) => (a.order || a.id) - (b.order || b.id));
                
                // å¯é€‰ï¼šé‡æ–°åˆ†é…è¿ç»­åºå·ä½¿æ›´æ•´æ´ï¼Œä½†éå¿…é¡»ï¼Œä¿ç•™ç”¨æˆ·è¾“å…¥
                // ä½†ä¸ºé˜²æ­¢æ˜¾ç¤ºæ··ä¹±ï¼Œæˆ‘ä»¬æŒ‰orderæ’åºåé‡æ–°èµ‹äºˆ1..Nçš„åºå·
                subjects.forEach((s, index) => {
                    s.order = index + 1;
                });

                await saveData(dbSubjects, subjects);
                
                // é‡æ–°æ¸²æŸ“ç§‘ç›®è¡¨å’Œäº§å“è¡¨
                renderSubjectTable();
                renderProductTable(); // äº§å“è¡¨çš„ç§‘ç›®é¡ºåºä¼šæŒ‰ç…§æ–°çš„orderæ˜¾ç¤º
            };

            window.editSubject = async function(id) {
                const sub = subjects.find(s => s.id === id);
                const newName = prompt('ä¿®æ”¹ç§‘ç›®åç§°', sub.name);
                if (newName && newName !== sub.name) {
                    sub.name = newName;
                    sub._ctime = Date.now();
                    await saveData(dbSubjects, subjects);
                    renderSubjectTable();
                    renderProductTable();
                }
            };

            window.deleteSubject = async function(id) {
                if (confirm('ç¡®å®šåˆ é™¤è¯¥ç§‘ç›®ï¼Ÿ')) {
                    subjects = subjects.filter(s => s.id !== id);
                    // é‡æ–°æ’åº
                    subjects.sort((a,b) => (a.order || a.id) - (b.order || b.id));
                    subjects.forEach((s, index) => {
                        s.order = index + 1;
                    });
                    
                    products.forEach(p => { p.subjectIds = p.subjectIds.filter(sid => sid !== id); });
                    
                    await saveData(dbSubjects, subjects);
                    await saveData(dbProducts, products);
                    
                    renderSubjectTable();
                    renderProductTable();
                }
            };

            document.getElementById('addSubjectBtn').addEventListener('click', async () => {
                const name = prompt('ç§‘ç›®åç§°');
                if (!name) return;
                
                const newId = Math.max(...subjects.map(s => s.id), 0) + 1;
                // æ–°ç§‘ç›®æ”¾åœ¨æœ€åï¼Œorderå–å½“å‰æœ€å¤§order+1
                const maxOrder = Math.max(...subjects.map(s => s.order || s.id), 0);
                
                subjects.push({ id: newId, name, order: maxOrder + 1, _id: 'subject_' + Date.now() + '_' + newId, _ctime: Date.now() });
                
                await saveData(dbSubjects, subjects);
                renderSubjectTable();
                renderProductTable();
            });

            // ---------- èŒå‘˜ç®¡ç† (å¢åŠ é‚®ç®±å­—æ®µ) ----------
            function renderStaffTable() {
                const sorted = sortByTime(staff);
                const totalPages = Math.ceil(sorted.length / PAGE_SIZE) || 1;
                const page = pagination.staff;
                const start = (page-1)*PAGE_SIZE;
                const pageData = sorted.slice(start, start+PAGE_SIZE);

                let html = '<table class="data-table"><thead><tr><th>è´¦å·</th><th>å¯†ç </th><th>é‚®ç®±</th><th>æ˜¯å¦å¯ç”¨</th><th>å¤‡æ³¨</th><th>æ“ä½œ</th></tr></thead><tbody>';
                pageData.forEach(s => {
                    html += `<tr data-id="${s.id}">
                        <td class="editable-cell" onclick="editStaffField(${s.id}, 'è´¦å·')">${s.è´¦å·}</td>
                        <td class="editable-cell" onclick="editStaffField(${s.id}, 'å¯†ç ')">${s.å¯†ç }</td>
                        <td class="editable-cell" onclick="editStaffField(${s.id}, 'é‚®ç®±')">${s.é‚®ç®± || ''}</td>
                        <td>
                            <select onchange="updateStaffStatus(${s.id}, this.value)" style="border-radius:20px; padding:4px;">
                                <option value="æ˜¯" ${s.æ˜¯å¦å¯ç”¨è¯¥è´¦å·==='æ˜¯'?'selected':''}>æ˜¯</option>
                                <option value="å¦" ${s.æ˜¯å¦å¯ç”¨è¯¥è´¦å·==='å¦'?'selected':''}>å¦</option>
                            </select>
                        </td>
                        <td class="editable-cell" onclick="editStaffField(${s.id}, 'å¤‡æ³¨')">${s.å¤‡æ³¨ || ''}</td>
                        <td><i class="fas fa-trash action-icon delete" onclick="deleteStaff(${s.id})"></i></td>
                    </tr>`;
                });
                html += '</tbody></table>';
                html += `<div class="pagination">
                    <button onclick="changePage('staff', ${page-1})" ${page===1?'disabled':''}><i class="fas fa-chevron-left"></i></button>
                    <span>ç¬¬ <input type="number" value="${page}" min="1" max="${totalPages}" onchange="goToPage('staff', this.value)"> é¡µ / å…± ${totalPages} é¡µ</span>
                    <button onclick="changePage('staff', ${page+1})" ${page===totalPages?'disabled':''}><i class="fas fa-chevron-right"></i></button>
                </div>`;
                document.getElementById('staffTableContainer').innerHTML = html;
            }

            window.editStaffField = async function(id, field) {
                const s = staff.find(s => s.id === id);
                const fieldMap = { 'è´¦å·': 'è´¦å·', 'å¯†ç ': 'å¯†ç ', 'é‚®ç®±': 'é‚®ç®±', 'å¤‡æ³¨': 'å¤‡æ³¨' };
                const key = fieldMap[field];
                const newVal = prompt(`ä¿®æ”¹${field}`, s[key]);
                if (newVal !== null && newVal !== s[key]) {
                    s[key] = newVal;
                    s._ctime = Date.now();
                    await saveData(dbCourseStaff, staff);
                    renderStaffTable();
                }
            };

            window.updateStaffStatus = async function(id, value) {
                const s = staff.find(s => s.id === id);
                s.æ˜¯å¦å¯ç”¨è¯¥è´¦å· = value;
                s._ctime = Date.now();
                await saveData(dbCourseStaff, staff);
                renderStaffTable();
            };

            window.deleteStaff = async function(id) {
                if (confirm('ç¡®å®šåˆ é™¤è¯¥èŒå‘˜ï¼Ÿ')) {
                    staff = staff.filter(s => s.id !== id);
                    await saveData(dbCourseStaff, staff);
                    renderStaffTable();
                }
            };

            document.getElementById('addStaffBtn').addEventListener('click', async () => {
                const account = prompt('è´¦å·');
                if (!account) return;
                const pwd = prompt('å¯†ç ', '2025');
                const email = prompt('é‚®ç®±', '');
                const status = prompt('æ˜¯å¦å¯ç”¨ï¼ˆæ˜¯/å¦ï¼‰', 'æ˜¯');
                const remark = prompt('å¤‡æ³¨', '');
                const newId = Math.max(...staff.map(s => s.id), 0) + 1;
                staff.push({ id: newId, è´¦å·: account, å¯†ç : pwd, é‚®ç®±: email, æ˜¯å¦å¯ç”¨è¯¥è´¦å·: status, å¤‡æ³¨: remark, _id: 'staff_' + Date.now() + '_' + newId, _ctime: Date.now() });
                await saveData(dbCourseStaff, staff);
                renderStaffTable();
            });

            // ---------- ç‰¹æ®Šæ›´æ¢ ----------
            function renderSpecialTable() {
                const sorted = sortByTime(specials);
                const totalPages = Math.ceil(sorted.length / PAGE_SIZE) || 1;
                const page = pagination.special;
                const start = (page-1)*PAGE_SIZE;
                const pageData = sorted.slice(start, start+PAGE_SIZE);

                let html = '<table class="data-table"><thead><tr><th>å­¦å‘˜å§“å</th><th>æ‰‹æœºå·</th><th>äº§å“</th><th>æ›´æ¢ç§‘ç›®</th><th>åŸç­çº§</th><th>ç›®æ ‡ç­çº§</th><th>æ“ä½œ</th></tr></thead><tbody>';
                pageData.forEach(sp => {
                    html += `<tr data-id="${sp.id}">
                        <td class="editable-cell" onclick="editSpecialField(${sp.id}, 'name')">${sp.name}</td>
                        <td class="editable-cell" onclick="editSpecialField(${sp.id}, 'phone')">${sp.phone}</td>
                        <td class="editable-cell" onclick="editSpecialField(${sp.id}, 'product_name')">${sp.product_name || ''}</td>
                        <td class="editable-cell" onclick="editSpecialField(${sp.id}, 'replace_category')">${sp.replace_category}</td>
                        <td class="editable-cell" onclick="editSpecialField(${sp.id}, 'original_class')">${sp.original_class}</td>
                        <td class="editable-cell" onclick="editSpecialField(${sp.id}, 'target_class')">${sp.target_class}</td>
                        <td><i class="fas fa-trash action-icon delete" onclick="deleteSpecial(${sp.id})"></i></td>
                    </tr>`;
                });
                html += '</tbody></table>';
                html += `<div class="pagination">
                    <button onclick="changePage('special', ${page-1})" ${page===1?'disabled':''}><i class="fas fa-chevron-left"></i></button>
                    <span>ç¬¬ <input type="number" value="${page}" min="1" max="${totalPages}" onchange="goToPage('special', this.value)"> é¡µ / å…± ${totalPages} é¡µ</span>
                    <button onclick="changePage('special', ${page+1})" ${page===totalPages?'disabled':''}><i class="fas fa-chevron-right"></i></button>
                </div>`;
                document.getElementById('specialTableContainer').innerHTML = html;
            }

            window.editSpecialField = async function(id, field) {
                const sp = specials.find(s => s.id === id);
                const fieldMap = { 'name':'å§“å', 'phone':'æ‰‹æœºå·', 'product_name':'äº§å“', 'replace_category':'æ›´æ¢ç§‘ç›®', 'original_class':'åŸç­çº§', 'target_class':'ç›®æ ‡ç­çº§' };
                const newVal = prompt(`ä¿®æ”¹${fieldMap[field]}`, sp[field]);
                if (newVal !== null && newVal !== sp[field]) {
                    sp[field] = newVal;
                    sp._ctime = Date.now();
                    await saveData(dbSpecials, specials);
                    renderSpecialTable();
                }
            };

            window.deleteSpecial = async function(id) {
                if (confirm('ç¡®å®šåˆ é™¤è¯¥è®°å½•ï¼Ÿ')) {
                    specials = specials.filter(s => s.id !== id);
                    await saveData(dbSpecials, specials);
                    renderSpecialTable();
                }
            };

            document.getElementById('addSpecialBtn').addEventListener('click', async () => {
                const name = prompt('å­¦å‘˜å§“å');
                if (!name) return;
                const phone = prompt('æ‰‹æœºå·');
                const product = prompt('äº§å“');
                const cat = prompt('æ›´æ¢ç§‘ç›®');
                const orig = prompt('åŸç­çº§');
                const target = prompt('ç›®æ ‡ç­çº§');
                const newId = Math.max(...specials.map(s => s.id), 0) + 1;
                specials.push({ id: newId, name, phone, product_name: product, replace_category: cat, original_class: orig, target_class: target, _id: 'special_' + Date.now() + '_' + newId, _ctime: Date.now() });
                await saveData(dbSpecials, specials);
                renderSpecialTable();
            });

            // ---------- å‡ºå‹¤å¤§è¡¨ ----------
            function renderAttendanceTable() {
                const sorted = sortByTime(attendanceRecords);
                const totalPages = Math.ceil(sorted.length / PAGE_SIZE) || 1;
                const page = pagination.attendance;
                const start = (page-1)*PAGE_SIZE;
                const pageData = sorted.slice(start, start+PAGE_SIZE);

                let html = '<table class="data-table"><thead><tr><th>å­¦å‘˜</th><th>è¯¾ç¨‹</th><th>æ—¥æœŸ</th><th>å®åˆ°æ—¶é•¿</th></tr></thead><tbody>';
                pageData.forEach(rec => {
                    const user = students.find(u => u.id === rec.userId);
                    const course = courses.find(c => c.id === rec.courseId);
                    if (user && course) {
                        html += `<tr><td>${user.name}</td><td>${course.subject_name}</td><td>${course.course_date}</td><td>${rec.actualHours}h</td></tr>`;
                    }
                });
                html += '</tbody></table>';
                html += `<div class="pagination">
                    <button onclick="changePage('attendance', ${page-1})" ${page===1?'disabled':''}><i class="fas fa-chevron-left"></i></button>
                    <span>ç¬¬ <input type="number" value="${page}" min="1" max="${totalPages}" onchange="goToPage('attendance', this.value)"> é¡µ / å…± ${totalPages} é¡µ</span>
                    <button onclick="changePage('attendance', ${page+1})" ${page===totalPages?'disabled':''}><i class="fas fa-chevron-right"></i></button>
                </div>`;
                document.getElementById('attendanceTableContainer').innerHTML = html;
            }

            window.changePage = function(type, newPage) {
                if (newPage < 1) return;
                pagination[type] = newPage;
                if (type === 'product') renderProductTable();
                else if (type === 'subject') renderSubjectTable();
                else if (type === 'staff') renderStaffTable();
                else if (type === 'special') renderSpecialTable();
                else if (type === 'attendance') renderAttendanceTable();
            };

            window.goToPage = function(type, pageVal) {
                let page = parseInt(pageVal);
                if (isNaN(page) || page < 1) page = 1;
                pagination[type] = page;
                if (type === 'product') renderProductTable();
                else if (type === 'subject') renderSubjectTable();
                else if (type === 'staff') renderStaffTable();
                else if (type === 'special') renderSpecialTable();
                else if (type === 'attendance') renderAttendanceTable();
            };

            document.getElementById('exportBtn').addEventListener('click', () => {
                const data = courses.map(c => Object.values(c).join(',')).join('\n');
                const blob = new Blob([data], {type: 'text/csv'});
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = 'courses.csv';
                a.click();
            });
            document.getElementById('importBtn').addEventListener('click', () => {
                document.getElementById('importFile').click();
            });
            document.getElementById('importFile').addEventListener('change', (e) => {
                alert('å¯¼å…¥æ¼”ç¤ºï¼šå®é™…åº”è§£æåˆå¹¶ï¼Œç°åœ¨é‡è½½æ•°æ®');
                location.reload();
            });
        })();
    </script>
</body>
</html>